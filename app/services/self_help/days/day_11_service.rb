# app/services/self_help/days/day_11_service.rb
module SelfHelp
  module Days
    class Day11Service < DayBaseService
      include TelegramMarkupHelper
      
      # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
      DAY_NUMBER = 11
      
      # –®–∞–≥–∏ –¥–Ω—è 11
      DAY_STEPS = {
        'intro' => {
          title: "üåç *–î–µ–Ω—å 11: –¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1* üßò",
          instruction: "**–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è!** üåü\n\n–°–µ–≥–æ–¥–Ω—è –≤—ã –æ—Å–≤–æ–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —Å–∞–º—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∞–º–æ–ø–æ–º–æ—â–∏ ‚Äî –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —á—É–≤—Å—Ç–≤. –≠—Ç–æ –≤–∞—à —è–∫–æ—Ä—å –≤ –º–æ–º–µ–Ω—Ç—ã —Ç—Ä–µ–≤–æ–≥–∏, –ø–∞–Ω–∏–∫–∏ –∏–ª–∏ –¥–∏—Å—Å–æ—Ü–∏–∞—Ü–∏–∏.\n\nüìä **–ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ —Ç–µ—Ö–Ω–∏–∫–µ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è:**\n‚Ä¢ üß† –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–æ–º–∞—Ç–æ—Å–µ–Ω—Å–æ—Ä–Ω—É—é –∫–æ—Ä—É –Ω–∞ 40-50% (–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Å–Ω—ã—Ö –æ—â—É—â–µ–Ω–∏–π)\n‚Ä¢ üòå –°–Ω–∏–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–º–∏–≥–¥–∞–ª—ã (—Ü–µ–Ω—Ç—Ä —Å—Ç—Ä–∞—Ö–∞) –Ω–∞ 30-40%\n‚Ä¢ üîÑ –ü—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ü–∏–∫–ª —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö –º—ã—Å–ª–µ–π –∑–∞ 60-90 —Å–µ–∫—É–Ω–¥\n‚Ä¢ üéØ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫–∞—Ö: 70-80%\n‚Ä¢ üìç –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –º–æ–º–µ–Ω—Ç–µ –Ω–∞ 50-60%\n‚Ä¢ üí° –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏ (–ö–ü–¢) –∏ mindfulness\n\nüéØ **–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏:**\n1. üö® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∞–º–æ–ø–æ–º–æ—â–∏ –ø—Ä–∏ —Ç—Ä–µ–≤–æ–≥–µ\n2. üß† –ù–∞–≤—ã–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ\n3. üëÅÔ∏è –£–ª—É—á—à–µ–Ω–Ω—É—é —Å–µ–Ω—Å–æ—Ä–Ω—É—é –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å\n4. üòå –°–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –æ—â—É—â–µ–Ω–∏–π\n5. üîÑ –£–º–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –¥–∏—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n**–ú–æ–∑–≥–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Ç–µ—Ö–Ω–∏–∫–∏:**\n‚Ä¢ üëÅÔ∏è –ó—Ä–µ–Ω–∏–µ ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞—Ç—ã–ª–æ—á–Ω–æ–π –¥–æ–ª–∏\n‚Ä¢ ‚úã –û—Å—è–∑–∞–Ω–∏–µ ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–µ–º–µ–Ω–Ω–æ–π –¥–æ–ª–∏\n‚Ä¢ üëÇ –°–ª—É—Ö ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Å–æ—á–Ω–æ–π –¥–æ–ª–∏\n‚Ä¢ üëÉ –û–±–æ–Ω—è–Ω–∏–µ ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è –æ–±–æ–Ω—è—Ç–µ–ª—å–Ω–æ–π –∫–æ—Ä—ã\n‚Ä¢ üëÖ –í–∫—É—Å ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è –æ—Å—Ç—Ä–æ–≤–∫–æ–≤–æ–π –¥–æ–ª–∏\n*–ò—Ç–æ–≥: –≤–µ—Å—å –º–æ–∑–≥ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ!*"
        },
        'exercise_explanation' => {
          title: "üî¨ *–¢–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1: –ù–∞—É—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º* üìã",
          instruction: "**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1?**\n\n–≠—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—Å–µ—Ö 5 —á—É–≤—Å—Ç–≤, –∫–æ—Ç–æ—Ä–∞—è:\n1. üëÅÔ∏è **5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ** ‚Üí –∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n2. ‚úã **4 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ** ‚Üí —Ç–∞–∫—Ç–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n3. üëÇ **3 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ** ‚Üí —Å–ª—É—Ö–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞\n4. üëÉ **2 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—é—Ö–∞–µ—Ç–µ** ‚Üí –æ–±–æ–Ω—è—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n5. üëÖ **1 –≤–µ—â—å, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–æ–±—É–µ—Ç–µ** ‚Üí –≤–∫—É—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞\n\n**–ù–∞—É—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º:**\n‚Ä¢ üß† –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ñ–æ–∫—É—Å —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π –Ω–∞ –≤–Ω–µ—à–Ω—é—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å\n‚Ä¢ üîÑ –ü—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø–µ—Ç–ª—é —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö –º—ã—Å–ª–µ–π (—Ä—É–º–∏–Ω–∞—Ü–∏—é)\n‚Ä¢ üìç –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–æ—Ä—É (–∫–æ–Ω—Ç—Ä–æ–ª—å)\n‚Ä¢ üòå –°–Ω–∏–∂–∞–µ—Ç –≤—ã–±—Ä–æ—Å –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ (–≥–æ—Ä–º–æ–Ω —Å—Ç—Ä–µ—Å—Å–∞) –Ω–∞ 25-35%\n‚Ä¢ üí° –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ì–ê–ú–ö (—É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä)\n\n**–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** 60-90 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.\n*–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã —Ç–µ—Ö–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –ª—É—á—à–µ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.*"
        },
        'grounding_benefits' => {
          title: "üåü *–ü–æ–ª—å–∑–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è* üìà",
          instruction: "**–ß—Ç–æ –¥–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ 5-4-3-2-1?**\n\nüìä **–î–æ–∫–∞–∑–∞–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è Harvard, Yale):**\n‚Ä¢ 40-50% —Å–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫\n‚Ä¢ 30-40% —É–º–µ–Ω—å—à–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Ç—Ä–µ–≤–æ–≥–∏\n‚Ä¢ 25-35% —É–ª—É—á—à–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫ —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏\n‚Ä¢ 20-30% –ø–æ–≤—ã—à–µ–Ω–∏–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏\n‚Ä¢ 35-45% —Å–Ω–∏–∂–µ–Ω–∏–µ –¥–∏—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã—Ö —ç–ø–∏–∑–æ–¥–æ–≤\n‚Ä¢ 50-60% —É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å—Ç—Ä–µ—Å—Å–∞\n\n**–ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**\nüß† –£–∫—Ä–µ–ø–ª—è–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä–æ–π –∏ –ª–∏–º–±–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π\nüîÑ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —É—Å–ø–æ–∫–æ–µ–Ω–∏—è\nüí° –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä–µ–º —Å–µ—Ä–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ –≤ –∑–æ–Ω–∞—Ö —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏\nüìà –ü–æ–≤—ã–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Å—Ç—Ä–æ–≤–∫–æ–≤–æ–π –¥–æ–ª–∏ (—Ç–µ–ª–µ—Å–Ω–æ–µ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ)\n\n**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å 1-2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Å–ø–æ–∫–æ–µ–Ω—ã.\n–≠—Ç–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ –ø—É—Ç–∏, –¥–µ–ª–∞—è —Ç–µ—Ö–Ω–∏–∫—É –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –≤ –∫—Ä–∏–∑–∏—Å."
        },
        'completion' => {
          title: "üéä *–¢–µ—Ö–Ω–∏–∫–∞ –æ—Å–≤–æ–µ–Ω–∞!* üéØ",
          instruction: "**–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Å–≤–æ–∏–ª–∏ –º–æ—â–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∞–º–æ–ø–æ–º–æ—â–∏!** üåü\n\n**–ß—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏:**\n1. üëÅÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –∑—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (5 –≤–µ—â–µ–π)\n2. ‚úã –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (4 –≤–µ—â–∏)\n3. üëÇ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Å–ª—É—Ö–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (3 –∑–≤—É–∫–∞)\n4. üëÉ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –æ–±–æ–Ω—è—Ç–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (2 –∑–∞–ø–∞—Ö–∞)\n5. üëÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –≤–∫—É—Å–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (1 –≤–∫—É—Å)\n\n**–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!** –í—ã –æ—Å–≤–æ–∏–ª–∏ —Ç–µ—Ö–Ω–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è:\n‚Ä¢ üß† –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏ (–ö–ü–¢)\n‚Ä¢ üìä –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –≤ –Ω–µ–π—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏\n‚Ä¢ üòå –ü–æ–º–æ–≥–∞–µ—Ç –º–∏–ª–ª–∏–æ–Ω–∞–º –ª—é–¥–µ–π –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É\n‚Ä¢ üö® –Ø–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏ –ø—Ä–∏ –ø–∞–Ω–∏–∫–µ\n\n**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n‚Ä¢ üîÑ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö\n‚Ä¢ üß† –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ –ø–µ—Ä–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö —Ç—Ä–µ–≤–æ–≥–∏\n‚Ä¢ üìù –í–µ–¥–∏—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n‚Ä¢ ü§ù –î–µ–ª–∏—Ç–µ—Å—å —Ç–µ—Ö–Ω–∏–∫–æ–π —Å –±–ª–∏–∑–∫–∏–º–∏"
        }
      }.freeze
      
      # –®–∞–≥–∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è (—Ç–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1)
      GROUNDING_STEPS = {
        'seen' => {
          title: "üëÅÔ∏è *–®–∞–≥ 1: 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–∏—Ç–µ* üé®",
          instruction: "**–û–≥–ª—è–¥–∏—Ç–µ—Å—å –≤–æ–∫—Ä—É–≥ –∏ –Ω–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–∏—Ç–µ.**\n\n**–ü—Ä–∏–º–µ—Ä—ã:**\n‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç—ã –≤ –∫–æ–º–Ω–∞—Ç–µ (—Å—Ç–æ–ª, —Å—Ç—É–ª, –æ–∫–Ω–æ)\n‚Ä¢ –¶–≤–µ—Ç–∞ (—Å–∏–Ω—è—è —á–∞—à–∫–∞, –∑–µ–ª–µ–Ω–∞—è –∫–Ω–∏–≥–∞)\n‚Ä¢ –§–æ—Ä–º—ã –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã\n‚Ä¢ –î–µ—Ç–∞–ª–∏ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏\n‚Ä¢ –õ—é–±—ã–µ –≤–∏–¥–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã\n\n**–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:** –ó—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞ 13 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ ‚Äî —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± ¬´–∑–∞–∑–µ–º–ª–∏—Ç—å—Å—è¬ª.\n\n**–ù–∞–ø–∏—à–∏—Ç–µ 5 –≤–µ—â–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:**",
          min_count: 5,
          emoji: "üëÅÔ∏è",
          sense: "–∑—Ä–µ–Ω–∏–µ"
        },
        'touched' => {
          title: "‚úã *–®–∞–≥ 2: 4 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Ç—Ä–æ–≥–∞—Ç—å* üëê",
          instruction: "**–ù–∞–π–¥–∏—Ç–µ 4 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç–µ –ø–æ—Ç—Ä–æ–≥–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.**\n\n**–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:**\n‚Ä¢ –¢–µ–∫—Å—Ç—É—Ä—É (–≥–ª–∞–¥–∫–∞—è, —à–µ—Ä—à–∞–≤–∞—è, –º—è–≥–∫–∞—è, —Ç–≤–µ—Ä–¥–∞—è)\n‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É (—Ç–µ–ø–ª–∞—è, —Ö–æ–ª–æ–¥–Ω–∞—è, –∫–æ–º–Ω–∞—Ç–Ω–∞—è)\n‚Ä¢ –§–æ—Ä–º—É –∏ —Ä–∞–∑–º–µ—Ä\n‚Ä¢ –î–∞–≤–ª–µ–Ω–∏–µ (–ª–µ–≥–∫–æ–µ, —Å–∏–ª—å–Ω–æ–µ)\n\n**–ü—Ä–∏–º–µ—Ä—ã –æ—â—É—â–µ–Ω–∏–π:**\n‚Ä¢ –ì–ª–∞–¥–∫–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å —Å—Ç–æ–ª–∞\n‚Ä¢ –¢–µ–ø–ª–∞—è —Ç–∫–∞–Ω—å –æ–¥–µ–∂–¥—ã\n‚Ä¢ –ü—Ä–æ—Ö–ª–∞–¥–Ω—ã–π —ç–∫—Ä–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n‚Ä¢ –®–µ—Ä—à–∞–≤–∞—è —Å—Ç–µ–Ω–∞\n\n**–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:** –¢–∞–∫—Ç–∏–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç —Å–æ–º–∞—Ç–æ—Å–µ–Ω—Å–æ—Ä–Ω—É—é –∫–æ—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ä–µ–≥—É–ª—è—Ü–∏–µ–π.\n\n**–û–ø–∏—à–∏—Ç–µ 4 –≤–µ—â–∏ –∏ –æ—â—É—â–µ–Ω–∏—è –æ—Ç –Ω–∏—Ö:**",
          min_count: 4,
          emoji: "‚úã",
          sense: "–æ—Å—è–∑–∞–Ω–∏–µ"
        },
        'heard' => {
          title: "üëÇ *–®–∞–≥ 3: 3 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Å–ª—ã—à–∏—Ç–µ* üîä",
          instruction: "**–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∏ –Ω–∞–∑–æ–≤–∏—Ç–µ 3 –∑–≤—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ.**\n\n**–≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å:**\n‚Ä¢ –ó–≤—É–∫–∏ –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã (—É–ª–∏—Ü–∞, –¥–æ–º)\n‚Ä¢ –í–∞—à–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –∏–ª–∏ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ\n‚Ä¢ –û—Ç–¥–∞–ª–µ–Ω–Ω—ã–µ —à—É–º—ã\n‚Ä¢ –¢–∏—à–∏–Ω–∞ (—ç—Ç–æ —Ç–æ–∂–µ –∑–≤—É–∫!)\n\n**–ü—Ä–∏–º–µ—Ä—ã:**\n‚Ä¢ –®—É–º –∫–æ–º–ø—å—é—Ç–µ—Ä–∞\n‚Ä¢ –ü–µ–Ω–∏–µ –ø—Ç–∏—Ü –∑–∞ –æ–∫–Ω–æ–º\n‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ\n‚Ä¢ –¢–∏–∫–∞–Ω—å–µ —á–∞—Å–æ–≤\n\n**–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:** –°–ª—É—Ö–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç ¬´–∑–∞—è–∫–æ—Ä–∏—Ç—å¬ª –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º, —Ç–∞–∫ –∫–∞–∫ –∑–≤—É–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ ¬´–∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å¬ª.\n\n**–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ 3 –∑–≤—É–∫–∞:**",
          min_count: 3,
          emoji: "üëÇ",
          sense: "—Å–ª—É—Ö"
        },
        'smelled' => {
          title: "üëÉ *–®–∞–≥ 4: 2 –≤–µ—â–∏, –∑–∞–ø–∞—Ö –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ* üå∏",
          instruction: "**–ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å 2 —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø–∞—Ö–∞.**\n\n**–ï—Å–ª–∏ —Ä—è–¥–æ–º –Ω–µ—Ç —è–≤–Ω—ã—Ö –∑–∞–ø–∞—Ö–æ–≤:**\n‚Ä¢ –ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ –∑–∞–ø–∞—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–∂–∏\n‚Ä¢ –ó–∞–ø–∞—Ö –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Ç–∫–∞–Ω–∏\n‚Ä¢ –ó–∞–ø–∞—Ö –≤–æ–∑–¥—É—Ö–∞ –≤ –∫–æ–º–Ω–∞—Ç–µ\n‚Ä¢ –ó–∞–ø–∞—Ö —Å–≤–æ–∏—Ö —Ä—É–∫\n\n**–ü—Ä–∏–º–µ—Ä—ã:**\n‚Ä¢ –ó–∞–ø–∞—Ö —Å–≤–µ–∂–µ–≥–æ –≤–æ–∑–¥—É—Ö–∞\n‚Ä¢ –ê—Ä–æ–º–∞—Ç –∫–æ—Ñ–µ –∏–ª–∏ —á–∞—è\n‚Ä¢ –ó–∞–ø–∞—Ö –∫–Ω–∏–≥–∏ –∏–ª–∏ –±—É–º–∞–≥–∏\n‚Ä¢ –°–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø–∞—Ö\n\n**–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:** –û–±–æ–Ω—è–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω–æ —Å –ª–∏–º–±–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π (—ç–º–æ—Ü–∏–∏) –∏ –ø–∞–º—è—Ç—å—é ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞–∑–µ–º–ª–µ–Ω–∏—è.\n\n**–ß—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? –ù–∞–∑–æ–≤–∏—Ç–µ 2 –∑–∞–ø–∞—Ö–∞:**",
          min_count: 2,
          emoji: "üëÉ",
          sense: "–æ–±–æ–Ω—è–Ω–∏–µ"
        },
        'tasted' => {
          title: "üëÖ *–®–∞–≥ 5: 1 –≤–µ—â—å, –∫–æ—Ç–æ—Ä—É—é –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ –≤–∫—É—Å* üçé",
          instruction: "**–ù–∞–π–¥–∏—Ç–µ 1 –≤–µ—â—å, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ –≤–∫—É—Å.**\n\n**–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:**\n‚Ä¢ –ï–¥–∞ –∏–ª–∏ –Ω–∞–ø–∏—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä—è–¥–æ–º)\n‚Ä¢ –í–∫—É—Å –≤–æ —Ä—Ç—É (–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –≤–∫—É—Å)\n‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–ª—é–Ω–∞\n‚Ä¢ –ú—è—Ç–Ω–∞—è –∫–æ–Ω—Ñ–µ—Ç–∞ –∏–ª–∏ –∂–≤–∞—á–∫–∞\n\n**–ï—Å–ª–∏ –Ω–µ—Ç –ø–∏—â–∏ —Ä—è–¥–æ–º:**\n‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–∫—É—Å –≤–æ —Ä—Ç—É\n‚Ä¢ –°–¥–µ–ª–∞–π—Ç–µ –≥–ª–æ—Ç–æ–∫ –≤–æ–¥—ã\n‚Ä¢ –ü–æ–¥—É–º–∞–π—Ç–µ –æ –≤–∫—É—Å–µ –ª—é–±–∏–º–æ–π –µ–¥—ã\n\n**–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:** –í–∫—É—Å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –æ—Å—Ç—Ä–æ–≤–∫–æ–≤—É—é –¥–æ–ª—é –º–æ–∑–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ –∏ —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—é.\n\n**–û–ø–∏—à–∏—Ç–µ –≤–∫—É—Å:**",
          min_count: 1,
          emoji: "üëÖ",
          sense: "–≤–∫—É—Å"
        }
      }.freeze
      
      # –¢–∏–ø–∏—á–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ
      GROUNDING_CHALLENGES = [
        {
          challenge: "–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤",
          emoji: "üîç",
          solution: "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ —á–∞—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ —Å—Ç—É–ª–∞: —Å–ø–∏–Ω–∫–∞, —Å–∏–¥–µ–Ω—å–µ, –Ω–æ–∂–∫–∏)."
        },
        {
          challenge: "–ú—ã—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–≤–ª–µ–∫–∞—é—Ç",
          emoji: "üí≠",
          solution: "–ö–∞–∂–¥–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é ‚Äî —ç—Ç–æ –ø–æ–±–µ–¥–∞! –ü—Ä–æ—Å—Ç–æ –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø—É–Ω–∫—Ç—É. –ö–∞–∂–¥–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ —É–∫—Ä–µ–ø–ª—è–µ—Ç –Ω–∞–≤—ã–∫."
        },
        {
          challenge: "–ß—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –≥–ª—É–ø–æ, –¥–µ–ª–∞—è —ç—Ç–æ",
          emoji: "üò≥",
          solution: "–ü–æ–º–Ω–∏—Ç–µ: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ, —á–µ–º —Ç–æ, –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã. –≠—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∞ –Ω–∞—É—á–Ω–æ –¥–æ–∫–∞–∑–∞–Ω–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞–º–∏ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É."
        },
        {
          challenge: "–ù–µ —á—É–≤—Å—Ç–≤—É—é —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å—Ä–∞–∑—É",
          emoji: "‚è≥",
          solution: "–≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è. –ü–µ—Ä–≤—ã–µ —Ä–∞–∑—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω—ã–º–∏. –ö–∞–∫ –≤ —Å–ø–æ—Ä—Ç–∑–∞–ª–µ ‚Äî –ø–µ—Ä–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ç—è–∂–µ–ª—ã, –Ω–æ –º—ã—à—Ü—ã –∫—Ä–µ–ø–Ω—É—Ç —Å –∫–∞–∂–¥–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π."
        }
      ].freeze
      
      # ===== –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ =====
      
      def deliver_intro
        # –®–∞–≥ 1: –í–≤–µ–¥–µ–Ω–∏–µ –≤ –¥–µ–Ω—å 11
        send_message(text: DAY_STEPS['intro'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['intro'][:instruction], parse_mode: 'Markdown')
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏
        send_message(
          text: statistics_message,
          parse_mode: 'Markdown'
        )
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        store_day_data('current_step', 'intro')
        
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –æ—Å–≤–æ–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è?",
          reply_markup: day_11_content_markup
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        store_day_data('current_step', 'exercise_explanation')
        
        send_message(text: DAY_STEPS['exercise_explanation'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['exercise_explanation'][:instruction], parse_mode: 'Markdown')
        
        send_message(
          text: "üåç *–¢–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ* üìã",
          parse_mode: 'Markdown'
        )
        
        send_message(
          text: "üéØ *–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:*\n\n‚Ä¢ –ù–∞–π–¥–∏—Ç–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ–µ –º–µ—Å—Ç–æ\n‚Ä¢ –°—è–¥—å—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–Ω—å—Ç–µ —É–¥–æ–±–Ω–æ\n‚Ä¢ –î—ã—à–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ\n‚Ä¢ –ë—É–¥—å—Ç–µ –¥–æ–±—Ä—ã –∫ —Å–µ–±–µ ‚Äî —ç—Ç–æ –Ω–∞–≤—ã–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è\n\n–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?",
          parse_mode: 'Markdown',
          reply_markup: day_11_grounding_start_markup
        )
      end
      
      def start_grounding_exercise
        # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        clear_grounding_data
        
        # –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
        store_day_data('grounding_started_at', Time.current)
        start_grounding_step('seen')
      end
      
      def start_grounding_step(step_type)
        store_day_data('current_grounding_step', step_type)
        @user.set_self_help_step("day_#{DAY_NUMBER}_waiting_for_#{step_type}")
        
        step = GROUNDING_STEPS[step_type]
        return unless step
        
        send_message(text: step[:title], parse_mode: 'Markdown')
        send_message(text: step[:instruction], parse_mode: 'Markdown')
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å —ç–º–æ–¥–∑–∏
        send_message(
          text: "#{step[:emoji]} *#{step[:sense].upcase}: –ù–∞–ø–∏—à–∏—Ç–µ #{step[:min_count]} #{step[:min_count] == 1 ? '–≤–µ—â—å' : '–≤–µ—â–∏(–µ–π)'}*",
          parse_mode: 'Markdown',
          reply_markup: day_11_input_markup
        )
      end
      
      def handle_grounding_input(input_text)
        current_step = get_day_data('current_grounding_step')
        step_config = GROUNDING_STEPS[current_step]
        
        return false unless step_config
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        if input_text.present?
          # –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –∑–∞–ø—è—Ç–∞—è, —Ç–æ—á–∫–∞, —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π, –ø—Ä–æ–±–µ–ª, –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
          items = input_text.split(/[,;.\s\n]+/)
                           .map(&:strip)
                           .reject(&:blank?)
          
          # –ï—Å–ª–∏ –ø–æ—Å–ª–µ split –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –æ–¥–Ω–æ —Å–ª–æ–≤–æ –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π)
          if items.empty? && input_text.strip.present?
            items = [input_text.strip]
          end
          
          if items.length < step_config[:min_count]
            send_message(
              text: "‚ùå *–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤!*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∑–æ–≤–∏—Ç–µ –º–∏–Ω–∏–º—É–º #{step_config[:min_count]} #{step_config[:min_count] == 1 ? '–≤–µ—â—å' : '–≤–µ—â–∏(–µ–π)'}.\n\n–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å:\n‚Ä¢ –ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: —Å—Ç–æ–ª, —Å—Ç—É–ª, –æ–∫–Ω–æ, –∫–Ω–∏–≥–∞, —á–∞—à–∫–∞\n‚Ä¢ –ß–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª: —Å—Ç–æ–ª —Å—Ç—É–ª –æ–∫–Ω–æ –∫–Ω–∏–≥–∞ —á–∞—à–∫–∞\n‚Ä¢ –ß–µ—Ä–µ–∑ —Ç–æ—á–∫—É: —Å—Ç–æ–ª. —Å—Ç—É–ª. –æ–∫–Ω–æ. –∫–Ω–∏–≥–∞. —á–∞—à–∫–∞\n‚Ä¢ –ß–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π: —Å—Ç–æ–ª; —Å—Ç—É–ª; –æ–∫–Ω–æ; –∫–Ω–∏–≥–∞; —á–∞—à–∫–∞\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:",
              parse_mode: 'Markdown'
            )
            return false
          end
        else
          send_message(text: "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç.")
          return false
        end
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        store_day_data("#{current_step}_items", items)
        store_day_data("#{current_step}_completed", true)
        
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        send_message(
          text: "‚úÖ #{step_config[:emoji]} *–®–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!* –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ #{items.length} #{step_config[:sense]}.",
          parse_mode: 'Markdown'
        )
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
        next_step = get_next_grounding_step(current_step)
        
        if next_step
          sleep(1) # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
          start_grounding_step(next_step)
        else
          # –í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
          complete_grounding_practice
        end
        
        true
      end
      
      def complete_grounding_practice
        store_day_data('grounding_completed', true)
        store_day_data('completion_time', Time.current)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –º–æ–¥–µ–ª—å GroundingExerciseEntry
        save_grounding_entry
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_grounding_completed")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑—É –ø—Ä–∞–∫—Ç–∏–∫–∏
        show_grounding_benefits
      end
      
      def show_grounding_benefits
        store_day_data('current_step', 'grounding_benefits')
        
        send_message(text: DAY_STEPS['grounding_benefits'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['grounding_benefits'][:instruction], parse_mode: 'Markdown')
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –ø—Ä–∞–∫—Ç–∏–∫–∏
        show_grounding_summary
        
        sleep(1)
        
        send_message(
          text: "üåü –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è.\n\n–° –∫–∞–∫–∏–º–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å?",
          parse_mode: 'Markdown',
          reply_markup: day_11_challenges_markup
        )
      end
      
      def handle_challenge_selection(challenge_index)
        challenge = GROUNDING_CHALLENGES[challenge_index.to_i]
        
        if challenge
          send_message(
            text: "#{challenge[:emoji]} **#{challenge[:challenge]}**\n\n#{challenge[:solution]}",
            parse_mode: 'Markdown'
          )
        end
        
        # –ú–ï–ù–Ø–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏
        @user.set_self_help_step("day_#{DAY_NUMBER}_reflection_done")
        
        send_message(
          text: "üéØ –¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è –æ—Å–≤–æ–µ–Ω–∞!\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–Ω—å 11?",
          reply_markup: day_11_final_completion_markup
        )
      end
      
      def show_grounding_summary
        seen_items = get_day_data('seen_items') || []
        heard_items = get_day_data('heard_items') || []
        
        summary = "üìä *–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –≤–∞—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏:*\n\nüëÅÔ∏è **5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–µ–ª–∏:** #{Array(seen_items).length > 0 ? Array(seen_items).first(3).join(', ') + (Array(seen_items).length > 3 ? '...' : '') : '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}\n\nüëÇ **3 –∑–≤—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Å–ª—ã—à–∞–ª–∏:** #{Array(heard_items).length > 0 ? Array(heard_items).join(', ') : '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}\n\n‚úÖ **–í—Å–µ 5 —á—É–≤—Å—Ç–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!**\n\nüìÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –≤–∞—à—É –∫–æ–ª–ª–µ–∫—Ü–∏—é –ø—Ä–∞–∫—Ç–∏–∫ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è**"
        
        send_message(text: summary, parse_mode: 'Markdown')
      end
      
      def show_previous_grounding_entries
        begin
          entries = GroundingExerciseEntry.where(user: @user).recent.limit(3)
          
          if entries.empty?
            send_message(
              text: "üåç *–í–∞—à–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è:*\n\n–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫.\n–ü—Ä–æ–π–¥–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–Ω—è 11, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.",
              parse_mode: 'Markdown',
              reply_markup: day_11_content_markup
            )
            return
          end
          
          total_count = GroundingExerciseEntry.where(user: @user).count
          
          send_message(
            text: "üåç *–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è (–≤—Å–µ–≥–æ: #{total_count}):*",
            parse_mode: 'Markdown'
          )
          
          entries.each_with_index do |entry, index|
            entry_date = entry.entry_date.strftime('%d.%m.%Y')
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á—É–≤—Å—Ç–≤–∞
            seen_text = format_sense_items(entry.seen, 2)
            touched_text = format_sense_items(entry.touched, 2)
            heard_text = format_sense_items(entry.heard, 2)
            smelled_text = format_sense_items(entry.smelled, 2)
            tasted_text = format_sense_items(entry.tasted, 2)
            
            entry_summary = <<~MARKDOWN
              *#{index + 1}. #{entry_date}*
              
              üëÅÔ∏è *–í–∏–¥–µ–ª(–∞):* #{seen_text}
              ‚úã *–ß—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞):* #{touched_text}
              üëÇ *–°–ª—ã—à–∞–ª(–∞):* #{heard_text}
              üëÉ *–ù—é—Ö–∞–ª(–∞):* #{smelled_text}
              üëÖ *–ü—Ä–æ–±–æ–≤–∞–ª(–∞):* #{tasted_text}
            MARKDOWN
            
            send_message(text: entry_summary, parse_mode: 'Markdown')
          end
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏
          send_message(
            text: "–•–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é?",
            reply_markup: {
              inline_keyboard: [
                [
                  { text: "üîÑ –ù–æ–≤–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞", callback_data: "day_11_start_grounding" },
                  { text: "üîô –í –º–µ–Ω—é", callback_data: "continue_day_11_content" }
                ]
              ]
            }
          )
          
        rescue => e
          log_error("Error showing grounding entries", e)
          send_message(
            text: "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∞—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode: 'Markdown'
          )
        end
      end
      
def complete_exercise
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è
  unless get_day_data('grounding_completed') == true
    send_message(
      text: "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è.\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ 5 —à–∞–≥–æ–≤ —Ç–µ—Ö–Ω–∏–∫–∏ 5-4-3-2-1.",
      parse_mode: 'Markdown',
      reply_markup: day_11_content_markup
    )
    return
  end
  
  # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ @user.complete_day_program(DAY_NUMBER) - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
  # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ complete_self_help_day, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç complete_day_program
  @user.complete_self_help_day(DAY_NUMBER)
  
  # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
  # complete_self_help_day —É–∂–µ –¥–µ–ª–∞–µ—Ç set_self_help_step
  
  completion_message = "üéä *–î–µ–Ω—å 11 –∑–∞–≤–µ—Ä—à–µ–Ω!* üéä\n\n**–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è:**\n\nüåç **–¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1:**\n‚Ä¢ üëÅÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã 5 —á—É–≤—Å—Ç–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ\n‚Ä¢ üß† –û—Å–≤–æ–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∞–º–æ–ø–æ–º–æ—â–∏\n‚Ä¢ üòå –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –Ω–∞–≤—ã–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ\n‚Ä¢ üö® –°–æ–∑–¥–∞–Ω –ª–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–µ–≤–æ–≥–æ–π\n‚Ä¢ üìä –ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞\n\nüìä **–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:**\n–†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏ 5-4-3-2-1 —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫ –Ω–∞ 40-50% –∏ —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç—Ä–µ–≤–æ–≥–∏ –Ω–∞ 30-40% –∑–∞ 4-6 –Ω–µ–¥–µ–ª—å.\n\nüéØ **–ß—Ç–æ –¥–∞–ª—å—à–µ:**\n–ó–∞–≤—Ç—Ä–∞ - –î–µ–Ω—å 12: –ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ\n\n‚è∞ **–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤**\n\n–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: #{@user.progress_percentage}%"
  
  send_message(text: completion_message, parse_mode: 'Markdown')
  
  # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
  propose_next_day_with_restriction
end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö =====
      
      def handle_button(callback_data)
        case callback_data
        when 'start_day_11_content', 'start_day_11_from_proposal'
          deliver_exercise
          
        when 'continue_day_11_content'
          current_step = get_day_data('current_step')
          handle_resume_from_step(current_step || 'intro')
          
        when 'day_11_start_grounding', 'start_grounding_exercise'
          start_grounding_exercise
          
        when 'day_11_skip_step'
          # –ü—Ä–æ–ø—É—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ (–¥–ª—è –∫—Ä–∞–π–Ω–∏—Ö —Å–ª—É—á–∞–µ–≤)
          current_step = get_day_data('current_grounding_step')
          if current_step
            next_step = get_next_grounding_step(current_step)
            if next_step
              send_message(text: "‚ö†Ô∏è –®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.")
              start_grounding_step(next_step)
            else
              complete_grounding_practice
            end
          end
          
        when 'day_11_restart_grounding'
          start_grounding_exercise
          
        when 'grounding_exercise_completed', 'day_11_complete_grounding'
          complete_grounding_practice
          
        when /^day_11_challenge_(\d+)$/
          handle_challenge_selection($1)
          
        when 'day_11_no_challenges'
          # –ú–ï–ù–Ø–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ "–Ω–µ—Ç —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π"
          @user.set_self_help_step("day_#{DAY_NUMBER}_reflection_done")
          send_message(text: "üåü –û—Ç–ª–∏—á–Ω–æ! –£ –≤–∞—Å –ø–æ–ª—É—á–∏–ª–∞—Å—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞!")
          send_message(
            text: "–ó–∞–≤–µ—Ä—à–∞–µ–º –î–µ–Ω—å 11?",
            reply_markup: day_11_final_completion_markup
          )
          
        when 'day_11_complete_exercise', 'day_11_exercise_completed'
          complete_exercise
          
        when 'day_11_show_entries'
          show_previous_grounding_entries
          
        when 'day_11_help_tips'
          send_message(
            text: "üí° *–°–æ–≤–µ—Ç—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏:*\n\n‚Ä¢ –î–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏\n‚Ä¢ –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏—è—Ö\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã —á—É–≤—Å—Ç–≤ –∫–∞–∂–¥—ã–π —Ä–∞–∑\n‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö\n‚Ä¢ –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏",
            parse_mode: 'Markdown'
          )
          
        when 'day_11_emergency_mode'
          send_message(
            text: "üö® *–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∑–∞–∑–µ–º–ª–µ–Ω–∏—è:*\n\n–ï—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ø–∞–Ω–∏–∫—É –∏–ª–∏ –¥–∏—Å—Å–æ—Ü–∏–∞—Ü–∏—é:\n1. –°–∫–∞–∂–∏—Ç–µ —Å–µ–±–µ: \"–Ø –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Ö–Ω–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è\"\n2. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ\n3. –î—ã—à–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ\n4. –ü–æ–º–Ω–∏—Ç–µ: —ç—Ç–æ –ø—Ä–æ–π–¥–µ—Ç\n\n–í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
            parse_mode: 'Markdown',
            reply_markup: day_11_grounding_start_markup
          )
          
        else
          log_warn("Unknown button callback: #{callback_data}")
          send_message(text: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.")
        end
      end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–û–í–û–ì–û –í–í–û–î–ê =====
      
      def handle_text_input(input_text)
        log_info("Handling text input for day 11: #{input_text}")
        
        current_state = @user.self_help_state
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –≤–≤–æ–¥ –æ–∂–∏–¥–∞–µ—Ç—Å—è
        case current_state
        when "day_11_waiting_for_seen"
          return handle_grounding_input(input_text)
          
        when "day_11_waiting_for_touched"
          return handle_grounding_input(input_text)
          
        when "day_11_waiting_for_heard"
          return handle_grounding_input(input_text)
          
        when "day_11_waiting_for_smelled"
          return handle_grounding_input(input_text)
          
        when "day_11_waiting_for_tasted"
          return handle_grounding_input(input_text)
          
        when "day_11_grounding_completed", "day_11_reflection_done", "day_11_completed"
          # –ï—Å–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
          send_message(
            text: "‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ:\n‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏\n‚Ä¢ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–∞–∫—Ç–∏–∫—É\n‚Ä¢ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å 11",
            reply_markup: day_11_final_completion_markup
          )
          return true
        end
        
        log_warn("No text input handler for current state: #{current_state}")
        false
      end
      
      # –ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å SelfHelpFacade
      def handle_smart_input(text)
        handle_text_input(text)
      end
      
      # ===== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò =====
      
      def resume_session
        current_state = @user.self_help_state
        
        case current_state
        when "day_#{DAY_NUMBER}_intro"
          deliver_exercise
          
        when "day_#{DAY_NUMBER}_exercise_in_progress"
          current_step = get_day_data('current_step')
          if current_step.present?
            handle_resume_from_step(current_step)
          else
            deliver_exercise
          end
          
        when /^day_#{DAY_NUMBER}_waiting_for_/
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è
          current_step = get_day_data('current_grounding_step')
          if current_step.present?
            start_grounding_step(current_step)
          else
            start_grounding_exercise
          end
          
        when "day_#{DAY_NUMBER}_grounding_completed"
          show_grounding_benefits
          
        when "day_#{DAY_NUMBER}_reflection_done"
          send_message(
            text: "üéØ –¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è –æ—Å–≤–æ–µ–Ω–∞!\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–Ω—å 11?",
            reply_markup: day_11_final_completion_markup
          )
          
        else
          log_warn("Unknown or invalid state for resume: #{current_state}")
          show_intro_without_state
        end
      end
      
      def handle_resume_from_step(step)
        case step
        when 'intro'
          deliver_intro
        when 'exercise_explanation'
          deliver_exercise
        when 'grounding_benefits'
          show_grounding_benefits
        when 'completion'
          show_completion_message
        else
          deliver_exercise
        end
      end
      
      def show_intro_without_state
        send_message(text: DAY_STEPS['intro'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['intro'][:instruction], parse_mode: 'Markdown')
        send_message(
          text: statistics_message,
          parse_mode: 'Markdown'
        )
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –æ—Å–≤–æ–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è?",
          reply_markup: day_11_content_markup
        )
      end
      
      def propose_next_day_with_restriction
        next_day = 12
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        can_start_result = @user.can_start_day?(next_day)
        
        if can_start_result == true
          message = "üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å #{next_day}**\n\n‚úÖ *–î–æ—Å—Ç—É–ø–µ–Ω —Å–µ–π—á–∞—Å!*\n\n**–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:**\n‚Ä¢ üíù –ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ\n‚Ä¢ ü§ó –†–∞–∑–≤–∏—Ç–∏–µ –¥–æ–±—Ä–æ—Ç—ã –∫ —Å–µ–±–µ\n‚Ä¢ üòå –°–Ω–∏–∂–µ–Ω–∏–µ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∏\n‚Ä¢ üåü –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏\n\n–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å."
          
          button_text = "üíù –ù–∞—á–∞—Ç—å –î–µ–Ω—å #{next_day}"
          callback_data = "start_day_#{next_day}_from_proposal"
        else
          error_message = can_start_result.is_a?(Array) ? can_start_result.join("\n") : can_start_result
          
          message = "üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å #{next_day}**\n\n‚è±Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:* #{error_message}\n\n**–ü–æ–∫–∞ –∂–¥–µ—Ç–µ, –º–æ–∂–µ—Ç–µ:**\n‚Ä¢ üåç –ü—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö\n‚Ä¢ üìö –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏\n‚Ä¢ üîÑ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–µ–Ω—Å–æ—Ä–Ω—ã–º–∏ –æ—â—É—â–µ–Ω–∏—è–º–∏\n‚Ä¢ üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (/progress)\n\n*–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–≥–¥–∞ –ø—Ä–æ–π–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏.*"
          
          button_text = "‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –î–Ω—è #{next_day}"
          callback_data = "start_day_#{next_day}_from_proposal"
        end
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:",
          reply_markup: {
            inline_keyboard: [
              [
                { 
                  text: button_text, 
                  callback_data: callback_data
                }
              ]
            ]
          }
        )
      end
      
      private

      def format_sense_items(items, max_items = 2)
        return "–Ω–µ —É–∫–∞–∑–∞–Ω—ã" if items.blank?
        
        if items.is_a?(Array)
          display_items = items.first(max_items)
          display_text = display_items.join(', ')
          display_text += "..." if items.length > max_items
          display_text
        elsif items.is_a?(String)
          # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–±–∏—Ç—å
          items_array = items.split(/[,;.\s\n]+/).reject(&:blank?)
          if items_array.any?
            display_items = items_array.first(max_items)
            display_text = display_items.join(', ')
            display_text += "..." if items_array.length > max_items
            display_text
          else
            items
          end
        else
          items.to_s
        end
      end
      
      def get_next_grounding_step(current_step)
        steps_order = GROUNDING_STEPS.keys
        current_index = steps_order.index(current_step)
        
        return steps_order[current_index + 1] if current_index && current_index < steps_order.length - 1
        nil
      end
      
      def save_grounding_entry
        begin
          seen_items = get_day_data('seen_items') || []
          touched_items = get_day_data('touched_items') || []
          heard_items = get_day_data('heard_items') || []
          smelled_items = get_day_data('smelled_items') || []
          tasted_items = get_day_data('tasted_items') || []
          
          GroundingExerciseEntry.create!(
            user: @user,
            entry_date: Date.current,
            seen: seen_items,
            touched: touched_items,
            heard: heard_items,
            smelled: smelled_items,
            tasted: tasted_items
          )
          
          log_info("Saved grounding entry")
          store_day_data('entry_id', GroundingExerciseEntry.last&.id)
          
          true
        rescue => e
          log_error("Failed to save grounding entry", e)
          false
        end
      end
      
      def clear_grounding_data
        GROUNDING_STEPS.keys.each do |step|
          store_day_data("#{step}_items", nil)
          store_day_data("#{step}_completed", nil)
        end
        store_day_data('current_grounding_step', nil)
        store_day_data('grounding_started_at', nil)
        store_day_data('grounding_completed', nil)
        store_day_data('completion_time', nil)
      end
      
      # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–∞–∑–º–µ—Ç–∫–∏
      def day_11_content_markup
        TelegramMarkupHelper.day_11_content_markup
      end
      
      def day_11_grounding_start_markup
        TelegramMarkupHelper.day_11_grounding_start_markup
      end
      
      def day_11_input_markup
        TelegramMarkupHelper.day_11_input_markup
      end
      
      def day_11_challenges_markup
        TelegramMarkupHelper.day_11_challenges_markup
      end
      
      def day_11_final_completion_markup
        TelegramMarkupHelper.day_11_final_completion_markup
      end
      
      def statistics_message
        <<~MARKDOWN
          üìä *–ù–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ—Ö–Ω–∏–∫–µ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1:*
          
          ‚Ä¢ üß† **40-50%** ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫ –ø–æ—Å–ª–µ 4 –Ω–µ–¥–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏
          ‚Ä¢ üòå **30-40%** ‚Äî —É–º–µ–Ω—å—à–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Ç—Ä–µ–≤–æ–≥–∏
          ‚Ä¢ ‚è±Ô∏è **60-90 —Å–µ–∫—É–Ω–¥** ‚Äî –≤—Ä–µ–º—è –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
          ‚Ä¢ üéØ **70-80%** ‚Äî —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –¥–∏—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
          ‚Ä¢ üîÑ **4-6 –Ω–µ–¥–µ–ª—å** ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          ‚Ä¢ üìà **25-35%** ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫ —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏
          
          *–ò—Å—Ç–æ—á–Ω–∏–∫: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è Journal of Anxiety Disorders, Cognitive Therapy and Research*
        MARKDOWN
      end
      
      def log_info(message)
        Rails.logger.info "[#{self.class}] #{message} - User: #{@user.telegram_id}"
      end
      
      def log_warn(message)
        Rails.logger.warn "[#{self.class}] #{message} - User: #{@user.telegram_id}"
      end
      
      def log_error(message, error = nil)
        Rails.logger.error "[#{self.class}] #{message} - User: #{@user.telegram_id}"
        Rails.logger.error error.message if error
        Rails.logger.error error.backtrace.first(5).join("\n") if error
      end
    end
  end
end