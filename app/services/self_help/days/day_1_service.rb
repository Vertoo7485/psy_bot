# app/services/self_help/days/day_1_service.rb
module SelfHelp
  module Days
    class Day1Service < DayBaseService
      include TelegramMarkupHelper
      
      # ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹
      DAY_NUMBER = 1
      
      def deliver_intro
        message_text = <<~MARKDOWN
          ðŸŽ¯ *Ð”ÐµÐ½ÑŒ 1: ÐžÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ* ðŸŽ¯

          **Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸!**

          ÐžÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ â€” ÑÑ‚Ð¾ ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ðµ, Ð±ÐµÐ· Ð¾ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ñ, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð±Ð»ÑŽÐ´Ð°Ñ ÑÐ²Ð¾Ð¸ Ð¼Ñ‹ÑÐ»Ð¸, Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° Ð¸ Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ñ.

          Ð­Ñ‚Ð¾ Ð¼Ð¾Ñ‰Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ:
          â€¢ Ð¡Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€ÐµÑÑÐ° Ð¸ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð¸
          â€¢ Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€ÐµÐ³ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          â€¢ ÐŸÐ¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸Ð¸
          â€¢ Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ
        MARKDOWN
        
        send_message(text: message_text, parse_mode: 'Markdown')
        
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ set_self_help_step Ð²Ð¼ÐµÑÑ‚Ð¾ set_self_help_day
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        
        send_message(
          text: "ÐšÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº Ð¿ÐµÑ€Ð²Ð¾Ð¼Ñƒ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸ÑŽ, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ:",
          reply_markup: day_1_continue_markup  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð¸Ð· TelegramMarkupHelper
        )
      end
      
      def deliver_exercise
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ set_self_help_step
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        
        exercise_text = <<~MARKDOWN
          ðŸ§˜ *Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ: Ð’Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ðµ* ðŸ§˜

          **Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ:**

          1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ñ‚Ð¸Ñ…Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾, Ð³Ð´Ðµ Ð²Ð°Ñ Ð½Ðµ Ð¿Ð¾Ð±ÐµÑÐ¿Ð¾ÐºÐ¾ÑÑ‚ 5-10 Ð¼Ð¸Ð½ÑƒÑ‚
          2. Ð¡ÑÐ´ÑŒÑ‚Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾ Ð¸Ð»Ð¸ Ð»ÑÐ³Ñ‚Ðµ
          3. Ð—Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð³Ð»Ð°Ð·Ð°, ÐµÑÐ»Ð¸ Ð²Ð°Ð¼ ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚Ð½Ð¾
          4. Ð¡Ð¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡ÑŒÑ‚ÐµÑÑŒ Ð½Ð° ÑÐ²Ð¾ÐµÐ¼ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ð¸

          **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ:**
          â€¢ ÐžÑ‰ÑƒÑ‰Ð°Ð¹Ñ‚Ðµ, ÐºÐ°Ðº Ð²Ð¾Ð·Ð´ÑƒÑ… Ð²Ñ…Ð¾Ð´Ð¸Ñ‚ Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ñ‚
          â€¢ ÐÐµ Ð¿Ñ‹Ñ‚Ð°Ð¹Ñ‚ÐµÑÑŒ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ðµ
          â€¢ Ð•ÑÐ»Ð¸ ÑƒÐ¼ Ð¾Ñ‚Ð²Ð»ÐµÐºÐ°ÐµÑ‚ÑÑ, Ð¼ÑÐ³ÐºÐ¾ Ð²ÐµÑ€Ð½Ð¸Ñ‚Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ Ðº Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÑŽ
          â€¢ ÐŸÑ€Ð°ÐºÑ‚Ð¸ÐºÑƒÐ¹Ñ‚Ðµ 5-10 Ð¼Ð¸Ð½ÑƒÑ‚

          Ð­Ñ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ÑÐ»Ð¸ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ÑÑ‚ Ð¸ ÑƒÑ…Ð¾Ð´ÑÑ‚. Ð¦ÐµÐ»ÑŒ â€” Ð·Ð°Ð¼ÐµÑ‡Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ðº Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÑŽ.
        MARKDOWN
        
        send_message(text: exercise_text, parse_mode: 'Markdown')
        
        send_message(
          text: "ÐšÐ¾Ð³Ð´Ð° Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ñ‚Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ:",
          reply_markup: TelegramMarkupHelper.day_1_exercise_completed_markup  # ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð²Ñ‹Ð·Ð¾Ð²
        )
      end
      
      def complete_exercise
        @user.complete_self_help_day(DAY_NUMBER)
        
        message = <<~MARKDOWN
          ðŸŒŸ *ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°!* ðŸŒŸ

          Ð’Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¾ÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ!

          **ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ:**
          â€¢ ÐŸÑ€Ð°ÐºÑ‚Ð¸ÐºÐ° Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ â€” ÑÑ‚Ð¾ Ð½Ð°Ð²Ñ‹Ðº
          â€¢ ÐžÐ½ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ñ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¾Ð¹
          â€¢ ÐÐµ Ñ€Ð°ÑÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ð¹Ñ‚ÐµÑÑŒ, ÐµÑÐ»Ð¸ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ñ‚Ñ€ÑƒÐ´Ð½Ð¾
          â€¢ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ â€” Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ñ‚ÑŒ!

          Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð²Ñ‹ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ð²Ð°Ð¶Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³!

          Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð”ÐµÐ½ÑŒ 2?
        MARKDOWN
        
        send_message(
          text: message,
          parse_mode: 'Markdown',
          reply_markup: TelegramMarkupHelper.day_start_proposal_markup(2)
        )
      end
      
      def resume_session
        current_state = @user.self_help_state
        
        case current_state
        when "day_1_intro", "day_1_exercise_in_progress"
          # Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð´Ð½Ñ 1, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ñ Ñ‚Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð°
          handle_resume_from_state(current_state)
        else
          # ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ‚Ñ€Ð¾
          deliver_intro
        end
      end
      
      private
      
      def handle_resume_from_state(state)
        case state
        when "day_1_intro"
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ‚Ñ€Ð¾ ÑÐ½Ð¾Ð²Ð°
          deliver_intro
        when "day_1_exercise_in_progress"
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ ÑÐ½Ð¾Ð²Ð°
          deliver_exercise
        end
      end
      
      # Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÐ¸,
      # Ð½Ð¾ Ð»ÑƒÑ‡ÑˆÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ Ð¸Ð· TelegramMarkupHelper
      def day_1_continue_markup
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð¸Ð· TelegramMarkupHelper
        TelegramMarkupHelper.day_1_continue_markup
      end
    end
  end
end