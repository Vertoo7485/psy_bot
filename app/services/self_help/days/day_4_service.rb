# app/services/self_help/days/day_4_service.rb
module SelfHelp
  module Days
    class Day4Service < DayBaseService
      include TelegramMarkupHelper
      # ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹
      DAY_NUMBER = 4
      BREATHING_CYCLE_COUNT = 10
      BREATHING_SECONDS = 4
      
      def deliver_intro
        message_text = <<~MARKDOWN
          ðŸŽ¯ *Ð”ÐµÐ½ÑŒ 4: Ð ÐµÐ³ÑƒÐ»ÑÑ†Ð¸Ñ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ñ* ðŸŽ¯

          **Ð”Ñ‹Ñ…Ð°Ð½Ð¸Ðµ ÐºÐ°Ðº Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ ÑƒÑÐ¿Ð¾ÐºÐ¾ÐµÐ½Ð¸Ñ**

          Ð”Ñ‹Ñ…Ð°Ð½Ð¸Ðµ â€” ÑÑ‚Ð¾ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¼Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ ÐºÐ°Ðº Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸, Ñ‚Ð°Ðº Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒÑÑ ÑÐ¾Ð·Ð½Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð´Ñ‹Ñ…Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸, Ð¼Ñ‹ Ð¼Ð¾Ð¶ÐµÐ¼ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ð½Ð°ÑˆÑƒ Ð½ÐµÑ€Ð²Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ.

          **Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ñ‹ Ð¾ÑÐ²Ð¾Ð¸Ð¼ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ Â«ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¾Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÐµÂ»:**
          â€¢ ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ, Ð½Ð¾ Ð¾Ñ‡ÐµÐ½ÑŒ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð°Ñ
          â€¢ ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾ ÑÐ½Ð¸Ð·Ð¸Ñ‚ÑŒ Ñ‚Ñ€ÐµÐ²Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ
          â€¢ Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸ÑŽ
          â€¢ ÐœÐ¾Ð¶Ð½Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð³Ð´Ðµ ÑƒÐ³Ð¾Ð´Ð½Ð¾
        MARKDOWN
        
        send_message(text: message_text, parse_mode: 'Markdown')
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        
        # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸, Ð½Ð¾ ÐÐ• Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð½Ð° exercise_in_progress
        send_message(
          text: "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ñ?",
          reply_markup: TelegramMarkupHelper.day_4_exercise_consent_markup
        )
      end
      
      def deliver_exercise
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ "ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ" Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÑ‚
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        
        exercise_text = <<~MARKDOWN
          ðŸ§˜ *Ð¢ÐµÑ…Ð½Ð¸ÐºÐ° Â«ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¾Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÐµÂ» (#{BREATHING_SECONDS}-#{BREATHING_SECONDS}-#{BREATHING_SECONDS}-#{BREATHING_SECONDS})* ðŸ§˜

          **ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°:**
          1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (ÑÐ¸Ð´Ñ Ð¸Ð»Ð¸ Ð»ÐµÐ¶Ð°)
          2. Ð Ð°ÑÑÐ»Ð°Ð±ÑŒÑ‚Ðµ Ð¿Ð»ÐµÑ‡Ð¸
          3. Ð—Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð³Ð»Ð°Ð·Ð°, ÐµÑÐ»Ð¸ Ð²Ð°Ð¼ ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚Ð½Ð¾

          **Ð¢ÐµÑ…Ð½Ð¸ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:**

          ðŸ”· **Ð’Ð´Ð¾Ñ… (#{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹)**
          ÐœÐµÐ´Ð»ÐµÐ½Ð½Ð¾ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾ Ð²Ð´Ð¾Ñ…Ð½Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð½Ð¾Ñ, Ð¼Ñ‹ÑÐ»ÐµÐ½Ð½Ð¾ ÑÑ‡Ð¸Ñ‚Ð°Ñ Ð´Ð¾ #{BREATHING_SECONDS}.

          ðŸ”· **Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° (#{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹)**
          Ð—Ð°Ð´ÐµÑ€Ð¶Ð¸Ñ‚Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ðµ Ð½Ð° #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹.

          ðŸ”· **Ð’Ñ‹Ð´Ð¾Ñ… (#{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹)**
          ÐœÐµÐ´Ð»ÐµÐ½Ð½Ð¾ Ð¸ Ð¿Ð»Ð°Ð²Ð½Ð¾ Ð²Ñ‹Ð´Ð¾Ñ…Ð½Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Ñ€Ð¾Ñ‚, ÑÑ‡Ð¸Ñ‚Ð°Ñ Ð´Ð¾ #{BREATHING_SECONDS}.

          ðŸ”· **Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° (#{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹)**
          Ð—Ð°Ð´ÐµÑ€Ð¶Ð¸Ñ‚Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ðµ Ð½Ð° #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹.

          **Ð¦Ð¸ÐºÐ»:** Ð’Ð´Ð¾Ñ… â†’ Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° â†’ Ð’Ñ‹Ð´Ð¾Ñ… â†’ Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ°
          **ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ #{BREATHING_CYCLE_COUNT} Ñ†Ð¸ÐºÐ»Ð¾Ð²**
        MARKDOWN
        
        send_message(text: exercise_text, parse_mode: 'Markdown')
        
        # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
        send_square_breathing_visualization
        
        send_message(
          text: "ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ. ÐšÐ¾Ð³Ð´Ð° Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ñ‚Ðµ, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ:",
          reply_markup: TelegramMarkupHelper.day_4_exercise_completed_markup
        )
      end
      
      def complete_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
        
        message = <<~MARKDOWN
          ðŸŒŸ *ÐŸÑ€ÐµÐºÑ€Ð°ÑÐ½Ð¾!* ðŸŒŸ

          Ð’Ñ‹ Ð¾ÑÐ²Ð¾Ð¸Ð»Ð¸ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ñ!

          **ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:**
          â€¢ ÐŸÐµÑ€ÐµÐ´ Ð²Ð°Ð¶Ð½Ñ‹Ð¼Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÐ¼Ð¸
          â€¢ ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ñ… Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ°Ñ… Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð¸
          â€¢ Ð”Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸Ð¸
          â€¢ ÐŸÐµÑ€ÐµÐ´ ÑÐ½Ð¾Ð¼ Ð´Ð»Ñ Ñ€Ð°ÑÑÐ»Ð°Ð±Ð»ÐµÐ½Ð¸Ñ

          **ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ:**
          â€¢ Ð”Ñ‹ÑˆÐ¸Ñ‚Ðµ Ð´Ð¸Ð°Ñ„Ñ€Ð°Ð³Ð¼Ð¾Ð¹ (Ð¶Ð¸Ð²Ð¾Ñ‚Ð¾Ð¼)
          â€¢ ÐÐµ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€ÑÐ³Ð°Ð¹Ñ‚ÐµÑÑŒ
          â€¢ ÐÐ°Ñ‡Ð¸Ð½Ð°Ð¹Ñ‚Ðµ Ñ 2-3 Ð¼Ð¸Ð½ÑƒÑ‚, ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')

        propose_next_day
      end
      
      # Ð˜Ð·Ð¼ÐµÐ½ÑÐµÐ¼ Ð½Ð° false, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ deliver_exercise Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
      def should_deliver_exercise_immediately?
        false
      end
      
      # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      def handle_exercise_consent
        # Ð­Ñ‚Ð¾Ñ‚ Ð¼ÐµÑ‚Ð¾Ð´ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒÑÑ ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¶Ð¸Ð¼Ð°ÐµÑ‚ "Ð”Ð°, Ð³Ð¾Ñ‚Ð¾Ð²(Ð°)!" 
        # Ð² Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ñ?"
        deliver_exercise
      end
      
      private
      
      def send_square_breathing_visualization
        visualization = <<~TEXT
          ```
          â•”â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   Ð’Ð”ÐžÐ¥    â•‘  â†’ #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹
          â•‘     #{BREATHING_SECONDS}     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•
                 â†“
          â•”â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Ð—ÐÐ”Ð•Ð Ð–ÐšÐ â•‘  â†’ #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹
          â•‘     #{BREATHING_SECONDS}     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•
                 â†“
          â•”â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   Ð’Ð«Ð”ÐžÐ¥   â•‘  â†’ #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹
          â•‘     #{BREATHING_SECONDS}     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•
                 â†“
          â•”â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Ð—ÐÐ”Ð•Ð Ð–ÐšÐ â•‘  â†’ #{BREATHING_SECONDS} ÑÐµÐºÑƒÐ½Ð´Ñ‹
          â•‘     #{BREATHING_SECONDS}     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•
          ```
        TEXT
        
        send_message(text: visualization, parse_mode: 'Markdown')
      end
    end
  end
end