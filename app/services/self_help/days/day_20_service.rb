# app/services/self_help/days/day_20_service.rb

module SelfHelp
  module Days
    class Day20Service < DayBaseService
      include TelegramMarkupHelper
      
      DAY_NUMBER = 20
      
      # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç—Ä–∞—Ö–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
      FEAR_CATEGORIES = {
        'social' => {
          name: '–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏',
          examples: [
            '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–µ–∑–Ω–∞–∫–æ–º—Ü—É',
            '–í—ã—Å—Ç—É–ø–∏—Ç—å –Ω–∞ —Å–æ–±—Ä–∞–Ω–∏–∏',
            '–°–∫–∞–∑–∞—Ç—å "–Ω–µ—Ç" –∫–æ–ª–ª–µ–≥–µ',
            '–ü–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–µ–º-—Ç–æ –Ω–æ–≤—ã–º',
            '–°–¥–µ–ª–∞—Ç—å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç'
          ]
        },
        'personal' => {
          name: '–õ–∏—á–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏', 
          examples: [
            '–ù–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏',
            '–ü–æ–π—Ç–∏ –≤ —Å–ø–æ—Ä—Ç–∑–∞–ª',
            '–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏—á–µ—Å–∫—É',
            '–ö—É–ø–∏—Ç—å —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ',
            '–°–∫–∞–∑–∞—Ç—å –æ —Å–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö'
          ]
        },
        'professional' => {
          name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏',
          examples: [
            '–ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏–µ',
            '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤—É—é –∏–¥–µ—é',
            '–í–∑—è—Ç—å —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ–µ–∫—Ç',
            '–ü—Ä–∏–∑–Ω–∞—Ç—å –æ—à–∏–±–∫—É',
            '–ü—Ä–æ–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ'
          ]
        },
        'small_wins' => {
          name: '–ú–∞–ª—ã–µ –ø–æ–±–µ–¥—ã',
          examples: [
            '–°–∫–∞–∑–∞—Ç—å —á—Ç–æ-—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏',
            '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ',
            '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤–º–µ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è',
            '–ü–æ–π—Ç–∏ –Ω–æ–≤–æ–π –¥–æ—Ä–æ–≥–æ–π',
            '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –µ–¥—É'
          ]
        }
      }.freeze
      
      # –®–∞–≥–∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–∞
      FEAR_OVERCOMING_STEPS = [
        {
          title: "–û—Å–æ–∑–Ω–∞–Ω–∏–µ",
          description: "–ü—Ä–∏–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö. –ù–∞–∑–æ–≤–∏—Ç–µ –µ–≥–æ –≤—Å–ª—É—Ö –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ.",
          emoji: "üéØ"
        },
        {
          title: "–ê–Ω–∞–ª–∏–∑", 
          description: "–°–ø—Ä–æ—Å–∏—Ç–µ —Å–µ–±—è: '–ß—Ç–æ —Å–∞–º–æ–µ —Ö—É–¥—à–µ–µ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è?' –∏ '–ß—Ç–æ —Å–∞–º–æ–µ –ª—É—á—à–µ–µ?'",
          emoji: "üß†"
        },
        {
          title: "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
          description: "–†–∞–∑–±–µ–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏. –ù–∞—á–Ω–∏—Ç–µ —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ.",
          emoji: "üìù"
        },
        {
          title: "–î–µ–π—Å—Ç–≤–∏–µ",
          description: "–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
          emoji: "üöÄ"
        },
        {
          title: "–†–µ—Ñ–ª–µ–∫—Å–∏—è",
          description: "–ü–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ.",
          emoji: "üí≠"
        }
      ].freeze
      
      # –ü–æ–ª—å–∑–∞ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤
      BENEFITS = [
        "üß† **–ù–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å –º–æ–∑–≥–∞** - –∫–∞–∂–¥—ã–π —Ä–∞–∑, –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—è —Å—Ç—Ä–∞—Ö, –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ –Ω–æ–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏",
        "üí™ **–ü–æ–≤—ã—à–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ –¥–µ–ª–∞–µ—Ç –≤–∞—Å —Å–∏–ª—å–Ω–µ–µ",
        "üå± **–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç** - –≤—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞ = —Ä–∞—Å—Ç–µ—Ç–µ –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç—å",
        "üéØ **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π** - —Å—Ç—Ä–∞—Ö–∏ –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤–∞—à—É –∂–∏–∑–Ω—å",
        "üòå **–°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏** - –º–æ–∑–≥ —É—á–∏—Ç—Å—è, —á—Ç–æ –º–Ω–æ–≥–∏–µ —Å—Ç—Ä–∞—Ö–∏ –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã"
      ].freeze
      
      # ===== –û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´ =====
      
      def deliver_intro
        message_text = <<~MARKDOWN
          ü¶∏‚Äç‚ôÇÔ∏è *–î–µ–Ω—å 20: –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–∞* ü¶∏‚Äç‚ôÄÔ∏è

          *–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –º–∏—Å—Å–∏—è:*
          **–°–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ, —á—Ç–æ –≤—ã –±–æ–∏—Ç–µ—Å—å —Å–¥–µ–ª–∞—Ç—å.**

          *–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?*

          –ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ —Å—Ç—Ä–∞—Ö–µ:
          üß† *–°—Ç—Ä–∞—Ö –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –º–∏–Ω–¥–∞–ª–µ–≤–∏–¥–Ω–æ–µ —Ç–µ–ª–æ* - –¥—Ä–µ–≤–Ω—é—é —á–∞—Å—Ç—å –º–æ–∑–≥–∞, –æ—Ç–≤–µ—á–∞—é—â—É—é –∑–∞ –≤—ã–∂–∏–≤–∞–Ω–∏–µ
          üîÑ *–ü—Ä–∏–≤—ã–∫–∞–Ω–∏–µ* - –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å —Å–æ —Å—Ç—Ä–∞—Ö–æ–º, —Ä–µ–∞–∫—Ü–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∞–±–µ–µ
          üí™ *–ù–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å* - –º–æ–∑–≥ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏, –∫–æ–≥–¥–∞ –≤—ã –¥–µ–ª–∞–µ—Ç–µ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ
          üìà *–≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è* - –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º

          *–ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç—Ä–∞—Ö –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?*
          –≠—Ç–æ –Ω–µ –≤—Ä–∞–≥, –∞ —Å–∏—Å—Ç–µ–º–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è. 
          –ù–æ –∫–∞–∫ GPS, –∫–æ—Ç–æ—Ä—ã–π –∫—Ä–∏—á–∏—Ç "–û–ø–∞—Å–Ω–æ—Å—Ç—å!" –Ω–∞ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ - –∏–Ω–æ–≥–¥–∞ –µ–≥–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å.

          *–°–µ–≥–æ–¥–Ω—è –º—ã –Ω–∞—É—á–∏–º—Å—è:*
          1. –û–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å–≤–æ–∏ —Å—Ç—Ä–∞—Ö–∏
          2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å  
          3. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏
          4. –î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö
          5. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

          *¬´–°–º–µ–ª–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–∞—Ö–∞, –∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ–≥–æ.¬ª*
        MARKDOWN
        
        send_message(text: message_text, parse_mode: 'Markdown')
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–∏—Ü–æ —Å–≤–æ–∏–º —Å—Ç—Ä–∞—Ö–∞–º?",
          reply_markup: day_20_start_exercise_markup
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        clear_day_data
        
        exercise_text = <<~MARKDOWN
          üéØ *–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: "–û–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥"* üéØ

          *–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –±–æ–ª—å—à–∏—Ö —Ü–µ–ª–µ–π?*

          **–ó–∞–∫–æ–Ω 1%:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 1% –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–∞–µ—Ç 37-–∫—Ä–∞—Ç–Ω—ã–π —Ä–æ—Å—Ç –∑–∞ –≥–æ–¥
          **–≠—Ñ—Ñ–µ–∫—Ç —Å–Ω–µ–∂–Ω–æ–≥–æ –∫–æ–º–∞:** –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ —Å–æ–∑–¥–∞—é—Ç –∏–º–ø—É–ª—å—Å
          **–ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—è:** –ú–æ–∑–≥ –ª–µ–≥—á–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∏–∫—Ä–æ-–∏–∑–º–µ–Ω–µ–Ω–∏—è

          *–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞:*
          ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≥–µ—Ä–æ–∏–∑–º–∞ - —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
          ‚úÖ –°–Ω–∏–∂–∞–µ—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ - –ª–µ–≥—á–µ –Ω–∞—á–∞—Ç—å
          ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ü–µ–ø–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é - –æ–¥–∏–Ω —à–∞–≥ –≤–µ–¥–µ—Ç –∫ –¥—Ä—É–≥–æ–º—É
          ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ —Å—Ç—Ä–∞—Ö–∞–º–∏ - –æ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö

          *–°–µ–≥–æ–¥–Ω—è –≤—ã:*
          1. –í—ã–±–µ—Ä–µ—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å—Ç—Ä–∞—Ö–∞
          2. –ù–∞–π–¥–µ—Ç–µ –º–∞–ª–µ–Ω—å–∫–æ–µ, –Ω–æ –∑–Ω–∞—á–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
          3. –°–ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
          4. –°–¥–µ–ª–∞–µ—Ç–µ –ø–µ—Ä–≤—ã–π —à–∞–≥
          5. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        MARKDOWN
        
        send_message(text: exercise_text, parse_mode: 'Markdown')
        
        # –ù–∞—á–∏–Ω–∞–µ–º —Å –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç—Ä–∞—Ö–∞
        choose_fear_category
      end
      
      def choose_fear_category
        store_day_data('current_step', 'choosing_category')
        
        message = <<~MARKDOWN
          üéØ *–®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å—Ç—Ä–∞—Ö–∞*

          *–í –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?*

          –ö–∞–∂–¥–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä—ã –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–≥–æ–¥–Ω—è.

          *–í–∞–∂–Ω–æ:* –í—ã–±–∏—Ä–∞–π—Ç–µ –Ω–µ —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å—Ç—Ä–∞—Ö, –∞ —Ç–æ—Ç, —Å –∫–æ—Ç–æ—Ä—ã–º –≥–æ—Ç–æ–≤—ã –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –°–ï–ì–û–î–ù–Ø.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
          reply_markup: fear_categories_markup
        )
      end
      
      def handle_category_selection(category_key)
        category = FEAR_CATEGORIES[category_key]
        store_day_data('fear_category', category_key)
        store_day_data('current_step', 'choosing_action')
        
        examples_text = category[:examples].map.with_index(1) do |example, index|
          "#{index}. #{example}"
        end.join("\n")
        
        message = <<~MARKDOWN
          #{category[:emoji]} *–í—ã –≤—ã–±—Ä–∞–ª–∏: #{category[:name]}*

          *–ü—Ä–∏–º–µ—Ä—ã –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤:*

          #{examples_text}

          *–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ:*
          üéØ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ** - —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è
          üí™ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–Ω–∞—á–∏–º–æ–µ** - —á—Ç–æ–±—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–±–µ–¥—É
          ‚è±Ô∏è **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ** - —á—Ç–æ–±—ã —á–µ—Ç–∫–æ –∑–Ω–∞—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å
          üîÑ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ** - —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –±—ã–ª–∏ –ø—Ä–∏–µ–º–ª–µ–º—ã–º–∏

          *–°–æ–≤–µ—Ç:* –õ—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –µ–≥–æ, —á–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–æ–π –∏ –Ω–µ –Ω–∞—á–∞—Ç—å.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ö–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ? (–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤)",
          reply_markup: back_to_categories_markup
        )
      end
      
      def handle_action_selection(action_text)
  Rails.logger.info "[Day20Service] handle_action_selection called with: #{action_text}"
  
  store_day_data('chosen_action', action_text)
  store_day_data('current_step', 'planning')
  
  message = <<~MARKDOWN
    üéâ *–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!*

    –í—ã –≤—ã–±—Ä–∞–ª–∏: **#{action_text}**

    *–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:*
    –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤—ã –¥–µ–ª–∞–µ—Ç–µ —á—Ç–æ-—Ç–æ, —á–µ–≥–æ –±–æ–∏—Ç–µ—Å—å, –≤—ã:
    ‚Ä¢ –ü–µ—Ä–µ–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É–µ—Ç–µ —Å–≤–æ–π –º–æ–∑–≥
    ‚Ä¢ –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç–µ —Å–≤–æ—é –∑–æ–Ω—É –∫–æ–º—Ñ–æ—Ä—Ç–∞
    ‚Ä¢ –°–æ–∑–¥–∞–µ—Ç–µ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç —É—Å–ø–µ—Ö–∞
    ‚Ä¢ –£–∫—Ä–µ–ø–ª—è–µ—Ç–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ

    *–°–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –≤—Ä–µ–º—è!*
    –°—Ç—Ä–∞—Ö –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç—å –≤–∞—Å. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
    –î–∞–≤–∞–π—Ç–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–º —ç—Ç–æ—Ç —Å—Ç—Ä–∞—Ö –≤ –ø–ª–∞–Ω.
  MARKDOWN
  
  send_message(text: message, parse_mode: 'Markdown')
  
  show_overcoming_steps
end
      
      def show_overcoming_steps
        store_day_data('current_step', 'learning_steps')
        
        message = "üìã *5 —à–∞–≥–æ–≤ –¥–ª—è –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–∞:*\n\n"
        
        FEAR_OVERCOMING_STEPS.each_with_index do |step, index|
          message += "#{step[:emoji]} *–®–∞–≥ #{index + 1}: #{step[:title]}*\n"
          message += "#{step[:description]}\n\n"
        end
        
        message += "*–î–∞–≤–∞–π—Ç–µ –ø—Ä–∏–º–µ–Ω–∏–º —ç—Ç–∏ —à–∞–≥–∏ –∫ –≤–∞—à–µ–º—É –¥–µ–π—Å—Ç–≤–∏—é!*"
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥?",
          reply_markup: start_planning_markup
        )
      end
      
      def start_planning
        store_day_data('current_step', 'step1_awareness')
        
        message = <<~MARKDOWN
          üéØ *–®–∞–≥ 1: –û—Å–æ–∑–Ω–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ö–∞*

          *–ó–∞–¥–∞–Ω–∏–µ:*
          –û–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ.
          
          *–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:*
          ‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –º–µ–Ω—è –ø—É–≥–∞–µ—Ç –≤ —ç—Ç–æ–º –¥–µ–π—Å—Ç–≤–∏–∏?
          ‚Ä¢ –ö–∞–∫–∏–µ –º—ã—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –≥–æ–ª–æ–≤—É, –∫–æ–≥–¥–∞ —è –¥—É–º–∞—é –æ–± —ç—Ç–æ–º?
          ‚Ä¢ –ö–∞–∫ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –º–æ–µ —Ç–µ–ª–æ? (—É—á–∞—â–µ–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ, –ø–æ—Ç–Ω—ã–µ –ª–∞–¥–æ–Ω–∏ –∏ —Ç.–¥.)
          ‚Ä¢ –ö–æ–≥–¥–∞ —ç—Ç–æ—Ç —Å—Ç—Ä–∞—Ö –ø–æ—è–≤–∏–ª—Å—è –≤–ø–µ—Ä–≤—ã–µ?

          *–í–∞–∂–Ω–æ:* –ù–µ –æ—Ü–µ–Ω–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–∞—Ö –∫–∞–∫ "–≥–ª—É–ø—ã–π" –∏–ª–∏ "–Ω–µ–≤–∞–∂–Ω—ã–π". 
          –ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –µ–≥–æ –∫–∞–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Å—Ç—Ä–∞—Ö:",
          reply_markup: skip_step_markup('awareness')
        )
      end
      
      def handle_awareness_input(text)
        store_day_data('awareness_description', text)
        store_day_data('current_step', 'step2_analysis')
        
        message = <<~MARKDOWN
          üß† *–®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ö–∞*

          *–¢–µ—Ö–Ω–∏–∫–∞ "–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞":*

          1. **–°–ø—Ä–æ—Å–∏—Ç–µ —Å–µ–±—è:**
             ‚Ä¢ *–ß—Ç–æ —Å–∞–º–æ–µ —Ö—É–¥—à–µ–µ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è?* (–±—É–¥—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã)
             ‚Ä¢ *–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ?* (–ø–æ —à–∫–∞–ª–µ –æ—Ç 1% –¥–æ 100%)
             ‚Ä¢ *–ö–∞–∫ —è —Å–ø—Ä–∞–≤–ª—é—Å—å, –µ—Å–ª–∏ —ç—Ç–æ —Å–ª—É—á–∏—Ç—Å—è?*

          2. **–¢–µ–ø–µ—Ä—å —Å–ø—Ä–æ—Å–∏—Ç–µ:**
             ‚Ä¢ *–ß—Ç–æ —Å–∞–º–æ–µ –ª—É—á—à–µ–µ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è?*
             ‚Ä¢ *–ß—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç?*
             ‚Ä¢ *–ß—Ç–æ —è –ø–æ–ª—É—á—É, –ø—Ä–µ–æ–¥–æ–ª–µ–≤ —ç—Ç–æ—Ç —Å—Ç—Ä–∞—Ö?*

          *–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:* –í 85% —Å–ª—É—á–∞–µ–≤ –Ω–∞—à–∏ —Å—Ç—Ä–∞—Ö–∏ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω—ã.
          –ú–æ–∑–≥ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞—Ç—å –æ–ø–∞—Å–Ω–æ—Å—Ç—å - —ç—Ç–æ –ø–æ–º–æ–≥–∞–ª–æ –≤—ã–∂–∏—Ç—å.
          –ù–æ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —á–∞—Å—Ç–æ –º–µ—à–∞–µ—Ç.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ —Å—Ç—Ä–∞—Ö–∞:",
          reply_markup: skip_step_markup('analysis')
        )
      end
      
      def handle_analysis_input(text)
        store_day_data('analysis_description', text)
        store_day_data('current_step', 'step3_planning')
        
        chosen_action = get_day_data('chosen_action')
        
        message = <<~MARKDOWN
          üìù *–®–∞–≥ 3: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è*

          *–¢–µ—Ö–Ω–∏–∫–∞ "–ú–∏–∫—Ä–æ-—à–∞–≥–∏":*
          –†–∞–∑–±–µ–π—Ç–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ **"#{chosen_action}"** –Ω–∞ —Å–∞–º—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —à–∞–≥–∏.

          *–ü—Ä–∏–º–µ—Ä –¥–ª—è "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–µ–∑–Ω–∞–∫–æ–º—Ü—É":*
          1. –ù–∞–π—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (1 –º–∏–Ω—É—Ç–∞)
          2. –ù–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ —Å–∫–∞–∂—É (2 –º–∏–Ω—É—Ç—ã)
          3. –°–¥–µ–ª–∞—Ç—å —Ç—Ä–∏ –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞ (30 —Å–µ–∫—É–Ω–¥)
          4. –ù–∞–±—Ä–∞—Ç—å –Ω–æ–º–µ—Ä (10 —Å–µ–∫—É–Ω–¥)
          5. –°–∫–∞–∑–∞—Ç—å "–ê–ª–ª–æ" (1 —Å–µ–∫—É–Ω–¥–∞)

          *–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*
          ‚Ä¢ –ú–æ–∑–≥ –Ω–µ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∏–∫—Ä–æ-—à–∞–≥–∏ –∫–∞–∫ —É–≥—Ä–æ–∑—É
          ‚Ä¢ –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–∞–µ—Ç —á—É–≤—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
          ‚Ä¢ –ò–º–ø—É–ª—å—Å –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç —Å –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º
          ‚Ä¢ –í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

          *–°–µ–∫—Ä–µ—Ç:* –ü–µ—Ä–≤—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–º, —á—Ç–æ –æ—Ç–∫–∞–∑ –æ—Ç –Ω–µ–≥–æ –±—É–¥–µ—Ç —Å–º–µ—à–Ω—ã–º.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–†–∞–∑–±–µ–π—Ç–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –º–∏–∫—Ä–æ-—à–∞–≥–∏:",
          reply_markup: skip_step_markup('planning')
        )
      end
      
      def handle_planning_input(text)
        store_day_data('planning_steps', text)
        store_day_data('current_step', 'step4_action')
        
        message = <<~MARKDOWN
          üöÄ *–®–∞–≥ 4: –î–µ–π—Å—Ç–≤–∏–µ*

          *–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç!*

          *–ü–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º:*
          1. –ù–∞–ø–æ–º–Ω–∏—Ç–µ —Å–µ–±–µ: **"–≠—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç"**
          2. –°–∫–∞–∂–∏—Ç–µ: **"–Ø –¥–µ–ª–∞—é —ç—Ç–æ –Ω–µ –ø–æ—Ç–æ–º—É, —á—Ç–æ –Ω–µ –±–æ—é—Å—å, –∞ —á—Ç–æ–±—ã –Ω–∞—É—á–∏—Ç—å—Å—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö"**
          3. –ü–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç - —ç—Ç–æ –º–∞–∫—Å–∏–º—É–º, —á—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
          4. –°–¥–µ–ª–∞–π—Ç–µ 3 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞

          *–í–æ –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è:*
          ‚Ä¢ –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –æ—â—É—â–µ–Ω–∏—è –≤ —Ç–µ–ª–µ
          ‚Ä¢ –ü–æ–º–Ω–∏—Ç–µ: –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç ‚â† –æ–ø–∞—Å–Ω–æ—Å—Ç—å
          ‚Ä¢ –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–∏–∫—Ä–æ-—à–∞–≥–µ

          *–ü–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å):*
          –í—ã —É–∂–µ –ø–æ–±–µ–¥–∏–ª–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, —Å–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –º–∏–∫—Ä–æ-—à–∞–≥:",
          reply_markup: action_completed_markup
        )
      end
      
      def handle_action_completed
        store_day_data('action_completed', true)
        store_day_data('current_step', 'step5_reflection')
        
        message = <<~MARKDOWN
          üí≠ *–®–∞–≥ 5: –†–µ—Ñ–ª–µ–∫—Å–∏—è*

          *–ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ - –≤—ã —Å–¥–µ–ª–∞–ª–∏ —ç—Ç–æ!*

          *–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:*
          1. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ? (—Ñ–∞–∫—Ç—ã, –±–µ–∑ –æ—Ü–µ–Ω–æ–∫)
          2. –ß–µ–º —ç—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≤–∞—à–∏—Ö –æ–∂–∏–¥–∞–Ω–∏–π?
          3. –ß—Ç–æ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–≤–æ–µ–º —Å—Ç—Ä–∞—Ö–µ?
          4. –ß—Ç–æ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–µ–±–µ?
          5. –ö–∞–∫–æ–π —Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞?

          *–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç:*
          –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤—ã –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö, –≤—ã:
          ‚Ä¢ –û—Å–ª–∞–±–ª—è–µ—Ç–µ —Å–≤—è–∑—å "—Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —Å—Ç—Ä–∞—Ö" –≤ –º–æ–∑–≥—É
          ‚Ä¢ –£–∫—Ä–µ–ø–ª—è–µ—Ç–µ —Å–≤—è–∑—å "—Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —è –º–æ–≥—É —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è"
          ‚Ä¢ –°–æ–∑–¥–∞–µ—Ç–µ –Ω–æ–≤—ã–π –æ–ø—ã—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–∞—Ö–∏
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–û–ø–∏—à–∏—Ç–µ –≤–∞—à –æ–ø—ã—Ç –∏ –≤—ã–≤–æ–¥—ã:",
          reply_markup: skip_reflection_markup
        )
      end
      
      def handle_reflection_input(text)
        store_day_data('reflection', text)
        
        show_success_summary
      end
      
      def show_success_summary
        chosen_action = get_day_data('chosen_action')
        category_key = get_day_data('fear_category')
        category = FEAR_CATEGORIES[category_key]
        
        message = <<~MARKDOWN
          üèÜ *–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –î–µ–Ω—å 20 –∑–∞–≤–µ—Ä—à–µ–Ω!* üèÜ

          *–ß—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è:*
          ‚úÖ –í—ã–±—Ä–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ: **#{chosen_action}**
          ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: **#{category[:name]}**
          ‚úÖ –ü—Ä–æ—à–ª–∏ 5 —à–∞–≥–æ–≤ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–∞
          ‚úÖ –°–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–≤—ã–π —à–∞–≥ (–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ!)
          ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –æ–ø—ã—Ç

          *–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –º–æ–∑–≥–∞:*
          üß† –í—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π –Ω–µ–π—Ä–æ–Ω–Ω—ã–π –ø—É—Ç—å
          üîÑ –í—ã –æ—Å–ª–∞–±–∏–ª–∏ —Å—Ç–∞—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é —Å—Ç—Ä–∞—Ö–∞
          üí™ –í—ã —É–∫—Ä–µ–ø–∏–ª–∏ "–º—ã—à—Ü—É —Å–º–µ–ª–æ—Å—Ç–∏"
          üå± –í—ã —Ä–∞—Å—à–∏—Ä–∏–ª–∏ —Å–≤–æ—é –∑–æ–Ω—É –∫–æ–º—Ñ–æ—Ä—Ç–∞

          *–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:*
          ‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –±—É–¥–µ—Ç –ª–µ–≥—á–µ
          ‚Ä¢ –î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞—Ö–∏ —Å—Ç–∞–Ω—É—Ç –º–µ–Ω–µ–µ intimidating
          ‚Ä¢ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ
          ‚Ä¢ –í—ã —Å—Ç–∞–Ω–µ—Ç–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–º —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏

          *¬´–°–º–µ–ª–æ—Å—Ç—å –ø–æ–¥–æ–±–Ω–∞ –º—ã—à—Ü–µ ‚Äî —á–µ–º –±–æ–ª—å—à–µ –µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.¬ª*
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        complete_exercise
      end
      
      def complete_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
        
        message = <<~MARKDOWN
          üéâ *–ò—Ç–æ–≥–∏ –¥–Ω—è 20*

          *–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã:*
          1. **–°—Ç—Ä–∞—Ö ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª, –∞ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ –∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ**
          2. **–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –ø–æ–±–µ–∂–¥–∞—é—Ç –±–æ–ª—å—à–∏–µ —Å—Ç—Ä–∞—Ö–∏**
          3. **–î–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É–µ—Ç –º–æ–∑–≥**
          4. **–î–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç ‚Äî —ç—Ç–æ —Ü–µ–Ω–∞ —Ä–æ—Å—Ç–∞**
          5. **–ö–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äî —ç—Ç–æ –ø–æ–±–µ–¥–∞**

          *–ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É:*
          üîÑ **–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ** - —Å–¥–µ–ª–∞–π—Ç–µ –ø—Ä–∏–≤—ã—á–∫–æ–π –¥–µ–ª–∞—Ç—å –æ–¥–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –¥–µ–ª–æ –≤ –Ω–µ–¥–µ–ª—é
          üìä **–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å** - –≤–µ–¥–∏—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø–æ–±–µ–¥
          ü§ù **–î–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º** - —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π—Ç–µ –æ —Å–≤–æ–∏—Ö –ø–æ–±–µ–¥–∞—Ö (—ç—Ç–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
          üéØ **–£—Å–ª–æ–∂–Ω—è–π—Ç–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** - –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å

          *–ü–æ–º–Ω–∏—Ç–µ:* –ù–µ–≤–∞–∂–Ω–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–º –±—ã–ª –≤–∞—à —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è.
          –í–∞–∂–Ω–æ, —á—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏ –µ–≥–æ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –¥–Ω—è 20
        show_fear_overcoming_menu
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        propose_next_day
      end
      
      def show_fear_overcoming_menu
        message = <<~MARKDOWN
          ü¶∏‚Äç‚ôÇÔ∏è *–ú–µ–Ω—é –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤* ü¶∏‚Äç‚ôÄÔ∏è

          *–ß—Ç–æ –¥–∞–ª—å—à–µ?*

          –í—ã –º–æ–∂–µ—Ç–µ:
          üí° **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–≤–µ—Ç—ã** - –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏
          üéØ **–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ** - –≤—ã–±—Ä–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω —Å—Ç—Ä–∞—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã
          üìä **–ú–æ–∏ –ø–æ–±–µ–¥—ã** - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –≤—ã —É–∂–µ –ø—Ä–µ–æ–¥–æ–ª–µ–ª–∏
          ‚û°Ô∏è **–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å** - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
          üè† **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é** - –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º

          *–°–æ–≤–µ—Ç –Ω–∞ –∑–∞–≤—Ç—Ä–∞:*
          –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –æ–¥–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –¥–µ–ª–æ –Ω–∞ –∑–∞–≤—Ç—Ä–∞.
          –ß–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –ø–ª–∞–Ω, —Ç–µ–º –≤—ã—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
          reply_markup: day_20_menu_markup
        )
      end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–û–í–û–ì–û –í–í–û–î–ê =====
      
      def handle_text_input(text)
  current_step = get_day_data('current_step')
  
  Rails.logger.info "[Day20Service] Handling text input: #{text}"
  Rails.logger.info "[Day20Service] Current step: #{current_step}"
Rails.logger.info "[Day20Service] Day data: #{@user.read_attribute(:self_help_program_data) || {}&.select { |k, v| k.start_with?('day_20') }}"  
  case current_step
  when 'choosing_action'
    Rails.logger.info "[Day20Service] Calling handle_action_selection"
    handle_action_selection(text)
  when 'step1_awareness'
    handle_awareness_input(text)
  when 'step2_analysis'
    handle_analysis_input(text)
  when 'step3_planning'
    handle_planning_input(text)
  when 'step5_reflection'
    handle_reflection_input(text)
  else
    Rails.logger.warn "[Day20Service] Unknown step: #{current_step}"
    log_warn("Day 20: Unknown step for text input: #{current_step}")
    send_message(text: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.")
  end
end
      
      # ===== –ú–ï–¢–û–î–´ –†–ê–ó–ú–ï–¢–ö–ò =====
      
      def day_20_start_exercise_markup
        {
          inline_keyboard: [
            [
              { text: "ü¶∏ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏", callback_data: 'start_day_20_exercise' }
            ]
          ]
        }.to_json
      end
      
      def fear_categories_markup
        buttons = FEAR_CATEGORIES.map do |key, category|
          emoji = case key
                  when 'social' then 'üë•'
                  when 'personal' then 'üåü'
                  when 'professional' then 'üíº'
                  when 'small_wins' then 'üéØ'
                  else 'üéØ'
                  end
          
          {
            text: "#{emoji} #{category[:name]}",
            callback_data: "day_20_category_#{key}"
          }
        end
        
        {
          inline_keyboard: buttons.each_slice(2).to_a
        }.to_json
      end
      
      def back_to_categories_markup
        {
          inline_keyboard: [
            [
              { text: "‚¨ÖÔ∏è –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é", callback_data: 'day_20_back_to_categories' }
            ]
          ]
        }.to_json
      end
      
      def start_planning_markup
        {
          inline_keyboard: [
            [
              { text: "‚úÖ –ù–∞—á–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data: 'day_20_start_planning' }
            ]
          ]
        }.to_json
      end
      
      def skip_step_markup(step_name)
        {
          inline_keyboard: [
            [
              { text: "‚û°Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥", callback_data: "day_20_skip_#{step_name}" }
            ]
          ]
        }.to_json
      end
      
      def action_completed_markup
        {
          inline_keyboard: [
            [
              { text: "‚úÖ –Ø —Å–¥–µ–ª–∞–ª(–∞) –ø–µ—Ä–≤—ã–π —à–∞–≥!", callback_data: 'day_20_action_completed' }
            ],
            [
              { text: "üîÑ –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º", callback_data: 'day_20_need_help' }
            ]
          ]
        }.to_json
      end
      
      def skip_reflection_markup
        {
          inline_keyboard: [
            [
              { text: "‚û°Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é", callback_data: 'day_20_skip_reflection' }
            ]
          ]
        }.to_json
      end
      
      def day_20_menu_markup
        {
          inline_keyboard: [
            [
              { text: "üí° –°–æ–≤–µ—Ç—ã", callback_data: 'view_fear_tips' },
              { text: "üìä –ú–æ–∏ –ø–æ–±–µ–¥—ã", callback_data: 'view_fear_victories' }
            ],
            [
              { text: "üéØ –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ", callback_data: 'start_day_20_exercise' }
            ],
            [
              { text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data: 'back_to_main_menu' },
              { text: "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å", callback_data: 'start_day_21_from_proposal' }
            ]
          ]
        }.to_json
      end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö =====
      
      def handle_button(callback_data)
        case callback_data
        when /^day_20_category_(.+)$/
          category_key = $1
          handle_category_selection(category_key)
          
        when 'day_20_back_to_categories'
          choose_fear_category
          
        when 'day_20_start_planning'
          start_planning
          
        when /^day_20_skip_(.+)$/
          step_name = $1
          handle_skipped_step(step_name)
          
        when 'day_20_action_completed'
          handle_action_completed
          
        when 'day_20_need_help'
          provide_first_step_help
          
        when 'day_20_skip_reflection'
          show_success_summary
          
        when 'view_fear_tips'
          show_fear_tips
          
        when 'view_fear_victories'
          show_fear_victories
          
        when 'back_to_day_20_menu'
          show_fear_overcoming_menu
        end
      end
      
      def handle_skipped_step(step_name)
        case step_name
        when 'awareness'
          store_day_data('awareness_description', '–ü—Ä–æ–ø—É—â–µ–Ω–æ')
          handle_awareness_input('')
        when 'analysis'
          store_day_data('analysis_description', '–ü—Ä–æ–ø—É—â–µ–Ω–æ')
          handle_analysis_input('')
        when 'planning'
          store_day_data('planning_steps', '–ü—Ä–æ–ø—É—â–µ–Ω–æ')
          handle_planning_input('')
        end
      end
      
      def provide_first_step_help
        chosen_action = get_day_data('chosen_action')
        
        message = <<~MARKDOWN
          üÜò *–ü–æ–º–æ—â—å —Å –ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º*

          *–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è: "#{chosen_action}"*

          *–¢–µ—Ö–Ω–∏–∫–∞ "–°–≤–µ—Ä—Ö-–º–∞–ª–µ–Ω—å–∫–∏–π –ø–µ—Ä–≤—ã–π —à–∞–≥":*

          1. **–°–¥–µ–ª–∞–π—Ç–µ —à–∞–≥ –µ—â–µ –º–µ–Ω—å—à–µ** - –µ—Å–ª–∏ –∑–≤–æ–Ω–∏—Ç—å —Å—Ç—Ä–∞—à–Ω–æ, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ –Ω–∞–π–¥–∏—Ç–µ –Ω–æ–º–µ—Ä
          2. **–ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç** - –µ—Å–ª–∏ —Å—Ç—Ä–∞—à–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö, —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç
          3. **–ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä–µ–º—è** - –µ—Å–ª–∏ —Å—Ç—Ä–∞—à–Ω–æ —Å–µ–π—á–∞—Å, –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º
          4. **–ò–∑–º–µ–Ω–∏—Ç–µ –º–µ—Å—Ç–æ** - –µ—Å–ª–∏ —Å—Ç—Ä–∞—à–Ω–æ –≤ –æ—Ñ–∏—Å–µ, —Å–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –≤ –∫–∞—Ñ–µ
          5. **–°–¥–µ–ª–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ** - –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å

          *–ü—Ä–∏–º–µ—Ä —Å–≤–µ—Ä—Ö-–º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤:*
          ‚Ä¢ –ù–µ "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", –∞ "–≤–∑—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ä—É–∫—É"
          ‚Ä¢ –ù–µ "–≤—ã—Å—Ç—É–ø–∏—Ç—å", –∞ "–Ω–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å–ª–∞–π–¥"
          ‚Ä¢ –ù–µ "–ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è", –∞ "—É–ª—ã–±–Ω—É—Ç—å—Å—è –Ω–µ–∑–Ω–∞–∫–æ–º—Ü—É"
          ‚Ä¢ –ù–µ "—Å–∫–∞–∑–∞—Ç—å –Ω–µ—Ç", –∞ "—Å–∫–∞–∑–∞—Ç—å '–º–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å'"

          *–°–µ–∫—Ä–µ—Ç:* –°–∞–º—ã–π –ø–µ—Ä–≤—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–º, —á—Ç–æ –µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ —Å–¥–µ–ª–∞—Ç—å.
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ö–∞–∫–æ–π —Å–≤–µ—Ä—Ö-–º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?",
          reply_markup: action_completed_markup
        )
      end
      
      def show_fear_tips
        tips = [
          "üéØ **–ù–∞—á–∏–Ω–∞–π—Ç–µ —Å —Å–∞–º–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ** - —É—Å–ø–µ—Ö –ø–æ—Ä–æ–∂–¥–∞–µ—Ç —É—Å–ø–µ—Ö",
          "üìÖ **–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ** - —Ä–µ—à–µ–Ω–∏–µ, –ø—Ä–∏–Ω—è—Ç–æ–µ –≤ —Å–ø–æ–∫–æ–π–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –ª–µ–≥—á–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å",
          "üèÉ‚Äç‚ôÄÔ∏è **–ù–µ –∂–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - —Å–º–µ–ª–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–µ–π—Å—Ç–≤–∏—è",
          "üìä **–í–µ–¥–∏—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ –ø–æ–±–µ–¥** - –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –∫–∞–∂–¥–æ–µ –º–∞–ª–µ–Ω—å–∫–æ–µ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ",
          "ü§ù **–ù–∞–π–¥–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É** - —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫–æ–º—É-—Ç–æ –æ —Å–≤–æ–∏—Ö –ø–ª–∞–Ω–∞—Ö",
          "üîÑ **–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ —É—Å–ø–µ—à–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è** - –∑–∞–∫—Ä–µ–ø–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏",
          "üé≠ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ–ª—å** - –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –∞–∫—Ç–µ—Ä, –∏–≥—Ä–∞—é—â–∏–π —Å–º–µ–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞",
          "‚è±Ô∏è **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã** - '—è –±—É–¥—É –±–æ—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ 5 –º–∏–Ω—É—Ç, –∞ –ø–æ—Ç–æ–º –¥–µ–π—Å—Ç–≤—É—é'"
        ]
        
        message = "üí° *–°–æ–≤–µ—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏:*\n\n"
        message += tips.sample(4).join("\n\n")
        
        send_message(text: message, parse_mode: 'Markdown')
      end
      
      def show_fear_victories
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–±–µ–¥—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          victories = @user.read_attribute(:self_help_program_data) || {}&.select { |k, v| k.start_with?('day_20_') && v.present? }        
        if victories && victories.any?
          message = "üèÜ *–í–∞—à–∏ –ø–æ–±–µ–¥—ã –Ω–∞–¥ —Å—Ç—Ä–∞—Ö–∞–º–∏:*\n\n"
          
          if victories['chosen_action']
            message += "üéØ *–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:* #{victories['chosen_action']}\n"
          end
          
          if victories['fear_category']
            category = FEAR_CATEGORIES[victories['fear_category']]
            message += "üìÅ *–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* #{category[:name]}\n"
          end
          
          if victories['action_completed']
            message += "‚úÖ *–°—Ç–∞—Ç—É—Å:* –ü–µ—Ä–≤—ã–π —à–∞–≥ —Å–¥–µ–ª–∞–Ω!\n"
          end
          
          message += "\n*–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!*\n"
          message += "–ö–∞–∂–¥–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ –¥–µ–ª–∞–µ—Ç –≤–∞—Å —Å–∏–ª—å–Ω–µ–µ."
        else
          message = <<~MARKDOWN
            üì≠ *–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–æ–±–µ–¥–∞—Ö –Ω–∞–¥ —Å—Ç—Ä–∞—Ö–∞–º–∏.*
            
            –ù–∞—á–Ω–∏—Ç–µ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–Ω—è 20!
            
            –ü–æ–º–Ω–∏—Ç–µ: –¥–∞–∂–µ —Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –Ω–∞–≤—Å—Ç—Ä–µ—á—É —Å—Ç—Ä–∞—Ö—É - —ç—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞.
          MARKDOWN
        end
        
        send_message(text: message, parse_mode: 'Markdown')
      end
      
      private
      
      def should_deliver_exercise_immediately?
        false
      end
      
      def log_warn(message)
        Rails.logger.warn "[#{self.class}] #{message} - User: #{@user.telegram_id}"
      end

      
    end
  end
end