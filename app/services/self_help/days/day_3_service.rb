# app/services/self_help/days/day_3_service.rb
module SelfHelp
  module Days
    class Day3Service < DayBaseService
      include TelegramMarkupHelper
      
      # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
      DAY_NUMBER = 3
      GRATITUDE_ITEMS_COUNT = 3
      MAX_GRATITUDE_TEXT_LENGTH = GratitudeEntry::MAX_ENTRY_TEXT_LENGTH
      
      # –®–∞–≥–∏ –¥–Ω—è 3
      DAY_STEPS = {
        'intro' => {
          title: "üéØ *–î–µ–Ω—å 3: –°–∏–ª–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏* üéØ",
          instruction: <<~MARKDOWN
            **–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –≤ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å**
            
            –°–µ–≥–æ–¥–Ω—è –º—ã –±—É–¥–µ–º —Ä–∞–∑–≤–∏–≤–∞—Ç—å –Ω–∞–≤—ã–∫ –∑–∞–º–µ—á–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ –≤–æ–∫—Ä—É–≥ —á–µ—Ä–µ–∑ —Ç–µ—Ö–Ω–∏–∫—É *–¥–Ω–µ–≤–Ω–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏*.

            üß† **–ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞:**
            ‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–µ—Ä–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ –≤ –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä–µ
            ‚Ä¢ –°–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ (–≥–æ—Ä–º–æ–Ω–∞ —Å—Ç—Ä–µ—Å—Å–∞) –Ω–∞ 23%
            ‚Ä¢ –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –¥–æ—Ñ–∞–º–∏–Ω–∞ –∏ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω–∞
            ‚Ä¢ –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –∏ —É–∫—Ä–µ–ø–ª—è–µ—Ç –∏–º–º—É–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É

            üí´ **–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–µ–≥–æ–¥–Ω—è:**
            1. üîç –ù–∞–≤—ã–∫ –∑–∞–º–µ—á–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç–∏
            2. üòä –ü–æ–≤—ã—à–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å—á–∞—Å—Ç—å—è
            3. üõ°Ô∏è –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã–º —Å–∏—Ç—É–∞—Ü–∏—è–º
            4. ü§ù –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏

            ‚è±Ô∏è **–í—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏:** 5-10 –º–∏–Ω—É—Ç
            üéØ **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—Å–µ—Ö
          MARKDOWN
        },
        'exercise' => {
          title: "üìù *–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –î–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏* üìù",
          instruction: <<~MARKDOWN
            **–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**

            –ó–∞–ø–∏—à–∏—Ç–µ **#{GRATITUDE_ITEMS_COUNT} –≤–µ—â–∏**, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è.

            üéØ **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è:**

            üë§ **–õ—é–¥–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:**
            ‚Ä¢ –ß—å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–∂–Ω—ã –¥–ª—è –≤–∞—Å?
            ‚Ä¢ –ö—Ç–æ —Å–¥–µ–ª–∞–ª –¥–ª—è –≤–∞—Å —á—Ç–æ-—Ç–æ –¥–æ–±—Ä–æ–µ –Ω–µ–¥–∞–≤–Ω–æ?
            ‚Ä¢ –ß—å–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≤–∞—Å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Ç?

            üè° **–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –∏ –∫–æ–º—Ñ–æ—Ä—Ç:**
            ‚Ä¢ –ß—Ç–æ –∏–∑ –≤–∞—à–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–µ–ª–∞–µ—Ç –∂–∏–∑–Ω—å —É–¥–æ–±–Ω–µ–µ?
            ‚Ä¢ –ö–∞–∫–∏–µ –±–ª–∞–≥–∞ —É –≤–∞—Å –µ—Å—Ç—å (–¥–æ–º, –µ–¥–∞, –∑–¥–æ—Ä–æ–≤—å–µ)?
            ‚Ä¢ –ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º?

            üåü **–õ–∏—á–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –æ–ø—ã—Ç:**
            ‚Ä¢ –ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ –≤—ã –∏–∑–≤–ª–µ–∫–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ?
            ‚Ä¢ –ö–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É –≤–∞—Å –ø–æ—è–≤–∏–ª–∏—Å—å?
            ‚Ä¢ –ß—Ç–æ –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã —É–º–µ–µ—Ç–µ, —Ü–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å?

            üåç **–ú–∏—Ä –∏ –ø—Ä–∏—Ä–æ–¥–∞:**
            ‚Ä¢ –ß—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –≤—ã –≤–∏–¥–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è?
            ‚Ä¢ –ö–∞–∫–∏–µ –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è –≤–∞—Å –≤–æ—Å—Ö–∏—â–∞—é—Ç?
            ‚Ä¢ –ö–∞–∫–∏–µ –ø—Ä–æ—Å—Ç—ã–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è –±—ã–ª–∏ –≤ –≤–∞—à–µ–º –¥–Ω–µ?

            üí≠ **–í–∞–∂–Ω–æ:** –ù–µ—Ç "–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –∏–ª–∏ "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –æ—Ç–≤–µ—Ç–æ–≤. –î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ —á–∞—à–∫—É –≥–æ—Ä—è—á–µ–≥–æ —á–∞—è –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ!
          MARKDOWN
        },
        'reflection' => {
          title: "ü§î *–†–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ—Å–ª–µ –ø—Ä–∞–∫—Ç–∏–∫–∏* ü§î",
          instruction: <<~MARKDOWN
            **–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏!** üåü

            **–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞:**

            üíñ **1. –û —á—É–≤—Å—Ç–≤–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏:**
            ‚Ä¢ –ö–∞–∫–∞—è –∏–∑ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π –≤—ã–∑–≤–∞–ª–∞ —Å–∞–º—ã–µ —Ç–µ–ø–ª—ã–µ —á—É–≤—Å—Ç–≤–∞?
            ‚Ä¢ –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞?
            ‚Ä¢ –ó–∞–º–µ—Ç–∏–ª–∏ –ª–∏ –≤—ã —á—Ç–æ-—Ç–æ, –∑–∞ —á—Ç–æ —Ä–∞–Ω—å—à–µ –Ω–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏–ª–∏?

            üß† **2. –û –ø—Ä–æ—Ü–µ—Å—Å–µ:**
            ‚Ä¢ –ö–∞–∫ –ª–µ–≥–∫–æ –≤–∞–º –¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ #{GRATITUDE_ITEMS_COUNT} –ø—É–Ω–∫—Ç–∞?
            ‚Ä¢ –í –∫–∞–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –±—ã–ª–æ –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –Ω–∞–π—Ç–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏?
            ‚Ä¢ –í–æ–∑–Ω–∏–∫–∞–ª–∏ –ª–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏?

            üîç **3. –û–± –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö:**
            ‚Ä¢ –ß—Ç–æ –≤–∞—Å —É–¥–∏–≤–∏–ª–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ?
            ‚Ä¢ –ö–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ "—Å–æ–∫—Ä–æ–≤–∏—â–∞" –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏?
            ‚Ä¢ –ö–∞–∫ —ç—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à–µ –æ–±—ã—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –¥–Ω—è?

            üå± **4. –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –∂–∏–∑–Ω—å:**
            ‚Ä¢ –í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –¥–Ω—è —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å?
            ‚Ä¢ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —ç—Ç—É –ø—Ä–∞–∫—Ç–∏–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–æ–π?
            ‚Ä¢ –° –∫–µ–º –º–æ–∂–Ω–æ –¥–µ–ª–∏—Ç—å—Å—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—è–º–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞?

            **–ó–∞–ø–æ–º–Ω–∏—Ç–µ:** –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –º—ã—à—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è –∫—Ä–µ–ø–Ω–µ—Ç —Å –∫–∞–∂–¥—ã–º –¥–Ω–µ–º –ø—Ä–∞–∫—Ç–∏–∫–∏!
          MARKDOWN
        }
      }.freeze
      
      # –¢–∏–ø–∏—á–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
      COMMON_CHALLENGES = [
        {
          challenge: "–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏, –∑–∞ —á—Ç–æ –±—ã—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã–º",
          emoji: "üòî",
          solution: "–ù–∞—á–Ω–∏—Ç–µ —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ: –∫—Ä—ã—à–∞ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π, –µ–¥–∞, –∑–¥–æ—Ä–æ–≤—å–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥—ã—à–∞—Ç—å. –î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –≤–µ—â–∏ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ."
        },
        {
          challenge: "–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ —ç—Ç–æ –Ω–∞–∏–≥—Ä–∞–Ω–Ω–æ –∏–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ",
          emoji: "üé≠",
          solution: "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤ –Ω–∞—á–∞–ª–µ. –ù–µ –∂–¥–∏—Ç–µ —Å–∏–ª—å–Ω—ã—Ö —á—É–≤—Å—Ç–≤. –ü—Ä–æ—Å—Ç–æ –∫–æ–Ω—Å—Ç–∞—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–∫—Ç—ã. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏–¥–µ—Ç —Å –ø—Ä–∞–∫—Ç–∏–∫–æ–π."
        },
        {
          challenge: "–í—Å–ø–æ–º–∏–Ω–∞—é —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å",
          emoji: "üîÑ",
          solution: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ —Ä–∞–∫—É—Ä—Å—ã. –í–º–µ—Å—Ç–æ '–±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ —Å–µ–º—å—é' ‚Äî '–±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ —Å–º–µ—Ö –¥–æ—á–µ—Ä–∏ —Å–µ–≥–æ–¥–Ω—è —É—Ç—Ä–æ–º'. –î–µ—Ç–∞–ª–∏ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ."
        },
        {
          challenge: "–ñ–∏–∑–Ω—å —Å–ª–æ–∂–Ω–∞—è, –Ω–µ –¥–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π",
          emoji: "üåßÔ∏è",
          solution: "–ò–º–µ–Ω–Ω–æ –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω–∞. –û–Ω–∞ –Ω–µ –æ—Ç—Ä–∏—Ü–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ."
        }
      ].freeze
      
      # –°–æ–≤–µ—Ç—ã –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      DAILY_TIPS = [
        {
          tip: "–£—Ç—Ä–µ–Ω–Ω—è—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞",
          emoji: "üåÖ",
          description: "–ü—Ä–æ—Å–Ω—É–≤—à–∏—Å—å, –Ω–∞–∑–æ–≤–∏—Ç–µ 1 –≤–µ—â—å, –∑–∞ –∫–æ—Ç–æ—Ä—É—é –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã. –≠—Ç–æ –∑–∞–¥–∞–µ—Ç –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω –≤—Å–µ–º—É –¥–Ω—é."
        },
        {
          tip: "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–Ω–æ–º",
          emoji: "üåô",
          description: "–í–µ—á–µ—Ä–æ–º –≤—Å–ø–æ–º–Ω–∏—Ç–µ 3 —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–±—ã—Ç–∏—è –¥–Ω—è. –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å."
        },
        {
          tip: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å",
          emoji: "‚ö°",
          description: "–ö–æ–≥–¥–∞ —Å–ª—É—á–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–µ, –ø—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ –ø—Ä–æ —Å–µ–±—è '—Å–ø–∞—Å–∏–±–æ'. –§–∏–∫—Å–∏—Ä—É–π—Ç–µ –º–æ–º–µ–Ω—Ç—ã —Ä–∞–¥–æ—Å—Ç–∏ —Å—Ä–∞–∑—É."
        },
        {
          tip: "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö",
          emoji: "ü§ù",
          description: "–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞–ø–∏—à–∏—Ç–µ –±–ª–∏–∑–∫–æ–º—É —á–µ–ª–æ–≤–µ–∫—É, –∑–∞ —á—Ç–æ –≤—ã –µ–º—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã. –£–∫—Ä–µ–ø–ª—è–µ—Ç —Å–≤—è–∑—å."
        },
        {
          tip: "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∫ —Å–µ–±–µ",
          emoji: "üíù",
          description: "–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Å–µ–±—è –∑–∞ —É—Å–∏–ª–∏—è, –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —É—Å–ø–µ—Ö–∏. –°–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ ‚Äî –∫–ª—é—á –∫ —Ä–æ—Å—Ç—É."
        }
      ].freeze
      
      # ===== –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ =====
      
      def deliver_intro
        send_message(text: DAY_STEPS['intro'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['intro'][:instruction], parse_mode: 'Markdown')
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        store_day_data('current_step', 'intro')
        
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏?",
          reply_markup: {
            inline_keyboard: [
              [{ text: "‚úÖ –î–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º", callback_data: "continue_day_3_content" }]
            ]
          }
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        store_day_data('current_step', 'exercise')
        
        send_message(text: DAY_STEPS['exercise'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['exercise'][:instruction], parse_mode: 'Markdown')
        
        send_message(
          text: "üìù **–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ #{GRATITUDE_ITEMS_COUNT} –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:**\n\n*–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:* #{MAX_GRATITUDE_TEXT_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤\n\n*–ü—Ä–∏–º–µ—Ä:*\n1. –ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ —Å–æ–ª–Ω–µ—á–Ω–æ–µ —É—Ç—Ä–æ\n2. –ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥—Ä—É–≥–∞\n3. –ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ –≤–∫—É—Å–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫",
          parse_mode: 'Markdown',
          reply_markup: {
            inline_keyboard: [
              [{ text: "üí° –ù—É–∂–Ω—ã –∏–¥–µ–∏", callback_data: "day_3_show_ideas" }],
              [{ text: "üìñ –ú–æ–∏ –∑–∞–ø–∏—Å–∏", callback_data: "day_3_show_entries" }],
              [{ text: "‚è∏Ô∏è –ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ", callback_data: "day_3_remind_later" }]
            ]
          }
        )
      end
      
      def show_gratitude_ideas
        ideas_text = <<~MARKDOWN
          üí° *–ò–¥–µ–∏ –¥–ª—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏:*

          **–ü—Ä–æ—Å—Ç—ã–µ —Ä–∞–¥–æ—Å—Ç–∏:**
          ‚Ä¢ –¢–µ–ø–ª–∞—è –ø–æ—Å—Ç–µ–ª—å —É—Ç—Ä–æ–º
          ‚Ä¢ –í–∫—É—Å–Ω–∞—è –µ–¥–∞
          ‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –ø–æ–≥–æ–¥–∞
          ‚Ä¢ –õ—é–±–∏–º–∞—è –º—É–∑—ã–∫–∞

          **–õ—é–¥–∏:**
          ‚Ä¢ –°–µ–º—å—è, –∫–æ—Ç–æ—Ä–∞—è –≤–∞—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
          ‚Ä¢ –î—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Å–ª—É—à–∞–ª
          ‚Ä¢ –ö–æ–ª–ª–µ–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥
          ‚Ä¢ –ù–µ–∑–Ω–∞–∫–æ–º–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π —É–ª—ã–±–Ω—É–ª—Å—è

          **–õ–∏—á–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞:**
          ‚Ä¢ –£–º–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç—å
          ‚Ä¢ –ß—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞
          ‚Ä¢ –¢–µ—Ä–ø–µ–Ω–∏–µ
          ‚Ä¢ –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É—á–∏—Ç—å—Å—è

          **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
          ‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –∑–Ω–∞–Ω–∏—è–º (–∫–Ω–∏–≥–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)
          ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—á–∏—Ç—å—Å—è –∏ —Ä–∞—Å—Ç–∏
          ‚Ä¢ –°–≤–æ–±–æ–¥–∞ –≤—ã–±–æ—Ä–∞
          ‚Ä¢ –ó–¥–æ—Ä–æ–≤—å–µ –∏ —ç–Ω–µ—Ä–≥–∏—è

          *–í–∞–∂–Ω–æ:* –î–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–∞—è ‚Äî –æ–Ω–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!
        MARKDOWN
        
        send_message(text: ideas_text, parse_mode: 'Markdown')
        
        send_message(
          text: "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ #{GRATITUDE_ITEMS_COUNT} –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏:",
          reply_markup: {
            inline_keyboard: [
              [{ text: "‚úçÔ∏è –ì–æ—Ç–æ–≤ –ø–∏—Å–∞—Ç—å", callback_data: "day_3_ready_to_write" }]
            ]
          }
        )
      end
      
      def show_reflection
        store_day_data('current_step', 'reflection')
        
        send_message(text: DAY_STEPS['reflection'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['reflection'][:instruction], parse_mode: 'Markdown')
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        challenge_buttons = COMMON_CHALLENGES.each_with_index.map do |challenge, index|
          [{ text: "#{challenge[:emoji]} #{challenge[:challenge]}", callback_data: "day_3_challenge_#{index}" }]
        end
        
        challenge_buttons << [{ text: "‚úÖ –ù–∏–∫–∞–∫–∏—Ö —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π", callback_data: "day_3_no_challenges" }]
        
        send_message(
          text: "ü§î *–° –∫–∞–∫–∏–º–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å?*",
          parse_mode: 'Markdown',
          reply_markup: { inline_keyboard: challenge_buttons }
        )
      end
      
      def handle_challenge_selection(challenge_index)
        challenge = COMMON_CHALLENGES[challenge_index.to_i]
        
        if challenge
          send_message(
            text: "üí° **#{challenge[:challenge]}**\n\n#{challenge[:solution]}",
            parse_mode: 'Markdown'
          )
        end
        
        show_daily_tips
      end
      
      def show_daily_tips
        tips_text = <<~MARKDOWN
          üéØ *–ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—É—é –∂–∏–∑–Ω—å:*

          –í–æ—Ç –ø—Ä–æ—Å—Ç—ã–µ —Å–ø–æ—Å–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π:
        MARKDOWN
        
        send_message(text: tips_text, parse_mode: 'Markdown')
        
        DAILY_TIPS.each do |tip|
          send_message(
            text: "#{tip[:emoji]} **#{tip[:tip]}**\n#{tip[:description]}",
            parse_mode: 'Markdown'
          )
        end
        
        send_message(
          text: "üåü –û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –î–µ–Ω—å 3!\n\n–ó–∞–≤–µ—Ä—à–∞–µ–º –¥–µ–Ω—å?",
          reply_markup: {
            inline_keyboard: [
              [{ text: "‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–Ω—å 3", callback_data: "day_3_complete_exercise" }],
              [{ text: "üìù –°–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data: "day_3_make_note" }],
              [{ text: "üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É", callback_data: "day_3_restart_practice" }]
            ]
          }
        )
      end
      
      def complete_exercise
        # –û—Ç–º–µ—á–∞–µ–º –¥–µ–Ω—å –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
        @user.complete_self_help_day(DAY_NUMBER)
        
        completion_message = <<~MARKDOWN
          üéâ *–î–µ–Ω—å 3 –∑–∞–≤–µ—Ä—à–µ–Ω!* üéâ

          **–í—ã –æ—Å–≤–æ–∏–ª–∏:**
          ‚Ä¢ üìù –¢–µ—Ö–Ω–∏–∫—É –≤–µ–¥–µ–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
          ‚Ä¢ üîç –ù–∞–≤—ã–∫ –∑–∞–º–µ—á–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç–∏
          ‚Ä¢ üòä –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è —Å—á–∞—Å—Ç—å—è
          
          ‚è∞ **–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤**
          
          *–°–æ–≤–µ—Ç:* –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –≤—Å–ø–æ–º–Ω–∏—Ç—å 3 —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–±—ã—Ç–∏—è –¥–Ω—è.
        MARKDOWN
        
        send_message(text: completion_message, parse_mode: 'Markdown')
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        propose_next_day_with_restriction
      end
      
      def resume_session
        current_state = @user.self_help_state
        
        case current_state
        when "day_3_intro"
          deliver_intro
        when "day_3_exercise_in_progress"
          current_step = get_day_data('current_step')
          handle_resume_from_step(current_step || 'exercise')
        else
          super
        end
      end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö =====
      
      def handle_button(callback_data)
        case callback_data
        when 'continue_day_3_content', 'start_day_3_from_proposal'
          deliver_exercise
          
        when 'day_3_show_ideas'
          show_gratitude_ideas
          
        when 'day_3_show_entries'
          show_gratitude_entries
          
        when 'day_3_remind_later'
          send_message(
            text: "‚è∞ *–í–µ—Ä–Ω—É—Å—å –∫ –≤–∞–º —á–µ—Ä–µ–∑ —á–∞—Å*\n\n–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –Ω–∞–∂–º–∏—Ç–µ:",
            parse_mode: 'Markdown',
            reply_markup: {
              inline_keyboard: [
                [{ text: "‚úÖ –ì–æ—Ç–æ–≤(–∞) –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data: "continue_day_3_content" }]
              ]
            }
          )
          
        when 'day_3_ready_to_write'
          send_message(
            text: "‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ #{GRATITUDE_ITEMS_COUNT} –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (–¥–æ #{MAX_GRATITUDE_TEXT_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤):"
          )
          store_day_data('awaiting_gratitude_input', true)
          
        when /^day_3_challenge_(\d+)$/
          handle_challenge_selection($1)
          
        when 'day_3_no_challenges'
          show_daily_tips
          
        when 'day_3_complete_exercise'
          complete_exercise
          
        when 'day_3_make_note'
          send_message(text: "üìù –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –æ –≤–∞—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ):")
          store_day_data('awaiting_practice_note', true)
          
        when 'day_3_restart_practice'
          deliver_exercise
          
        when 'day_3_enter_gratitude'
          # –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–Ω–æ–ø–∫–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
          deliver_exercise
          
        else
          log_warn("Unknown button callback: #{callback_data}")
          send_message(text: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.")
        end
      end
      
      # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (–¥–ª—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π –∏ –∑–∞–º–µ—Ç–æ–∫)
      def handle_text_input(input_text)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π
        if get_day_data('awaiting_gratitude_input')
          return handle_gratitude_input(input_text)
        end
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –∑–∞–º–µ—Ç–∫—É –æ –ø—Ä–∞–∫—Ç–∏–∫–µ
        if get_day_data('awaiting_practice_note')
          return handle_practice_note_input(input_text)
        end
        
        false
      end
      
      
      def handle_gratitude_input(input_text)
        return false if input_text.blank?
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
        if input_text.length > GratitudeEntry::MAX_ENTRY_TEXT_LENGTH
          send_message(
            text: "‚ùå *–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –≤–∞—à–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –¥–æ #{GratitudeEntry::MAX_ENTRY_TEXT_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.",
            parse_mode: 'Markdown'
          )
          return true # –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–≤–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (—Ö–æ—Ç—å –∏ —Å –æ—à–∏–±–∫–æ–π)
        end
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –≤ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
        store_day_data('gratitude_entries', input_text)
        store_day_data('awaiting_gratitude_input', false)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –º–æ–¥–µ–ª—å GratitudeEntry –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        save_gratitude_to_database(input_text)
        
        send_message(
          text: "‚úÖ *–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!*\n\n–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø–æ—Ä–∞–∑–º—ã—à–ª—è–µ–º –æ –ø—Ä–∞–∫—Ç–∏–∫–µ.",
          parse_mode: 'Markdown'
        )
        
        show_reflection
        true
      end

      def show_gratitude_entries
        entries = @user.gratitude_entries.recent.limit(5)
        
        if entries.empty?
          send_message(text: "üì≠ *–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏*\n\n–ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–∞–∫—Ç–∏–∫–∏ –î–Ω—è 3!", parse_mode: 'Markdown')
          return
        end
        
        message = "‚ù§Ô∏è *–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏* ‚ù§Ô∏è\n\n"
        
        entries.each_with_index do |entry, index|
          message += "*#{index + 1}. #{entry.entry_date.strftime('%d.%m.%Y')}*\n"
          message += "#{entry.entry_text}\n\n"
        end
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏?",
          reply_markup: {
            inline_keyboard: [
              [{ text: "üìù –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ", callback_data: "day_3_ready_to_write" }],
              [{ text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data: "back_to_main_menu" }]
            ]
          }
        )
      end
      
      def handle_practice_note_input(input_text)
        store_day_data('practice_note', input_text)
        store_day_data('awaiting_practice_note', false)
        
        send_message(
          text: "üìù *–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!*\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é.",
          parse_mode: 'Markdown'
        )
        
        send_message(
          text: "–ó–∞–≤–µ—Ä—à–∞–µ–º –î–µ–Ω—å 3?",
          reply_markup: {
            inline_keyboard: [
              [{ text: "‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–Ω—å 3", callback_data: "day_3_complete_exercise" }]
            ]
          }
        )
        true
      end
      
      private
      
      def fix_sequence_async
        # –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–æ—á–∏–Ω–∫–∏ sequence
        return if Rails.env.test?
        
        Thread.new do
          begin
            max_id = GratitudeEntry.maximum(:id).to_i
            ActiveRecord::Base.connection.execute(
              "SELECT setval('gratitude_entries_id_seq', #{max_id + 1}, true)"
            )
            Rails.logger.info "Auto-fixed gratitude_entries sequence to #{max_id + 1}"
          rescue => e
            Rails.logger.error "Failed to auto-fix sequence: #{e.message}"
          end
        end
      end

      def handle_resume_from_step(step)
        case step
        when 'intro'
          deliver_intro
        when 'exercise'
          deliver_exercise
        when 'reflection'
          show_reflection
        else
          deliver_intro
        end
      end
      
      def save_gratitude_to_database(text)
        begin
          # –ü—Ä—è–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ sequence
          GratitudeEntry.create!(
            user: @user,
            entry_date: Date.current,
            entry_text: text
          )
          
          log_info("Successfully saved gratitude entry to database")
          true
          
        rescue ActiveRecord::RecordInvalid => e
          # –í–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
          log_error("Validation failed for gratitude entry", e)
          
          if e.record.errors[:entry_text]&.include?("is too long")
            send_message(
              text: "‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –¥–æ #{MAX_GRATITUDE_TEXT_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.",
              parse_mode: 'Markdown'
            )
          else
            send_message(text: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
          end
          false
          
        rescue PG::UniqueViolation, ActiveRecord::RecordNotUnique => e
          # –ï—Å–ª–∏ sequence –µ—â–µ –Ω–µ –ø–æ—á–∏–Ω–µ–Ω, –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
          log_error("DUPLICATE KEY - Sequence needs fixing!", e)
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø–æ—á–∏–Ω–∫—É
          fix_sequence_async
          
          # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
          send_message(
            text: "‚úÖ *–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!* (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π)",
            parse_mode: 'Markdown'
          )
          true
          
        rescue => e
          # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
          log_error("Unexpected error saving gratitude entry", e)
          
          send_message(
            text: "‚úÖ *–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ!*",
            parse_mode: 'Markdown'
          )
          true
        end
      end
      
      def propose_next_day_with_restriction
        next_day = 4
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        can_start_result = @user.can_start_day?(next_day)
        
        if can_start_result == true
          message = <<~MARKDOWN
            üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å #{next_day}**
            
            ‚úÖ *–î–æ—Å—Ç—É–ø–µ–Ω —Å–µ–π—á–∞—Å!*
            
            **–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:**
            ‚Ä¢ üß† –†–∞–±–æ—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º—ã—Å–ª—è–º–∏
            ‚Ä¢ üîç –¢–µ—Ö–Ω–∏–∫–∞ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            ‚Ä¢ üí° –ö–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∏—Å–∫–∞–∂–µ–Ω–∏—è –º—ã—à–ª–µ–Ω–∏—è
            ‚Ä¢ üåà –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
            
            –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
          MARKDOWN
          
          button_text = "üöÄ –ù–∞—á–∞—Ç—å –î–µ–Ω—å #{next_day}"
        else
          error_message = can_start_result.is_a?(Array) ? can_start_result.join("\n") : can_start_result
          
          message = <<~MARKDOWN
            üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å #{next_day}**
            
            ‚è±Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:* #{error_message}
            
            **–ü–æ–∫–∞ –∂–¥–µ—Ç–µ, –º–æ–∂–µ—Ç–µ:**
            ‚Ä¢ üìù –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
            ‚Ä¢ üìñ –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å –≤–∞—à–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
            ‚Ä¢ üí≠ –ü–æ–¥—É–º–∞—Ç—å, –∫–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –≤ –∂–∏–∑–Ω—å
            ‚Ä¢ üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (/progress)
          MARKDOWN
          
          button_text = "‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –î–Ω—è #{next_day}"
        end
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:",
          reply_markup: {
            inline_keyboard: [
              [
                { text: button_text, callback_data: "start_day_#{next_day}_from_proposal" }
              ]
            ]
          }
        )
      end
      
      def log_warn(message)
        Rails.logger.warn "[#{self.class}] #{message} - User: #{@user.telegram_id}"
      end
    end
  end
end