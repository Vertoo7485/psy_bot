module SelfHelp
  module Days
    class Day10Service < DayBaseService
      include TelegramMarkupHelper
      
      # ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ ÐºÐ»Ð°ÑÑÐ°
      DAY_NUMBER = 10
      ENTRIES_LIMIT = 3
      EMOTION_DIARY_STEPS = %w[situation thoughts emotions behavior evidence_against new_thoughts].freeze
      
      def deliver_intro
        message_text = <<~MARKDOWN
          ðŸŽ¯ *Ð”ÐµÐ½ÑŒ 10: Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚* ðŸŽ¯

          **ÐŸÐ¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¹**

          Ð—Ð° 9 Ð´Ð½ÐµÐ¹ Ð²Ñ‹ Ð¾ÑÐ²Ð¾Ð¸Ð»Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ðº. Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ñ‹ Ð·Ð°ÐºÑ€ÐµÐ¿Ð¸Ð¼ Ð¸Ñ… Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð°Ð¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¸Ñ… Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹.

          **Ð”Ð½ÐµÐ²Ð½Ð¸Ðº ÑÐ¼Ð¾Ñ†Ð¸Ð¹** â€” ÑÑ‚Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±:
          â€¢ ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹
          â€¢ ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²ÑÐ·ÑŒ Ð¼Ñ‹ÑÐ»ÐµÐ¹ Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¹
          â€¢ Ð Ð°Ð·Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸
          â€¢ Ð—Ð°Ð¼ÐµÑ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
        MARKDOWN
        
        send_message(text: message_text, parse_mode: 'Markdown')
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        
        send_message(
          text: "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ¾Ð¼ ÑÐ¼Ð¾Ñ†Ð¸Ð¹?",
          reply_markup: TelegramMarkupHelper.day_10_start_exercise_markup
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        
        exercise_text = <<~MARKDOWN
          ðŸ“” *Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ: Ð”Ð½ÐµÐ²Ð½Ð¸Ðº ÑÐ¼Ð¾Ñ†Ð¸Ð¹* ðŸ“”

          **Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ:**

          Ð’ÑÐ¿Ð¾Ð¼Ð½Ð¸Ñ‚Ðµ Ð½ÐµÐ´Ð°Ð²Ð½ÑŽÑŽ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð²Ñ‹Ð·Ð²Ð°Ð»Ð° Ñƒ Ð²Ð°Ñ ÑÐ¸Ð»ÑŒÐ½ÑƒÑŽ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ€ÐµÐ°ÐºÑ†Ð¸ÑŽ (Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ñƒ, Ð³Ð½ÐµÐ², Ð³Ñ€ÑƒÑÑ‚ÑŒ, Ñ€Ð°Ð·Ð¾Ñ‡Ð°Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ñ‚.Ð´.).

          **Ð¨Ð°Ð³Ð¸ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°:**

          1. **Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ** â€” Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð¾?
          2. **ÐœÑ‹ÑÐ»Ð¸** â€” Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð´ÑƒÐ¼Ð°Ð»Ð¸ Ð² Ñ‚Ð¾Ñ‚ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚?
          3. **Ð­Ð¼Ð¾Ñ†Ð¸Ð¸** â€” Ñ‡Ñ‚Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð²Ð°Ð»Ð¸?
          4. **ÐŸÐ¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ** â€” ÐºÐ°Ðº Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð¸Ð»Ð¸?
          5. **ÐÐ½Ð°Ð»Ð¸Ð·** â€” ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð° Ð¿Ñ€Ð¾Ñ‚Ð¸Ð² Ð²Ð°ÑˆÐ¸Ñ… Ð¼Ñ‹ÑÐ»ÐµÐ¹?
          6. **ÐÐ¾Ð²Ñ‹Ðµ Ð¼Ñ‹ÑÐ»Ð¸** â€” ÐºÐ°Ðº Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ?

          **ÐŸÑ€Ð¸Ð¼ÐµÑ€:**
          Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ð» ÐºÑ€Ð¸Ñ‚Ð¸ÐºÑƒ Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ðµ
          ÐœÑ‹ÑÐ»Ð¸: Â«Ð¯ Ð½Ð¸ Ð½Ð° Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð³Ð¾Ð¶ÑƒÑÑŒÂ»
          Ð­Ð¼Ð¾Ñ†Ð¸Ð¸: Ð¡Ñ‚Ñ‹Ð´, Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð°
          ÐŸÐ¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ: Ð£ÑˆÐµÐ» Ð² ÑÐµÐ±Ñ, Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ Ð½Ðµ Ð¼Ð¾Ð³ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ
          ÐÐ½Ð°Ð»Ð¸Ð·: ÐšÑ€Ð¸Ñ‚Ð¸ÐºÐ° Ð±Ñ‹Ð»Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ Ð¾Ð´Ð½Ð¾Ð¼Ñƒ Ð°ÑÐ¿ÐµÐºÑ‚Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹, Ð½Ðµ Ð¿Ð¾ Ð¼Ð½Ðµ ÐºÐ°Ðº Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸
          ÐÐ¾Ð²Ñ‹Ðµ Ð¼Ñ‹ÑÐ»Ð¸: Ð¯ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð» Ð¾ÑˆÐ¸Ð±ÐºÑƒ, Ð½Ð¾ ÑÑ‚Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÑ‚ Ð¼ÐµÐ½Ñ Ð¿Ð»Ð¾Ñ…Ð¸Ð¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚Ð¾Ð¼
        MARKDOWN
        
        send_message(text: exercise_text, parse_mode: 'Markdown')
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº
        start_emotion_diary_for_day_10
      end
      
      # Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
      def start_emotion_diary_for_day_10
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
        @user.store_self_help_data('is_filling_emotion_diary', true)
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        clear_emotion_diary_temp_data
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³
        @user.store_self_help_data('emotion_diary_current_step', 'situation')
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³ Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹
        send_message_with_delay(text: "*Ð¨Ð°Ð³ 1: Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ*", parse_mode: 'Markdown')
        send_message_with_delay(
          text: "ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð²Ñ‹Ð·Ð²Ð°Ð»Ð° Ñƒ Ð²Ð°Ñ Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð°. Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð¾ Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ðµ, Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ Ð¶Ð¸Ð·Ð½Ð¸, Ð¸Ð»Ð¸ Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼Ñ‹ÑÐ»ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿Ñ€Ð¸ÑˆÐ»Ð° Ð² Ð³Ð¾Ð»Ð¾Ð²Ñƒ.\n\nÐ‘ÑƒÐ´ÑŒÑ‚Ðµ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹: ÐºÑ‚Ð¾, Ñ‡Ñ‚Ð¾, Ð³Ð´Ðµ, ÐºÐ¾Ð³Ð´Ð°.\n\nÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¯ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»(Ð°) Ð¾Ñ‚ÐºÐ°Ð· Ð½Ð° ÑÐ¾Ð±ÐµÑÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ð¸."
        )
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 1: Ð­Ñ‚Ð¾Ñ‚ Ð¼ÐµÑ‚Ð¾Ð´ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ ÐŸÐžÐ¡Ð›Ð• Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
      def complete_exercise_after_diary
        @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        show_emotion_diary_summary
        
        advice = <<~MARKDOWN
          ðŸ’¡ *Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° ÑÐ¼Ð¾Ñ†Ð¸Ð¹:*

          1. **Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ÑÑ‚ÑŒ** â€” Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐ¹Ñ‚Ðµ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ 1-2 Ñ€Ð°Ð·Ð° Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ
          2. **Ð§ÐµÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ** â€” Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ð¸ÑÐºÑ€ÐµÐ½Ð½Ð¸ Ñ ÑÐ¾Ð±Ð¾Ð¹
          3. **ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð²** â€” Ð¸Ñ‰Ð¸Ñ‚Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑŽÑ‰Ð¸ÐµÑÑ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸
          4. **ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°** â€” Ð¾Ñ‚Ð¼ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ€ÐµÐ°ÐºÑ†Ð¸ÑÑ…
          5. **Ð”Ð¾Ð±Ñ€Ð¾Ñ‚Ð° Ðº ÑÐµÐ±Ðµ** â€” Ð½Ðµ ÑÑƒÐ´Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¸

          Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð°Ð¼ Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ ÑÐµÐ±Ñ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸ÑÐ¼Ð¸.
        MARKDOWN
        
        send_message_with_delay(text: advice, parse_mode: 'Markdown')
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        clear_emotion_diary_temp_data
        
        # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 2: ÐÐ• Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ day_10_exercise_completed ÑÐ½Ð¾Ð²Ð°!
        # Ð’Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ
        propose_next_day
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 3: Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ complete_exercise Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚
      def complete_exercise
        # Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¶Ð°Ð» ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
        if @user.self_help_state == "day_#{DAY_NUMBER}_exercise_in_progress"
          # Ð­Ñ‚Ð¾ Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº ÐµÑ‰Ðµ Ð½Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½, Ð½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ
          # Ð¸Ð»Ð¸ Ñƒ Ð½ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸ÐµÐ¼
          complete_exercise_without_diary
        else
          # Ð˜Ð½Ð°Ñ‡Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ flow
          complete_exercise_after_diary
        end
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 4: ÐœÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
      def complete_exercise_without_diary
        @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
        
        message = <<~MARKDOWN
          âœ… *Ð”ÐµÐ½ÑŒ 10 Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!*

          Ð’Ñ‹ ÑƒÐ·Ð½Ð°Ð»Ð¸ Ð¾ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° ÑÐ¼Ð¾Ñ†Ð¸Ð¹. 
          Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð¿Ð¾Ð·Ð¶Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÐ½ÑŽ "Ð”Ð½ÐµÐ²Ð½Ð¸Ðº ÑÐ¼Ð¾Ñ†Ð¸Ð¹".
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        # ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ
        propose_next_day
      end
      
      def show_emotion_diary_entries
        entries = @user.emotion_diary_entries.recent.limit(ENTRIES_LIMIT)
        
        if entries.any?
          message = "ðŸ“š *Ð’Ð°ÑˆÐ¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ ÑÐ¼Ð¾Ñ†Ð¸Ð¹:*\n\n"
          
          entries.each_with_index do |entry, index|
            message += "*Ð—Ð°Ð¿Ð¸ÑÑŒ ##{index + 1}* (#{entry.date.strftime('%d.%m.%Y')})\n"
            message += "ðŸ’­ Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ: #{entry.situation.truncate(50)}\n"
            message += "ðŸ˜Š Ð­Ð¼Ð¾Ñ†Ð¸Ð¸: #{entry.emotions.truncate(30)}\n"
            message += "â”€" * 30 + "\n"
          end
          
          send_message(text: message, parse_mode: 'Markdown')
        else
          send_message(text: "Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ ÑÐ¼Ð¾Ñ†Ð¸Ð¹.")
        end
      end
      
      # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ
      def should_deliver_exercise_immediately?
        false
      end
      
      # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ñ
      def handle_exercise_consent
        deliver_exercise
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 5: ÐœÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð²Ð¾Ð´Ð° (Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°)
      def handle_text_input(text)
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð»Ð¸ Ð¼Ñ‹ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº
        if @user.get_self_help_data('is_filling_emotion_diary') == true
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ Ð½ÐµÐ¹Ð¼ÑÐ¿ÐµÐ¹ÑÐ¾Ð¼
          sequence_service = SelfHelp::Days::EmotionDiarySequenceService.new(@bot_service, @user, @chat_id)
          sequence_service.handle_answer(text)
        end
      end
      
      private
      
      def clear_emotion_diary_temp_data
        EMOTION_DIARY_STEPS.each do |step|
          @user.store_self_help_data("emotion_diary_#{step}", nil)
        end
        @user.store_self_help_data('emotion_diary_current_step', nil)
        @user.store_self_help_data('is_filling_emotion_diary', nil)
      end
      
      def send_message_with_delay(text:, reply_markup: nil, parse_mode: nil)
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
        sleep(0.3) if Rails.env.development? || Rails.env.test?
        send_message(text: text, reply_markup: reply_markup, parse_mode: parse_mode)
      end
      
      def show_emotion_diary_summary
        entries = @user.emotion_diary_entries.recent.limit(ENTRIES_LIMIT)
        
        if entries.any?
          message = "ðŸ“š *Ð’Ð°ÑˆÐ¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ ÑÐ¼Ð¾Ñ†Ð¸Ð¹:*\n\n"
          
          entries.each_with_index do |entry, index|
            message += "*Ð—Ð°Ð¿Ð¸ÑÑŒ ##{index + 1}* (#{entry.date.strftime('%d.%m.%Y')})\n"
            message += "ðŸ’­ Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ: #{entry.situation.truncate(50)}\n"
            message += "ðŸ˜Š Ð­Ð¼Ð¾Ñ†Ð¸Ð¸: #{entry.emotions.truncate(30)}\n"
            message += "â”€" * 30 + "\n"
          end
          
          send_message_with_delay(text: message, parse_mode: 'Markdown')
        end
      end
    end
  end
end