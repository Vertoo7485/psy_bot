# app/services/self_help/days/day_6_service.rb
module SelfHelp
  module Days
    class Day6Service < DayBaseService
      include TelegramMarkupHelper
      # ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹
      DAY_NUMBER = 6
      REST_DURATION_MINUTES = 30
      
      def deliver_intro
        message_text = <<~MARKDOWN
          ðŸŽ¯ *Ð”ÐµÐ½ÑŒ 6: Ð—Ð°Ð±Ð¾Ñ‚Ð° Ð¾ ÑÐµÐ±Ðµ* ðŸŽ¯

          **Ð’Ð°Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°**

          Ð’ Ð½Ð°ÑˆÐµÐ¹ ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ðµ Ñ‡Ð°ÑÑ‚Ð¾ Ñ†ÐµÐ½Ð¸Ñ‚ÑÑ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ, Ð½Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ… â€” ÑÑ‚Ð¾ Ð½Ðµ Ð»ÐµÐ½ÑŒ, Ð° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ. Ð‘ÐµÐ· ÐºÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð° Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ñ†ÐµÐ½Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð¸ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ñ‚ÑŒÑÑ.

          **Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ñ‹ ÑÐ¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡Ð¸Ð¼ÑÑ Ð½Ð°:**
          â€¢ Ð¡Ð¾Ð·Ð½Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ð¾Ñ‚Ð´Ñ‹Ñ…Ðµ
          â€¢ Ð”ÐµÐ»Ð°Ñ…, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½Ð¾ÑÑÑ‚ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸Ðµ
          â€¢ Ð£Ð¼ÐµÐ½Ð¸Ð¸ Ð½Ð°ÑÐ»Ð°Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¾Ð¼
          â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° Ð²Ð¸Ð½Ñ‹ Ð·Ð° Ð¾Ñ‚Ð´Ñ‹Ñ…
        MARKDOWN
        
        send_message(text: message_text, parse_mode: 'Markdown')
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        
        # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: ÐÑƒÐ¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
        send_message(
          text: "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð²Ñ‹Ð´ÐµÐ»Ð¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ ÑÐµÐ±Ñ?",
          reply_markup: day_6_exercise_consent_markup
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        
        exercise_text = <<~MARKDOWN
          ðŸ›‹ï¸ *Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ: Ð¡Ð¾Ð·Ð½Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð´Ñ‹Ñ…* ðŸ›‹ï¸

          **Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ:**

          Ð’Ñ‹Ð´ÐµÐ»Ð¸Ñ‚Ðµ **#{REST_DURATION_MINUTES} Ð¼Ð¸Ð½ÑƒÑ‚** Ð½Ð° Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð½Ð¾ÑÐ¸Ñ‚ Ð²Ð°Ð¼ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸Ðµ Ð¸ Ñ€Ð°ÑÑÐ»Ð°Ð±Ð»ÐµÐ½Ð¸Ðµ.

          **Ð˜Ð´ÐµÐ¸ Ð´Ð»Ñ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°:**

          ðŸŽ¬ **Ð Ð°ÑÑÐ»Ð°Ð±Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€**
          â€¢ Ð›ÑŽÐ±Ð¸Ð¼Ñ‹Ð¹ Ñ„Ð¸Ð»ÑŒÐ¼ Ð¸Ð»Ð¸ ÑÐµÑ€Ð¸Ð°Ð»
          â€¢ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¸Ð»ÑŒÐ¼
          â€¢ Ð®Ð¼Ð¾Ñ€Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑˆÐ¾Ñƒ

          ðŸ“š **Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸Ñ**
          â€¢ Ð˜Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð°Ñ ÐºÐ½Ð¸Ð³Ð°
          â€¢ Ð–ÑƒÑ€Ð½Ð°Ð»Ñ‹ Ð¸Ð»Ð¸ ÑÑ‚Ð°Ñ‚ÑŒÐ¸
          â€¢ ÐŸÐ¾ÑÐ·Ð¸Ñ

          ðŸŽµ **ÐœÑƒÐ·Ñ‹ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸**
          â€¢ Ð›ÑŽÐ±Ð¸Ð¼Ñ‹Ð¹ Ð°Ð»ÑŒÐ±Ð¾Ð¼
          â€¢ ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ Ð¼ÑƒÐ·Ñ‹ÐºÐ°
          â€¢ Ð—Ð²ÑƒÐºÐ¸ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ñ‹

          ðŸ›€ **Ð¡Ð¿Ð°-Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹ Ð´Ð¾Ð¼Ð°**
          â€¢ Ð¢ÐµÐ¿Ð»Ð°Ñ Ð²Ð°Ð½Ð½Ð°
          â€¢ ÐœÐ°ÑÐºÐ° Ð´Ð»Ñ Ð»Ð¸Ñ†Ð°
          â€¢ ÐÑ€Ð¾Ð¼Ð°Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ñ

          ðŸŽ¨ **Ð¢Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾**
          â€¢ Ð Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ
          â€¢ Ð Ð°ÑÐºÑ€Ð°ÑÐºÐ¸ Ð´Ð»Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ñ…
          â€¢ Ð ÑƒÐºÐ¾Ð´ÐµÐ»Ð¸Ðµ
        MARKDOWN
        
        send_message(text: exercise_text, parse_mode: 'Markdown')
        
        # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ
        send_message(
          text: <<~MARKDOWN,
            **Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:**
            1. Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
            2. ÐÐµ Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ
            3. ÐÐ°ÑÐ»Ð°Ð¶Ð´Ð°Ð¹Ñ‚ÐµÑÑŒ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¾Ð¼
            4. ÐÐµ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾ Ð²Ð¸Ð½Ñ‹

            ÐšÐ¾Ð³Ð´Ð° Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÐµÑ‚Ðµ, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ:
          MARKDOWN
          reply_markup: TelegramMarkupHelper.day_6_exercise_completed_markup
        )
      end
      
      def complete_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
        
        message = <<~MARKDOWN
          ðŸŒŸ *Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ â€” ÑÑ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾!* ðŸŒŸ

          Ð’Ñ‹ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ð²Ð°Ð¶Ð½Ñ‹Ð¹ ÑˆÐ°Ð³ Ð² Ð·Ð°Ð±Ð¾Ñ‚Ðµ Ð¾ ÑÐµÐ±Ðµ.

          **ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð¾Ñ‚Ð´Ñ‹Ñ… Ð²Ð°Ð¶ÐµÐ½:**
          â€¢ ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ñ‹Ð³Ð¾Ñ€Ð°Ð½Ð¸Ðµ
          â€¢ ÐŸÐ¾Ð²Ñ‹ÑˆÐ°ÐµÑ‚ ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
          â€¢ Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹
          â€¢ Ð£ÐºÑ€ÐµÐ¿Ð»ÑÐµÑ‚ Ð¸Ð¼Ð¼ÑƒÐ½Ð¸Ñ‚ÐµÑ‚

          **Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ð´Ð»Ñ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°:**
          â€¢ ÐŸÐ»Ð°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¾Ñ‚Ð´Ñ‹Ñ… Ð² Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ð¸
          â€¢ ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¸ ÑÐ¿Ð¾ÑÐ¾Ð±Ñ‹ Ñ€Ð°ÑÑÐ»Ð°Ð±Ð»ÐµÐ½Ð¸Ñ
          â€¢ Ð£Ð²Ð°Ð¶Ð°Ð¹Ñ‚Ðµ ÑÐ²Ð¾Ðµ Ð¿Ñ€Ð°Ð²Ð¾ Ð½Ð° Ð¾Ñ‚Ð´Ñ‹Ñ…
          â€¢ Ð£Ñ‡Ð¸Ñ‚ÐµÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸Ðµ Ð¾Ñ‚ Ð±ÐµÐ·Ð´ÐµÐ»ÑŒÑ
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        propose_next_day
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 1: ÐœÐµÐ½ÑÐµÐ¼ Ð½Ð° false, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ deliver_exercise Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
      def should_deliver_exercise_immediately?
        false
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 2: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      def handle_exercise_consent
        deliver_exercise
      end
      
      # Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ ÐµÐµ Ð½ÐµÑ‚ Ð² TelegramMarkupHelper)
      private
      
      def day_6_exercise_consent_markup
        {
          inline_keyboard: [
            [
              { text: "#{EMOJI[:check]} Ð”Ð°, Ð³Ð¾Ñ‚Ð¾Ð²(Ð°)!", callback_data: 'start_day_6_exercise' },
              { text: "#{EMOJI[:warning]} ÐÐµÑ‚, Ð¿Ð¾Ð·Ð¶Ðµ", callback_data: 'back_to_main_menu' }
            ]
          ]
        }.to_json
      end
    end
  end
end