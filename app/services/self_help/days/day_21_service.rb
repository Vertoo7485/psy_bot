# app/services/self_help/days/day21_service.rb

module SelfHelp
  module Days
    class Day21Service < DayBaseService
      include TelegramMarkupHelper
      
      # ===== –ö–û–ù–°–¢–ê–ù–¢–´ –î–ù–Ø 21 =====
      DAY_NUMBER = 21
      
      # –®–∞–≥–∏ –¥–Ω—è 21
      DAY_STEPS = {
        'intro' => {
          title: "üèÜ *–î–µ–Ω—å 21: –†–µ—Ñ–ª–µ–∫—Å–∏—è 3 –Ω–µ–¥–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏* üß†",
          instruction: <<~MARKDOWN
            **–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º 3 –Ω–µ–¥–µ–ª—å –ø—Ä–æ–≥—Ä–∞–º–º—ã!** üéâ

            **21 –¥–µ–Ω—å ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–∞—è –≤–µ—Ö–∞ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–≤—ã—á–µ–∫:**

            üìä **–ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ 21 –¥–Ω–µ:**
            ‚Ä¢ üß† **–ù–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å:** –ó–∞ 21 –¥–µ–Ω—å –º–æ–∑–≥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫
            ‚Ä¢ üìà **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:** –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º —Å —Ä–µ—Ñ–ª–µ–∫—Å–∏–µ–π –Ω–∞ 21-–π –¥–µ–Ω—å –Ω–∞ 40% —á–∞—â–µ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É
            ‚Ä¢ üí´ **–≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:** –¢—Ä–∏ –Ω–µ–¥–µ–ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –∏–º–ø—É–ª—å—Å –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            ‚Ä¢ üéØ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞:** –ü–æ—Å–ª–µ 21 –¥–Ω—è –Ω–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –º–µ–Ω—å—à–µ —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–∏–ª–∏–π

            **–í–∞—à –ø—É—Ç—å –∑–∞ 3 –Ω–µ–¥–µ–ª–∏:**
            ‚Ä¢ –ù–µ–¥–µ–ª—è 1: –û—Å–≤–æ–µ–Ω–∏–µ –æ—Å–Ω–æ–≤ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫
            ‚Ä¢ –ù–µ–¥–µ–ª—è 2: –†–∞–±–æ—Ç–∞ —Å –º—ã—à–ª–µ–Ω–∏–µ–º, –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–µ–π, —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ–º –∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ–º
            ‚Ä¢ –ù–µ–¥–µ–ª—è 3: –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–æ–≤, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π, –¥–æ–±—Ä–æ—Ç–∞ –∫ —Å–µ–±–µ –∏ –º–µ–¥–∏—Ç–∞—Ü–∏—è
            ‚Ä¢ üß† **21 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫** –∏ –ø—Ä–∞–∫—Ç–∏–∫ –æ—Å–≤–æ–µ–Ω–æ
            ‚Ä¢ üí™ **–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å** –≤ —Å–∞–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏ —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏

            **–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Ü–µ–ª—å:** –û—Å–æ–∑–Ω–∞—Ç—å –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å 3-–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–ø—ã—Ç, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—á–Ω—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.
          MARKDOWN
        },
        'exercise_explanation' => {
          title: "üìñ *–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –ì–ª—É–±–∏–Ω–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è 21 –¥–Ω—è* üí≠",
          instruction: <<~MARKDOWN
            **–ü–æ—á–µ–º—É —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –Ω–∞ 21 –¥–µ–Ω—å —Ç–∞–∫ –≤–∞–∂–Ω–∞?** üåü

            ‚Ä¢ üîÑ **–ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç:** –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç-—Å–∏—Å—Ç–µ–º—É –º–æ–∑–≥–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø—ã—Ç–∞ –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
            ‚Ä¢ üß† **–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –ø–æ–ª—å–∑–∞:** –£–∫—Ä–µ–ø–ª—è–µ—Ç –º–µ—Ç–∞–ø–æ–∑–Ω–∞–Ω–∏–µ ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –¥—É–º–∞—Ç—å –æ —Å–≤–æ–µ–º –º—ã—à–ª–µ–Ω–∏–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—É—á–µ–Ω–∏—è
            ‚Ä¢ üòå **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ü–æ–º–æ–≥–∞–µ—Ç –æ—Å–æ–∑–Ω–∞—Ç—å –∏ –∞—Å—Å–∏–º–∏–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–ø–µ–∫—Ç—Ä —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π
            ‚Ä¢ üéØ **–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–∞–∫—Ç–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –æ–ø—ã—Ç–∞
            ‚Ä¢ üå± **–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:** –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

            **¬´–ú—ã –Ω–µ —É—á–∏–º—Å—è –Ω–∞ –æ–ø—ã—Ç–µ. –ú—ã —É—á–∏–º—Å—è, —Ä–∞–∑–º—ã—à–ª—è—è –æ–± –æ–ø—ã—Ç–µ.¬ª** ‚Äî –î–∂–æ–Ω –î—å—é–∏

            **–°–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:** –ì–ª—É–±–∏–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ–≥–æ 3-–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞.
            –¶–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –∂–∏–∑–Ω—å.
          MARKDOWN
        }
      }.freeze
      
      # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –¥–ª—è 3 –Ω–µ–¥–µ–ª—å
      REFLECTION_CATEGORIES = [
        {
          id: 0,
          name: "–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
          emoji: "üåü",
          description: "–ö–∞–∫–∏–µ –≥–ª–∞–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ –≤–∞—Å –∑–∞ 3 –Ω–µ–¥–µ–ª–∏?",
          prompt: <<~PROMPT
            üåü *–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ 21 –¥–Ω—è:*

            ‚Ä¢ –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤–∞—à–µ **—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –≤ —Ü–µ–ª–æ–º?
            ‚Ä¢ –ß—Ç–æ —Å—Ç–∞–ª–æ –∏–Ω–∞—á–µ –≤ –≤–∞—à–µ–º **–º—ã—à–ª–µ–Ω–∏–∏ –∏ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–∏** —Å–µ–±—è?
            ‚Ä¢ –ö–∞–∫–∏–µ **–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏?
            ‚Ä¢ –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤–∞—à–µ **–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º –∏ –≤—ã–∑–æ–≤–∞–º**?

            *–ù–∞–ø–∏—à–∏—Ç–µ –æ –≥–ª–∞–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ –≤–∞—Å –∑–∞ 21 –¥–µ–Ω—å:* üìù
          PROMPT
        },
        {
          id: 1,
          name: "–ù–∞–∏–±–æ–ª–µ–µ —Ü–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏",
          emoji: "üíé",
          description: "–ö–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ç–∞–ª–∏ —Å–∞–º—ã–º–∏ –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∏ –ø–æ—á–µ–º—É?",
          prompt: <<~PROMPT
            üíé *–ù–∞–∏–±–æ–ª–µ–µ —Ü–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ 3 –Ω–µ–¥–µ–ª—å:*

            ‚Ä¢ –ö–∞–∫–∏–µ **2-3 —Ç–µ—Ö–Ω–∏–∫–∏** –æ–∫–∞–∑–∞–ª–∏—Å—å —Å–∞–º—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏ –ª–∏—á–Ω–æ –¥–ª—è –≤–∞—Å?
            ‚Ä¢ –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –æ–Ω–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –ª—É—á—à–µ –≤—Å–µ–≥–æ?
            ‚Ä¢ –ö–∞–∫ —ç—Ç–∏ —Ç–µ—Ö–Ω–∏–∫–∏ **–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –≤–∞—à—É –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å**?
            ‚Ä¢ –ß—Ç–æ –æ–Ω–∏ –¥–∞–ª–∏ –≤–∞–º –Ω–∞ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ** (—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, —è—Å–Ω–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—é)?

            *–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∞–º—ã–µ —Ü–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∏—Ö –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ:* üìù
          PROMPT
        },
        {
          id: 2,
          name: "–ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –æ —Å–µ–±–µ",
          emoji: "üîç",
          description: "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–µ–±–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ?",
          prompt: <<~PROMPT
            üîç *–ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –æ —Å–µ–±–µ:*

            ‚Ä¢ –ö–∞–∫–∏–µ **–ø–∞—Ç—Ç–µ—Ä–Ω—ã –º—ã—à–ª–µ–Ω–∏—è** –∏–ª–∏ **—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏** –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏?
            ‚Ä¢ –ö–∞–∫–∏–µ **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã** –∏ **—Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã** –æ—Ç–∫—Ä—ã–ª–∏ –≤ —Å–µ–±–µ?
            ‚Ä¢ –ß—Ç–æ —Å—Ç–∞–ª–æ —Å–∞–º—ã–º **–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –æ—Ç–∫—Ä—ã—Ç–∏–µ–º** –æ —Å–µ–±–µ?
            ‚Ä¢ –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤–∞—à–µ **–ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π**?

            *–ù–∞–ø–∏—à–∏—Ç–µ –æ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–µ–ª–∞–ª–∏ –æ —Å–µ–±–µ:* üìù
          PROMPT
        },
        {
          id: 3,
          name: "–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–Ω—ã–µ –±–∞—Ä—å–µ—Ä—ã",
          emoji: "üöÄ",
          description: "–ö–∞–∫–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –≤—ã –ø—Ä–µ–æ–¥–æ–ª–µ–ª–∏?",
          prompt: <<~PROMPT
            üöÄ *–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–Ω—ã–µ –±–∞—Ä—å–µ—Ä—ã –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è:*

            ‚Ä¢ –° –∫–∞–∫–∏–º–∏ **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è–º–∏** —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å (–ª–µ–Ω—å, —Å–æ–º–Ω–µ–Ω–∏—è, —Å—Ç—Ä–∞—Ö)?
            ‚Ä¢ –ö–∞–∫ **–∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ** –∫ —ç—Ç–∏–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è–º?
            ‚Ä¢ –ö–∞–∫–∏–µ **—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** –ø–æ–º–æ–≥–∞–ª–∏ –≤–∞–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã?
            ‚Ä¢ –ß—Ç–æ –≤—ã **—É–∑–Ω–∞–ª–∏ –æ —Å–≤–æ–µ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏** –∏ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏?

            *–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∞—Ä—å–µ—Ä—ã:* üìù
          PROMPT
        },
        {
          id: 4,
          name: "–ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –∂–∏–∑–Ω—å",
          emoji: "üó∫Ô∏è",
          description: "–ö–∞–∫ –≤—ã –±—É–¥–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏?",
          prompt: <<~PROMPT
            üó∫Ô∏è *–ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—É—é –∂–∏–∑–Ω—å:*

            ‚Ä¢ –ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –≤–æ–π–¥—É—Ç –≤ –≤–∞—à **–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–∏—Ç—É–∞–ª**?
            ‚Ä¢ –ö–∞–∫ –±—É–¥–µ—Ç–µ **–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å** –∏ **–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ—Ç–∫–∞—Ç—ã**?
            ‚Ä¢ –ö–∞–∫–∏–µ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏** —Å—Ç–∞–≤–∏—Ç–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 30/60/90 –¥–Ω–µ–π?
            ‚Ä¢ –ö–∞–∫ –±—É–¥–µ—Ç–µ **–æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å** –∏ **–æ—Ç–º–µ—á–∞—Ç—å** —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å?

            *–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∞–∫—Ç–∏–∫ –≤ –∂–∏–∑–Ω—å:* üìù
          PROMPT
        },
        {
          id: 5,
          name: "–¶–µ–ª–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è",
          emoji: "üéØ",
          description: "–ö—É–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ –≤ —Å–≤–æ–µ–º —Ä–∞–∑–≤–∏—Ç–∏–∏?",
          prompt: <<~PROMPT
            üéØ *–¶–µ–ª–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è:*

            ‚Ä¢ –í –∫–∞–∫–∏—Ö **–Ω–∞–≤—ã–∫–∞—Ö** —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ?
            ‚Ä¢ –ö–∞–∫–∏–µ **–æ–±–ª–∞—Å—Ç–∏ –∂–∏–∑–Ω–∏** —Ö–æ—Ç–∏—Ç–µ —É–ª—É—á—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫?
            ‚Ä¢ –ö–∞–∫–æ–π –≤—ã –≤–∏–¥–∏—Ç–µ —Å–µ–±—è —á–µ—Ä–µ–∑ **3-6 –º–µ—Å—è—Ü–µ–≤** —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏?
            ‚Ä¢ –ö–∞–∫–∏–µ **—Ä–µ—Å—É—Ä—Å—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞** –≤–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—É—Ç–∏?

            *–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ü–µ–ª–∏ –∏ –≤–∏–¥–µ–Ω–∏–µ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è:* üìù
          PROMPT
        }
      ].freeze
      
      # –¶–∏—Ç–∞—Ç—ã –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏
      MOTIVATIONAL_QUOTES = [
        "¬´21 –¥–µ–Ω—å ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–Ω–µ—Ü –ø—É—Ç–∏, –∞ –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–µ–µ.¬ª",
        "¬´–°–∞–º—ã–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ, –ø–æ–∫–∞ –æ–¥–Ω–∞–∂–¥—ã —Ç—ã –Ω–µ –æ—Å–æ–∑–Ω–∞–µ—à—å, —á—Ç–æ —Å—Ç–∞–ª –¥—Ä—É–≥–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º.¬ª",
        "¬´–¢–µ—Ä–ø–µ–Ω–∏–µ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π ‚Äî —ç—Ç–æ –≤—ã—Å—à–∞—è —Ñ–æ—Ä–º–∞ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è –∏ –º—É–¥—Ä–æ—Å—Ç–∏.¬ª",
        "¬´–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏, –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Å–æ–∑–¥–∞—é—Ç –±–æ–ª—å—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ–π—Ä–æ–Ω–∞—Ö –∏ –≤ –∂–∏–∑–Ω–∏.¬ª"
      ].freeze
      
      # ===== –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ =====
      
      def deliver_intro
        send_message(text: DAY_STEPS['intro'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['intro'][:instruction], parse_mode: 'Markdown')
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É 3 –Ω–µ–¥–µ–ª—å
        send_message(
          text: three_weeks_statistics_message,
          parse_mode: 'Markdown'
        )
        
        @user.set_self_help_step("day_#{DAY_NUMBER}_intro")
        store_day_data('current_step', 'intro')
        
        send_message(
          text: "–ì–æ—Ç–æ–≤—ã –∫ –≥–ª—É–±–∏–Ω–Ω–æ–π —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ 3 –Ω–µ–¥–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏?",
          reply_markup: day_21_content_markup
        )
      end
      
      def deliver_exercise
        @user.set_self_help_step("day_#{DAY_NUMBER}_exercise_in_progress")
        store_day_data('current_step', 'exercise_explanation')
        
        send_message(text: DAY_STEPS['exercise_explanation'][:title], parse_mode: 'Markdown')
        send_message(text: DAY_STEPS['exercise_explanation'][:instruction], parse_mode: 'Markdown')
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É
        send_message(
          text: "*#{MOTIVATIONAL_QUOTES.sample}*",
          parse_mode: 'Markdown'
        )
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
        init_reflection_process
      end
      
      def init_reflection_process
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
        store_day_data('reflection_progress', {
          current_category_index: 0,
          completed_categories: [],
          reflections: {},
          start_time: Time.current
        })
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        show_next_reflection_category
      end
      
      def show_next_reflection_category
        progress = get_reflection_progress
        current_index = progress[:current_category_index]
        
        if current_index >= REFLECTION_CATEGORIES.size
          # –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
          complete_reflection_process
          return
        end
        
        category = REFLECTION_CATEGORIES[current_index]
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        show_reflection_progress(current_index)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        send_message(
          text: category_prompt_with_progress(category, current_index),
          parse_mode: 'Markdown',
          reply_markup: day_21_category_options_markup(current_index)
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
        @user.set_self_help_step("day_#{DAY_NUMBER}_waiting_reflection_#{current_index}")
      end
      
      def handle_reflection_text(input_text, category_index)
  return false if input_text.blank?
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
  if input_text.length < 20
    send_message(
      text: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤).",
      parse_mode: 'Markdown'
    )
    return false
  end
  
  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
  progress = get_reflection_progress
  progress[:reflections][category_index.to_s] = {
    text: input_text,
    timestamp: Time.current,
    length: input_text.length,
    category_name: REFLECTION_CATEGORIES[category_index][:name]
  }
  
  # –û—Ç–º–µ—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
  progress[:completed_categories] << category_index unless progress[:completed_categories].include?(category_index)
  
  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  progress[:current_category_index] = category_index + 1
  
  save_reflection_progress(progress)
  
  # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  log_info("Saved reflection for category #{category_index}: #{input_text.truncate(50)}")
  log_info("Current progress: #{progress.inspect}")
  
  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  send_message(
    text: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! #{category_emoji(category_index)} –†–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *#{REFLECTION_CATEGORIES[category_index][:name]}* —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.",
    parse_mode: 'Markdown'
  )
  
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if progress[:current_category_index] < REFLECTION_CATEGORIES.size
    sleep(1) # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
    show_next_reflection_category
  else
    complete_reflection_process
  end
  
  true
end

def debug_reflection_data
  progress = get_reflection_progress
  
  message = "üîç *–û—Ç–ª–∞–¥–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*\n\n"
  message += "‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ: #{progress[:completed_categories].size}\n"
  message += "‚Ä¢ –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å: #{progress[:current_category_index]}\n"
  message += "‚Ä¢ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: #{progress[:start_time]}\n\n"
  
  if progress[:reflections].empty?
    message += "üì≠ *–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–π*\n"
  else
    message += "üìù *–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*\n"
    progress[:reflections].each do |cat_id, reflection|
      message += "‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è #{cat_id}: #{reflection[:text]&.truncate(30) || '–ø—É—Å—Ç–æ'}\n"
    end
  end
  
  send_message(text: message, parse_mode: 'Markdown')
end
      
      def skip_category(category_index)
        progress = get_reflection_progress
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        progress[:current_category_index] = category_index + 1
        save_reflection_progress(progress)
        
        send_message(
          text: "‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: #{category_emoji(category_index)} *#{REFLECTION_CATEGORIES[category_index][:name]}*",
          parse_mode: 'Markdown'
        )
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if progress[:current_category_index] < REFLECTION_CATEGORIES.size
          show_next_reflection_category
        else
          complete_reflection_process
        end
      end
      
      def complete_reflection_process
        progress = get_reflection_progress
        completed_count = progress[:completed_categories].size
        
        send_message(
          text: completion_summary_message(completed_count),
          parse_mode: 'Markdown'
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
        save_three_weeks_reflection_entry
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ–±–∑–æ—Ä
        show_reflection_preview
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–æ–ø—Ä–æ—Å–∞–º –æ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è—Ö
        sleep(2)
        show_reflection_challenges
      end
      
      def show_reflection_preview
        progress = get_reflection_progress
        
        if progress[:completed_categories].empty?
          send_message(
            text: "üì≠ –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.",
            parse_mode: 'Markdown'
          )
          return
        end
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        completed_categories = progress[:completed_categories].map do |idx|
          "#{REFLECTION_CATEGORIES[idx][:emoji]} #{REFLECTION_CATEGORIES[idx][:name]}"
        end
        
        send_message(
          text: "üìä *–û–±–∑–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:*\n\n#{completed_categories.join("\n")}",
          parse_mode: 'Markdown'
        )
      end
      
      def show_reflection_challenges
        send_message(
          text: "ü§î *–° –∫–∞–∫–∏–º–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ 3 –Ω–µ–¥–µ–ª—å?*",
          parse_mode: 'Markdown',
          reply_markup: day_21_challenges_markup
        )
      end
      
      def handle_challenge_selection(challenge_index)
        challenge_options = [
          "üß† –°–ª–æ–∂–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å –≤—Å–µ 3 –Ω–µ–¥–µ–ª–∏",
          "üòî –ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –º–æ–≥ –¥–æ—Å—Ç–∏—á—å –±–æ–ª—å—à–µ–≥–æ",
          "ü§î –ù–µ —É–≤–µ—Ä–µ–Ω(–∞), –∫–∞–∫ –æ—Ü–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å",
          "üò∞ –ë–µ—Å–ø–æ–∫–æ—é—Å—å –æ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π",
          "üåÄ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
        ]
        
        if challenge_index.to_i.between?(0, 4)
          solutions = [
            "–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π –∏ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –Ω–∞–∑–∞–¥. –í—Å–ø–æ–º–Ω–∏—Ç–µ 3-4 —Å–∞–º—ã—Ö —è—Ä–∫–∏—Ö –º–æ–º–µ–Ω—Ç–∞ ‚Äî —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Å–º—ã—Å–ª–µ–Ω–∏—è.",
            "–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —ç—Ç–æ –Ω–µ –≥–æ–Ω–∫–∞. –ö–∞–∂–¥—ã–π —à–∞–≥ –∏–º–µ–µ—Ç —Ü–µ–Ω–Ω–æ—Å—Ç—å. –û—Ç–º–µ—Ç—å—Ç–µ –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –æ–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç.",
            "–°—Ä–∞–≤–Ω–∏—Ç–µ —Å–µ–±—è —Å–µ–≥–æ–¥–Ω—è —Å —Å–æ–±–æ–π 3 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –≤–∞—à–∏—Ö —Ä–µ–∞–∫—Ü–∏—è—Ö, –º—ã—Å–ª—è—Ö, –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –≤—ã–±–æ—Ä–∞—Ö?",
            "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –≤—Ä–µ–º–µ–Ω–∏. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏: 1 —Ç–µ—Ö–Ω–∏–∫–∞ –≤ –¥–µ–Ω—å, 1 –æ—Ç–∑—ã–≤ –≤ –Ω–µ–¥–µ–ª—é.",
            "–§–æ–∫—É—Å –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ, –∞ –Ω–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ. –í—ã–±–µ—Ä–∏—Ç–µ 2-3 —Å–∞–º—ã–µ —Ü–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ —É–≥–ª—É–±–∏—Ç–µ –∏—Ö, –≤–º–µ—Å—Ç–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–≥–æ –æ—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö."
          ]
          
          send_message(
            text: "üåÄ **#{challenge_options[challenge_index.to_i]}**\n\nüí° *–†–µ—à–µ–Ω–∏–µ:* #{solutions[challenge_index.to_i]}",
            parse_mode: 'Markdown'
          )
        end
        
        send_message(
          text: "üåü –û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≥–ª—É–±–∏–Ω–Ω—É—é —Ä–µ—Ñ–ª–µ–∫—Å–∏—é 3 –Ω–µ–¥–µ–ª—å!\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–Ω—å 21 –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏?",
          reply_markup: day_21_final_completion_markup
        )
      end
      
      def complete_exercise
  progress = get_reflection_progress
  completed_count = progress[:completed_categories].size
  
  log_info("Completing exercise. Progress: #{progress.inspect}")
  log_info("Completed categories: #{completed_count}")
  log_info("Reflections: #{progress[:reflections].inspect}")
  
  # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É –≤—Å–µ—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–π
  total_length = progress[:reflections].values.sum { |r| r[:length].to_i }
  
  log_info("Total reflection length: #{total_length}")
  
  # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É –≤—Å–µ—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–π
  total_length = progress[:reflections].values.sum { |r| r[:length].to_i }
  
  # –û—Ç–º–µ—á–∞–µ–º –¥–µ–Ω—å –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ
  @user.complete_day_program(DAY_NUMBER)
  @user.complete_self_help_day(DAY_NUMBER)
  
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  @user.set_self_help_step("day_#{DAY_NUMBER}_completed")
  
  completion_message = <<~MARKDOWN
    üéä *–î–µ–Ω—å 21 –∏ –ø–µ—Ä–≤—ã–µ 3 –Ω–µ–¥–µ–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!* üéâ

    **–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ 21 –¥–µ–Ω—å:**

    üìä **–ò—Ç–æ–≥–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:**
    ‚Ä¢ ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: #{completed_count}/#{REFLECTION_CATEGORIES.size}
    ‚Ä¢ üìù –û–±—â–∏–π –æ–±—ä–µ–º: #{total_length} —Å–∏–º–≤–æ–ª–æ–≤ –≥–ª—É–±–∏–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    ‚Ä¢ üß† –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ: –ù–∞–≤—ã–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø—ã—Ç–∞
    
    üèÜ **–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ 3 –Ω–µ–¥–µ–ª–∏:**
    ‚Ä¢ ‚úÖ –û—Å–≤–æ–µ–Ω–æ 21+ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ —Å–∞–º–æ–ø–æ–º–æ—â–∏
    ‚Ä¢ üìà –†–∞–∑–≤–∏—Ç—ã –Ω–∞–≤—ã–∫–∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤
    ‚Ä¢ üí´ –°–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫
    ‚Ä¢ üå± –ü—Ä–æ—à–ª–∏ 75% –ø—Ä–æ–≥—Ä–∞–º–º—ã (21 –∏–∑ 28 –¥–Ω–µ–π)

    #{MOTIVATIONAL_QUOTES.sample}
  MARKDOWN
  
  send_message(text: completion_message, parse_mode: 'Markdown')
  
  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
  log_info("Calling save_final_reflection_entry from complete_exercise")
  save_final_reflection_entry
  
  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –¥–Ω—è 21
  show_three_weeks_menu
  
  # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
  sleep(2)
  propose_next_day_with_restriction
end
      
      def show_three_weeks_menu
        message = <<~MARKDOWN
          üìö *–ú–µ–Ω—é —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ 3 –Ω–µ–¥–µ–ª—å* üìö

          **–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å:**

          üìä **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:** –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∞—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞ 21 –¥–µ–Ω—å
          üí° **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
          üìñ **–ü–æ–ª–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è:** –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å –≤–∞—à–∏ –∏—Ç–æ–≥–∏ 3 –Ω–µ–¥–µ–ª—å
          üéØ **–û–±–∑–æ—Ä —Ç–µ—Ö–Ω–∏–∫:** –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∞–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
          üó∫Ô∏è **–ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤ –∂–∏–∑–Ω—å
          ‚û°Ô∏è **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:** –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –Ω–µ–¥–µ–ª–µ

          **–°–æ–≤–µ—Ç:** –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–π –≥–ª—É–±–æ–∫–æ–π —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ (—á–µ—Ä–µ–∑ 1-2 –º–µ—Å—è—Ü–∞).
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
          reply_markup: day_21_menu_markup
        )
      end
      
      # ===== –ú–ï–¢–û–î–´ –î–õ–Ø –ú–ï–ù–Æ =====
      
      def show_full_reflection
  progress = get_reflection_progress
  
  log_info("Showing full reflection. Progress keys: #{progress.keys}")
  log_info("Reflections count: #{progress[:reflections]&.size}")
  log_info("Reflections data: #{progress[:reflections].inspect}")
  
  if progress[:reflections].empty?
    send_message(text: "üì≠ *–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–π.*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é —á–µ—Ä–µ–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–Ω—è 21.")
    return
  end
  
  # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
  reflection_text = "üìñ *–ü–æ–ª–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è 21 –¥–Ω—è* üìÖ #{Date.current.strftime('%d.%m.%Y')}\n\n"
  
  REFLECTION_CATEGORIES.each do |category|
    # –ò—â–µ–º —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –ø–æ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    reflection_key = category[:id].to_s
    reflection = progress[:reflections][reflection_key]
    
    log_info("Processing category #{category[:id]}: key=#{reflection_key}, found=#{!!reflection}")
    
    reflection_text += "#{category[:emoji]} *#{category[:name]}:*\n"
    
    if reflection && reflection.is_a?(Hash) && reflection[:text].present?
      log_info("Category #{category[:id]} has text: #{reflection[:text].truncate(50)}")
      reflection_text += "#{reflection[:text]}\n\n"
    elsif reflection && reflection.is_a?(Hash) && reflection['text'].present?
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–ª—é—á–∏
      log_info("Category #{category[:id]} has text (string key): #{reflection['text'].truncate(50)}")
      reflection_text += "#{reflection['text']}\n\n"
    else
      log_info("Category #{category[:id]} is empty or invalid: #{reflection.inspect}")
      reflection_text += "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ\n\n"
    end
  end
  
  # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  reflection_text += "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*\n"
  reflection_text += "‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ: #{progress[:completed_categories].size}/#{REFLECTION_CATEGORIES.size}\n"
  
  # –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –æ–±—ä–µ–º
  total_length = 0
  progress[:reflections].each do |key, reflection|
    if reflection.is_a?(Hash)
      total_length += reflection[:length].to_i if reflection[:length]
      total_length += reflection['length'].to_i if reflection['length']
    end
  end
  
  reflection_text += "‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º: #{total_length} —Å–∏–º–≤–æ–ª–æ–≤\n"
  reflection_text += "‚Ä¢ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: #{progress[:start_time].strftime('%H:%M')}\n"
  reflection_text += "‚Ä¢ –ü—Ä–æ–π–¥–µ–Ω–æ –¥–Ω–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: 21/28 (75%)\n\n"
  reflection_text += "üí° *–°–æ–≤–µ—Ç:* –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –Ω–µ–º—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞."
  
  log_info("Reflection text length: #{reflection_text.length}")
  log_info("Final reflection text preview: #{reflection_text.truncate(200)}")
  
  # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏
  send_long_message(reflection_text, parse_mode: 'Markdown')
end
      
      def show_personalized_recommendations
  progress = get_reflection_progress
  recommendations = []
  
  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
  progress[:reflections].each do |category_id, reflection|
    next unless reflection && reflection[:text]  # –ó–ê–©–ò–¢–ê –û–¢ NIL!
    
    text = reflection[:text].to_s.downcase  # –Ø–í–ù–û –ü–†–ï–û–ë–†–ê–ó–£–ï–ú –í –°–¢–†–û–ö–£
    
    case category_id.to_i
    when 0 # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
      if text.include?('—Ç—Ä–µ–≤–æ–∂') || text.include?('—Å—Ç—Ä–µ—Å—Å')
        recommendations << "üåä **–£–≥–ª—É–±–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å —Ç—Ä–µ–≤–æ–≥–æ–π:** –î–æ–±–∞–≤—å—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é 5-–º–∏–Ω—É—Ç–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É '5-4-3-2-1' –¥–ª—è –∑–∞–∑–µ–º–ª–µ–Ω–∏—è"
      end
    when 1 # –ù–∞–∏–±–æ–ª–µ–µ —Ü–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏
      if text.include?('–¥—ã—Ö–∞–Ω')
        recommendations << "üå¨Ô∏è **–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É:** –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ä–∏—Ç–º—ã –¥—ã—Ö–∞–Ω–∏—è (–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ, –¥–∏–∞—Ñ—Ä–∞–≥–º–∞–ª—å–Ω–æ–µ, 4-7-8)"
      end
      if text.include?('–º–µ–¥–∏—Ç–∞—Ü')
        recommendations << "üßò **–†–∞—Å—à–∏—Ä—å—Ç–µ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –≤—Ä–µ–º—è —Å 5 –¥–æ 10-15 –º–∏–Ω—É—Ç"
      end
    when 2 # –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã
      if text.include?('—Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω') || text.include?('–¥–æ–±—Ä–æ—Ç')
        recommendations << "üíù **–£–≥–ª—É–±–∏—Ç–µ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ:** –°–æ–∑–¥–∞–π—Ç–µ —Ä–∏—Ç—É–∞–ª –¥–æ–±—Ä–æ—Ç—ã –∫ —Å–µ–±–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º"
      end
    when 3 # –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–Ω—ã–µ –±–∞—Ä—å–µ—Ä—ã
      if text.include?('—Å—Ç—Ä–∞—Ö') || text.include?('–ø—Ä–µ–æ–¥–æ–ª–µ–Ω')
        recommendations << "ü¶∏ **–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏:** –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É –º–∞–ª–µ–Ω—å–∫–æ–º—É '—Å—Ç—Ä–∞—à–Ω–æ–º—É' –¥–µ–ª—É –≤ –Ω–µ–¥–µ–ª—é"
      end
    when 4 # –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
      # –î–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
      recommendations << "üìÖ **–°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫—É:** –°–æ–∑–¥–∞–π—Ç–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å 3-4 –∫–ª—é—á–µ–≤—ã–º–∏ —Ç–µ—Ö–Ω–∏–∫–∞–º–∏"
    end
  end
  
  # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
  if recommendations.empty?
    recommendations = [
      "üìÖ **–°–æ–∑–¥–∞–π—Ç–µ —É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª:** 10 –º–∏–Ω—É—Ç —É—Ç—Ä–æ–º –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–Ω—è (–¥—ã—Ö–∞–Ω–∏–µ + –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å + 1 —Ç–µ—Ö–Ω–∏–∫–∞)",
      "üìù **–í–µ–¥–∏—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:** –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ—Ö–Ω–∏–∫ –∏ –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–µ",
      "üéØ **–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ 2-3 —Ç–µ—Ö–Ω–∏–∫–∞—Ö:** –ì–ª—É–±–æ–∫–æ–µ –æ—Å–≤–æ–µ–Ω–∏–µ –ª—É—á—à–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–≥–æ –∑–Ω–∞–Ω–∏—è –º–Ω–æ–≥–∏—Ö",
      "ü§ù **–ù–∞–π–¥–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É:** –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫–æ–º—É-—Ç–æ –æ —Å–≤–æ–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤",
      "üîÑ **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫"
    ]
  end
  
  message = "üí° *–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*\n\n"
  message += recommendations.uniq.sample(4).map.with_index(1) { |rec, i| "#{i}. #{rec}" }.join("\n\n")
  message += "\n\n**–î–µ–π—Å—Ç–≤–∏–µ:** –í—ã–±–µ—Ä–∏—Ç–µ 1-2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ."
  
  send_message(text: message, parse_mode: 'Markdown')
end
      
      def show_progress_stats
        stats = calculate_three_weeks_stats
        
        message = <<~MARKDOWN
          üìà *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 21 –¥–µ–Ω—å* üìà

          **–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:**
          ‚úÖ **–î–Ω–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:** #{stats[:days_completed]} –∏–∑ 21
          üß† **–¢–µ—Ö–Ω–∏–∫ –ø–æ–ø—Ä–æ–±–æ–≤–∞–Ω–æ:** ~#{stats[:techniques_tried]} —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫
          üìù **–ó–∞–ø–∏—Å–µ–π —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:** #{stats[:reflection_entries]}
          üßò **–ú–µ–¥–∏—Ç–∞—Ü–∏–π:** #{stats[:meditation_sessions]} —Å–µ—Å—Å–∏–π
          üåü **–ü—Ä–∏—è—Ç–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:** #{stats[:pleasure_activities]}
          üíù **–ê–∫—Ç–æ–≤ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è:** #{stats[:self_compassion_practices]}
          ü§ù **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π:** #{stats[:reconnections]}

          **–ù–∞—É—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
          ‚Ä¢ üß† **–ù–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–≤–∞–ª–∞ –Ω–æ–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏
          ‚Ä¢ üîÑ **–ü—Ä–∏–≤—ã—á–∫–∞:** 21 –¥–µ–Ω—å ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Å—Ä–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤—ã –ø—Ä–∏–≤—ã—á–∫–∏
          ‚Ä¢ üìä **–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è:** –°–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–ø—ã—Ç–∞ –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å
          ‚Ä¢ üí™ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:** –í—ã —Å–æ–∑–¥–∞–ª–∏ –ø—Ä–æ—á–Ω—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

          **üéØ –í–∞—à —Å–ª–µ–¥—É—é—â–∏–π —Ä—É–±–µ–∂:** 28 –¥–Ω–µ–π ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏!
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
      end
      
      def show_techniques_review
        techniques = [
          "üå¨Ô∏è **–î—ã—Ö–∞–Ω–∏–µ 4-7-8:** –î–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —É—Å–ø–æ–∫–æ–µ–Ω–∏—è –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã",
          "üôè **–ü—Ä–∞–∫—Ç–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏:** –î–ª—è —Å–º–µ—â–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ",
          "üí≠ **–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞:** –î–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –º—ã—Å–ª–µ–π",
          "üåç **–¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1:** –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ",
          "üíù **–°–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ:** –î–ª—è –¥–æ–±—Ä–æ—Ç—ã –∫ —Å–µ–±–µ –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã",
          "ü§ù **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π:** –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
          "üéØ **–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏:** –î–ª—è –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤ —á–µ—Ä–µ–∑ –º–∏–∫—Ä–æ-–¥–µ–π—Å—Ç–≤–∏—è",
          "üßò **–û—Å–æ–∑–Ω–∞–Ω–Ω–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è:** –î–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –∏ —è—Å–Ω–æ—Å—Ç–∏"
        ]
        
        message = "üîÑ *–û–±–∑–æ—Ä —Å–∞–º—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –∑–∞ 3 –Ω–µ–¥–µ–ª–∏:*\n\n"
        message += techniques.sample(5).join("\n\n")
        message += "\n\n**–ó–∞–¥–∞–Ω–∏–µ:** –í—ã–±–µ—Ä–∏—Ç–µ 2-3 —Ç–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ."
        
        send_message(text: message, parse_mode: 'Markdown')
      end
      
      # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö =====
      
      def handle_button(callback_data)
  case callback_data
  when 'start_day_21_content', 'start_day_21_exercise'
    deliver_exercise
    
  when /^day_21_skip_(\d+)$/
    skip_category($1.to_i)
    
  when /^day_21_challenge_(\d+)$/
    handle_challenge_selection($1)
    
  when 'day_21_no_challenges'
    send_message(text: "üåü –û—Ç–ª–∏—á–Ω–æ! –†–µ—Ñ–ª–µ–∫—Å–∏—è –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ!")
    send_message(
      text: "–ó–∞–≤–µ—Ä—à–∞–µ–º –î–µ–Ω—å 21 –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º?",
      reply_markup: day_21_final_completion_markup
    )
    
  when 'day_21_show_full_reflection'
    show_full_reflection
    
  when 'day_21_show_recommendations'
    show_personalized_recommendations
    
  when 'day_21_complete_exercise'
    complete_exercise
    
  when 'day_21_show_stats'
    show_progress_stats
    
  when 'day_21_review_techniques'
    show_techniques_review
    
  when 'day_21_personal_plan'
    show_personal_plan
    
  when 'day_21_debug_data'  # –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
    debug_reflection_data
    
  when 'back_to_day_21_menu'
    show_three_weeks_menu
    
  else
    log_warn("Unknown button callback: #{callback_data}")
    send_message(text: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.")
  end
end
      
      # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
      def handle_text_input(input_text)
        current_state = @user.self_help_state
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∞–∫—Ç–∏–≤–Ω–∞
        if current_state&.start_with?("day_#{DAY_NUMBER}_waiting_reflection_")
          category_index = current_state.split('_').last.to_i
          return handle_reflection_text(input_text, category_index)
        end
        
        false
      end
      
      def resume_session
        current_state = @user.self_help_state
        
        case current_state
        when "day_#{DAY_NUMBER}_intro"
          deliver_intro
          
        when "day_#{DAY_NUMBER}_exercise_in_progress"
          progress = get_reflection_progress
          if progress[:current_category_index] > 0
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            show_next_reflection_category
          else
            # –ù–∞—á–∏–Ω–∞–µ–º —Å–Ω–∞—á–∞–ª–∞
            deliver_exercise
          end
          
        when /^day_#{DAY_NUMBER}_waiting_reflection_/
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
          progress = get_reflection_progress
          show_next_reflection_category
          
        when "day_#{DAY_NUMBER}_completed"
          show_three_weeks_menu
          
        else
          deliver_intro
        end
      end
      
      private
      
      # ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ =====
      
      # –ú–µ—Ç–æ–¥—ã —Ä–∞–∑–º–µ—Ç–∫–∏
      def day_21_content_markup
        {
          inline_keyboard: [
            [
              { text: "üìä –ù–∞—á–∞—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é 3 –Ω–µ–¥–µ–ª—å", callback_data: 'start_day_21_content' }
            ],
            [
              { text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data: 'back_to_main_menu' }
            ]
          ]
        }.to_json
      end
      
      def day_21_category_options_markup(category_index)
        {
          inline_keyboard: [
            [
              { text: "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é", callback_data: "day_21_skip_#{category_index}" }
            ]
          ]
        }.to_json
      end
      
      def day_21_challenges_markup
        {
          inline_keyboard: [
            [
              { text: "üß† –°–ª–æ–∂–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å –≤—Å–µ", callback_data: 'day_21_challenge_0' }
            ],
            [
              { text: "üòî –ú–æ–≥ –¥–æ—Å—Ç–∏—á—å –±–æ–ª—å—à–µ–≥–æ", callback_data: 'day_21_challenge_1' }
            ],
            [
              { text: "ü§î –ù–µ —É–≤–µ—Ä–µ–Ω –≤ –æ—Ü–µ–Ω–∫–µ", callback_data: 'day_21_challenge_2' }
            ],
            [
              { text: "üò∞ –ë–µ—Å–ø–æ–∫–æ—é—Å—å –æ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏", callback_data: 'day_21_challenge_3' }
            ],
            [
              { text: "üåÄ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", callback_data: 'day_21_challenge_4' }
            ],
            [
              { text: "‚úÖ –ù–∏–∫–∞–∫–∏—Ö —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π", callback_data: 'day_21_no_challenges' }
            ]
          ]
        }.to_json
      end
      
      def day_21_final_completion_markup
        {
          inline_keyboard: [
            [
              { text: "üí° –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", callback_data: 'day_21_show_recommendations' },
              { text: "üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é", callback_data: 'day_21_show_full_reflection' }
            ],
            [
              { text: "üéâ –ó–∞–≤–µ—Ä—à–∏—Ç—å 3 –Ω–µ–¥–µ–ª–∏!", callback_data: 'day_21_complete_exercise' }
            ]
          ]
        }.to_json
      end
      
      def day_21_menu_markup
  {
    inline_keyboard: [
      [
        { text: "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data: 'day_21_show_stats' },
        { text: "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", callback_data: 'day_21_show_recommendations' }
      ],
      [
        { text: "üìñ –ü–æ–ª–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è", callback_data: 'day_21_show_full_reflection' },
        { text: "üîÑ –û–±–∑–æ—Ä —Ç–µ—Ö–Ω–∏–∫", callback_data: 'day_21_review_techniques' }
      ],
      [
        { text: "üó∫Ô∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω", callback_data: 'day_21_personal_plan' }
      ],
      [
        { text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data: 'back_to_main_menu' },
        { text: "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å", callback_data: 'start_day_22_from_proposal' }
      ]
    ]
  }.to_json
end
      
      # –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
      def get_reflection_progress
  log_info("Getting reflection progress from day data")
  
  progress_data = get_day_data('reflection_progress') || {}
  
  log_info("Raw progress data type: #{progress_data.class}")
  log_info("Raw progress data keys: #{progress_data.keys}")
  
  # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º reflections
  reflections = {}
  raw_reflections = progress_data['reflections'] || progress_data[:reflections] || {}
  
  log_info("Raw reflections type: #{raw_reflections.class}")
  log_info("Raw reflections keys: #{raw_reflections.keys}")
  
  raw_reflections.each do |key, value|
    log_info("Processing reflection #{key}: #{value.class}")
    
    if value.is_a?(Hash)
      # –°–æ–∑–¥–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ö—ç—à —Å –æ–±–æ–∏–º–∏ —Ç–∏–ø–∞–º–∏ –∫–ª—é—á–µ–π
      normalized = {}
      
      # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –∫–ª—é—á–∏ –∫–∞–∫ —Å–∏–º–≤–æ–ª—å–Ω—ã–µ
      value.each do |k, v|
        normalized[k.to_sym] = v if k
      end
      
      # –¢–∞–∫–∂–µ –∫–æ–ø–∏—Ä—É–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      value.each do |k, v|
        normalized[k.to_s] = v if k
      end
      
      reflections[key.to_s] = normalized
    else
      reflections[key.to_s] = value
    end
  end
  
  result = {
    current_category_index: progress_data['current_category_index']&.to_i || progress_data[:current_category_index]&.to_i || 0,
    completed_categories: Array(progress_data['completed_categories'] || progress_data[:completed_categories]).map(&:to_i),
    reflections: reflections,
    start_time: begin
      time_str = progress_data['start_time'] || progress_data[:start_time]
      Time.parse(time_str) if time_str
    rescue => e
      log_error("Failed to parse start_time: #{time_str}", e)
      Time.current
    end
  }
  
  log_info("Processed reflection progress:")
  log_info("‚Ä¢ Categories: #{result[:completed_categories]}")
  log_info("‚Ä¢ Reflections count: #{result[:reflections].size}")
  result[:reflections].each do |key, value|
    log_info("‚Ä¢ Reflection #{key}: #{value.inspect}")
  end
  
  result
end
      
      def save_reflection_progress(progress)
  log_info("Saving reflection progress: #{progress.inspect}")
  
  store_day_data('reflection_progress', {
    current_category_index: progress[:current_category_index],
    completed_categories: progress[:completed_categories],
    reflections: progress[:reflections],
    start_time: progress[:start_time].iso8601
  })
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å
  saved_progress = get_day_data('reflection_progress')
  log_info("Verified saved progress: #{saved_progress.inspect}")
end
      
      def show_reflection_progress(current_index)
        total = REFLECTION_CATEGORIES.size
        progress_bar = "üü©" * (current_index) + "‚¨ú" * (total - current_index)
        
        send_message(
          text: "üìä *–ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:* #{progress_bar} (#{current_index + 1}/#{total})",
          parse_mode: 'Markdown'
        )
      end
      
      def category_prompt_with_progress(category, current_index)
        <<~MARKDOWN
          #{category[:emoji]} *–ö–∞—Ç–µ–≥–æ—Ä–∏—è #{current_index + 1}/#{REFLECTION_CATEGORIES.size}: #{category[:name]}*
          
          #{category[:prompt]}
          
          *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:* –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
          *–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –∏ –ø–µ—Ä–µ–π–¥–µ—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.*
          
          üí° *–°–æ–≤–µ—Ç:* –û—Ç–≤–µ—á–∞–π—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ—Å—Ç–Ω–æ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ ‚Äî —ç—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        MARKDOWN
      end
      
      def category_emoji(category_index)
        REFLECTION_CATEGORIES[category_index][:emoji] rescue "üìù"
      end
      
      def completion_summary_message(completed_count)
        total = REFLECTION_CATEGORIES.size
        
        if completed_count == total
          "üéâ *–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ #{total} –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ 3 –Ω–µ–¥–µ–ª—å!*"
        elsif completed_count >= total / 2
          "‚úÖ *–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ #{completed_count} –∏–∑ #{total} –∫–∞—Ç–µ–≥–æ—Ä–∏–π.*"
        elsif completed_count > 0
          "üìù *–í—ã –Ω–∞—á–∞–ª–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é, –∑–∞–≤–µ—Ä—à–∏–≤ #{completed_count} –∫–∞—Ç–µ–≥–æ—Ä–∏–π.*"
        else
          "‚è≠Ô∏è *–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –†–µ—Ñ–ª–µ–∫—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.*"
        end
      end
      
      def save_three_weeks_reflection_entry
        progress = get_reflection_progress
        return if progress[:reflections].empty?
        
        # –≠—Ç–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ self_help_program_data
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ complete_exercise —á–µ—Ä–µ–∑ save_final_reflection_entry
        log_info("Saved intermediate reflection with #{progress[:completed_categories].size} categories")
      end
      
      def save_final_reflection_entry
  progress = get_reflection_progress
  
  # –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å
  log_info("Saving final reflection with progress: #{progress.inspect}")
  
  begin
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    full_text = ""
    
    REFLECTION_CATEGORIES.each do |category|
      reflection = progress[:reflections][category[:id].to_s]
      
      if reflection && reflection[:text].present?
        full_text += "#{category[:emoji]} *#{category[:name]}:*\n"
        full_text += "#{reflection[:text]}\n\n"
      else
        full_text += "#{category[:emoji]} *#{category[:name]}:*\n"
        full_text += "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ\n\n"
      end
    end
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    final_text = <<~TEXT
      üìñ *–†–µ—Ñ–ª–µ–∫—Å–∏—è 21 –¥–Ω—è –ø—Ä–æ–≥—Ä–∞–º–º—ã* üìÖ #{Date.current.strftime('%d.%m.%Y')}
      ‚è∞ –í—Ä–µ–º—è: #{progress[:start_time].strftime('%H:%M')}
      
      #{full_text}
      
      üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*
      ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ: #{progress[:completed_categories].size}/#{REFLECTION_CATEGORIES.size}
      ‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º: #{progress[:reflections].values.sum { |r| r[:length].to_i }} —Å–∏–º–≤–æ–ª–æ–≤
      ‚Ä¢ –ü—Ä–æ–π–¥–µ–Ω–æ –¥–Ω–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: 21/28 (75%)
      ‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏: #{(Time.current - progress[:start_time]).to_i / 60} –º–∏–Ω—É—Ç
      
      üí° *–≠—Ç–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–º –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–º –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.*
    TEXT
    
    log_info("Attempting to save reflection entry. Text length: #{final_text.length}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ ReflectionEntry
    reflection_entry = ReflectionEntry.new(
      user: @user,
      entry_date: Date.current,
      entry_text: final_text,
      reflection_type: 'three_weeks'
    )
    
    # –ü—Ä–æ–±—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    if reflection_entry.save
      log_info("Successfully saved final three weeks reflection with ID: #{reflection_entry.id}")
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
      saved_entry = ReflectionEntry.find_by(id: reflection_entry.id)
      if saved_entry
        log_info("Verified: Reflection entry saved successfully. ID: #{saved_entry.id}, Date: #{saved_entry.entry_date}")
      else
        log_warn("Reflection entry not found after save!")
      end
    else
      log_error("Failed to save reflection entry. Errors: #{reflection_entry.errors.full_messages}")
    end
    
  rescue => e
    log_error("Failed to save final three weeks reflection", e)
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    send_message(
      text: "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—à—É —Ä–µ—Ñ–ª–µ–∫—Å–∏—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:",
      parse_mode: 'Markdown'
    )
    send_message(text: full_text || "–†–µ—Ñ–ª–µ–∫—Å–∏—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞")
  end
end
      
      def three_weeks_statistics_message
        completed_days = @user.completed_days || []
        three_weeks_days = completed_days.select { |day| day <= 21 }
        
        <<~MARKDOWN
          üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 3 –Ω–µ–¥–µ–ª–∏:*
          
          ‚Ä¢ ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –¥–Ω–µ–π: #{three_weeks_days.size}/21
          ‚Ä¢ üìà –ü—Ä–æ–≥—Ä–µ—Å—Å 3 –Ω–µ–¥–µ–ª—å: #{(three_weeks_days.size.to_f / 21 * 100).round}%
          ‚Ä¢ üèÜ –°–µ—Ä–∏—è –¥–Ω–µ–π: #{@user.current_streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
          ‚Ä¢ üí´ –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: #{@user.progress_percentage}%
          ‚Ä¢ üéØ –ü—Ä–æ–π–¥–µ–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã: 75%
          
          *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:* –í—ã –ø—Ä–æ—à–ª–∏ 75% –ø—É—Ç–∏ ‚Äî —ç—Ç–æ –≤–ø–µ—á–∞—Ç–ª—è—é—â–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!
        MARKDOWN
      end
      
      def calculate_three_weeks_stats
        {
          days_completed: (@user.completed_days || []).count { |day| day <= 21 },
          techniques_tried: 21, # –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ 3 –Ω–µ–¥–µ–ª–∏
          reflection_entries: @user.reflection_entries.where("entry_date >= ?", 3.weeks.ago).count,
          meditation_sessions: calculate_meditation_sessions,
          pleasure_activities: calculate_pleasure_activities,
          self_compassion_practices: calculate_self_compassion_practices,
          reconnections: calculate_reconnections
        }
      end
      
      def calculate_meditation_sessions
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–π –∏–∑ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏
        # –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
        rand(5..15)
      end
      
      def calculate_pleasure_activities
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ø—Ä–∏—è—Ç–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        rand(3..10)
      end
      
      def calculate_self_compassion_practices
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è
        rand(2..8)
      end
      
      def calculate_reconnections
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π
        rand(1..5)
      end
      
      def show_personal_plan
        progress = get_reflection_progress
        integration_text = progress[:reflections]["4"]&.dig(:text) || "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∏–∑ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞"
        
        message = <<~MARKDOWN
          üó∫Ô∏è *–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 30 –¥–Ω–µ–π* üó∫Ô∏è

          **–û—Å–Ω–æ–≤–∞ –ø–ª–∞–Ω–∞:** 
          #{integration_text.truncate(300)}

          **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

          üìÖ **–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (10-15 –º–∏–Ω—É—Ç):**
          1. –£—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–¥—ã—Ö–∞–Ω–∏–µ + –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –¥–Ω—è)
          2. 1 –∫–ª—é—á–µ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞
          3. –í–µ—á–µ—Ä–Ω—è—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏–ª–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è

          üóìÔ∏è **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã (30-45 –º–∏–Ω—É—Ç):**
          1. –í–æ—Å–∫—Ä–µ—Å–Ω—ã–π –æ–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏
          2. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–π "–º–∞–ª–µ–Ω—å–∫–æ–π –ø–æ–±–µ–¥—ã" –Ω–∞ –Ω–µ–¥–µ–ª—é
          3. –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏

          üìä **–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ç–æ—á–∫–∏ –æ—Ç—Å—á–µ—Ç–∞ (1-2 —á–∞—Å–∞):**
          1. –ü–æ–ª–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
          2. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–Ω–∞ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          3. –ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Å–µ–±—è –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å

          **–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:**
          ‚Ä¢ üì± –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫
          ‚Ä¢ üìù –í–µ–¥–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–µ–Ω—å)
          ‚Ä¢ ü§ù –ù–∞–π–¥–∏—Ç–µ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞ –¥–ª—è –≤–∑–∞–∏–º–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
          ‚Ä¢ üéØ –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ "—è–∫–æ—Ä—è" ‚Äî –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ

          **–°–æ–≤–µ—Ç:** –°–æ–∑–¥–∞–π—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–ª–∞–Ω–µ (—Å—Ç–∏–∫–µ—Ä –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ, –∑–∞—Å—Ç–∞–≤–∫–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ).
        MARKDOWN
        
        send_message(text: message, parse_mode: 'Markdown')
      end
      
      def propose_next_day_with_restriction
        next_day = 22
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        can_start_result = @user.can_start_day?(next_day)
        
        if can_start_result == true
          message = <<~MARKDOWN
            üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å 22**
            
            ‚úÖ *–î–æ—Å—Ç—É–ø–µ–Ω —Å–µ–π—á–∞—Å!*
            
            **–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –Ω–µ–¥–µ–ª–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**
            ‚Ä¢ üß† –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ—Å–≤–æ–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –≤ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É
            ‚Ä¢ üí™ –†–∞–±–æ—Ç–∞ —Å –≥–ª—É–±–∏–Ω–Ω—ã–º–∏ —É–±–µ–∂–¥–µ–Ω–∏—è–º–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏
            ‚Ä¢ üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–∞–º–æ–ø–æ–º–æ—â–∏
            ‚Ä¢ üåü –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–º—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é –ø—Ä–∞–∫—Ç–∏–∫–∏
            
            **–≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è –ø—Ä–æ–≥—Ä–∞–º–º—ã** ‚Äî –≤—Ä–µ–º—è –∑–∞–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—É—é —Å–∏—Å—Ç–µ–º—É.
            
            –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –Ω–µ–¥–µ–ª—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
          MARKDOWN
          
          button_text = "üöÄ –ù–∞—á–∞—Ç—å –î–µ–Ω—å 22"
          callback_data = "start_day_#{next_day}_from_proposal"
        else
          error_message = can_start_result.is_a?(Array) ? can_start_result.join("\n") : can_start_result
          
          message = <<~MARKDOWN
            üéØ **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –î–µ–Ω—å 22 (–§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è)**
            
            ‚è±Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:* #{error_message}
            
            **–ü–æ–∫–∞ –∂–¥–µ—Ç–µ, –º–æ–∂–µ—Ç–µ:**
            ‚Ä¢ üìñ –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å —Å–≤–æ—é —Ä–µ—Ñ–ª–µ–∫—Å–∏—é 3 –Ω–µ–¥–µ–ª—å
            ‚Ä¢ üß† –ü—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Å–∞–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –¥–ª—è –≤–∞—Å —Ç–µ—Ö–Ω–∏–∫–∏
            ‚Ä¢ üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            ‚Ä¢ üéØ –ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            ‚Ä¢ üåü –û—Ç–ø—Ä–∞–∑–¥–Ω–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 75% –ø—É—Ç–∏!
            
            *–§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞, –∫–æ–≥–¥–∞ –ø—Ä–æ–π–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏.*
          MARKDOWN
          
          button_text = "‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –î–Ω—è 22"
          callback_data = "start_day_#{next_day}_from_proposal"
        end
        
        send_message(text: message, parse_mode: 'Markdown')
        
        send_message(
          text: "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:",
          reply_markup: {
            inline_keyboard: [
              [
                { 
                  text: button_text, 
                  callback_data: callback_data
                }
              ]
            ]
          }.to_json
        )
      end
      
      # –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä–∞–∑–±–∏–≤–∫–æ–π
      def send_long_message(text, options = {})
        max_length = 4096 # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
        
        if text.length <= max_length
          send_message(text: text, **options)
        else
          # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
          parts = []
          current_part = ""
          
          text.split("\n").each do |line|
            if (current_part + line + "\n").length > max_length
              parts << current_part
              current_part = line + "\n"
            else
              current_part += line + "\n"
            end
          end
          
          parts << current_part unless current_part.empty?
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
          parts.each_with_index do |part, index|
            send_message(text: part, **options)
            sleep(0.5) if index < parts.size - 1
          end
        end
      end
      
      def log_info(message)
        Rails.logger.info "[Day21Service] #{message} - User: #{@user.telegram_id}"
      end
      
      def log_error(message, error = nil)
        Rails.logger.error "[Day21Service] #{message} - User: #{@user.telegram_id}"
        Rails.logger.error error.message if error
        Rails.logger.error error.backtrace.first(5).join("\n") if error&.backtrace
      end
      
      def log_warn(message)
        Rails.logger.warn "[Day21Service] #{message} - User: #{@user.telegram_id}"
      end
    end
  end
end